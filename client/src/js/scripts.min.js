/**
 * @ngdoc overview
 * @name miller
 * @description
 * # miller
 *
 * Main module of the application.
 */
angular
  .module('miller', [
    'ui.router',
    // 'ngAnimate',
    'ngResource',
    'ngSanitize',
    'ngCookies',
    'ngTagsInput',
    'mgcrea.ngStrap',
    'monospaced.elastic',
    'LocalStorageModule',
    'pascalprecht.translate',
    // 'angular-embedly',
    'angular-embed',
    'angular-embed.handlers'
  ])
  .constant('LOCALES', {
    'locales': {
      'en_US': 'English'
    },
    'preferredLocale': 'en_US'
  })
  .constant('EVENTS', {
    'SAVE': 'save',
    'MESSAGE': 'message',
    'BAD_REQUEST':'bad_request'
  })
  /*
    multiple input tags configuration
  */
  .config(function(tagsInputConfigProvider, RUNTIME){
    tagsInputConfigProvider
    .setDefaults('tagsInput', {
      replaceSpacesWithDashes:false,
      template: RUNTIME.static + 'templates/partials/tag.input.html' 
    })
    .setDefaults('autoComplete', {
      loadOnDownArrow: true
    });
  })
  /*
    Angular-translate configs
    Cfr. https://scotch.io/tutorials/internationalization-of-angularjs-applications
  */
  .config(function ($translateProvider, RUNTIME) {
    // $translateProvider.useMissingTranslationHandlerLog();
    $translateProvider.useSanitizeValueStrategy('sanitize');
    $translateProvider.useStaticFilesLoader({
        prefix: RUNTIME.static + 'locale/locale-',// path to translations files
        suffix: '.json'// suffix, currently- extension of the translations
    });
    $translateProvider.preferredLanguage('en_US');// is applied on first load
    
  })
  .config(function (localStorageServiceProvider) {
    localStorageServiceProvider
      .setPrefix('miller');
  })
  .config(function($resourceProvider) {
    $resourceProvider.defaults.stripTrailingSlashes = false;
  })
  .config(function($httpProvider) {
    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';

    // intercept BAD request errors
    $httpProvider.interceptors.push(function($q, $rootScope, EVENTS) {
      return {
        responseError: function(rejection) {
          // emit on 400 error (bad request, mostly form errors)
          if(rejection.status == 400){
            $rootScope.$emit(EVENTS.BAD_REQUEST, rejection);
          }
          return $q.reject(rejection);
        }
      };
    });
  })
  .config(function($locationProvider) {
    // $locationProvider.html5Mode(true);
  })
  .config(function(embedlyServiceProvider, RUNTIME) {
    if(RUNTIME.oembeds.EMBEDLY_API_KEY)
      embedlyServiceProvider.setKey(RUNTIME.oembeds.EMBEDLY_API_KEY);
  })
  .config(function ($stateProvider, $urlRouterProvider, RUNTIME) {
    $urlRouterProvider
      .otherwise("/");
    $stateProvider
      .state('index', {
        url: '/',
        reloadOnSearch : false,
        controller: 'IndexCtrl',
        templateUrl: RUNTIME.static + 'templates/index.html',
        resolve:{
          writings: function(StoryFactory){
            return StoryFactory.get({
              filters: JSON.stringify({
                tags__slug: 'highlights'
              })
            }).$promise;
          },
          news: function(StoryFactory){
            return StoryFactory.get({
              filters: JSON.stringify({
                tags__category: 'blog'
              })
            }).$promise;
          } 
        }
      })
      .state('login', {
        url: '/login',
        reloadOnSearch : false,
        controller: 'LoginCtrl',
        templateUrl: RUNTIME.static + 'templates/login.html'
      })
      .state('draft', {
        url: '/create',
        reloadOnSearch : false,
        controller: 'DraftCtrl',
        templateUrl: RUNTIME.static + 'templates/draft.html'
      })
      .state('writing', {
        url: '/writing/:storyId',
        reloadOnSearch : false,
        controller: 'WritingCtrl',
        templateUrl: RUNTIME.static + 'templates/draft.html',
        resolve: {
          story: function(StoryFactory, $stateParams) {
            return StoryFactory.get({id: $stateParams.storyId}).$promise;
          },
        }
      });

    /*

      My stories, settings etc. (even drafts whenever available)
      ---
    
    */
    $stateProvider
      .state('me', {
        abstract: true,
        reloadOnSearch : false,
        url: '/me',
        controller: 'AuthorCtrl',
        templateUrl: RUNTIME.static + 'templates/author.html',
        resolve: {
          profile: function(ProfileFactory, RUNTIME){
            return ProfileFactory.get({
              username: RUNTIME.user.username
            }).$promise;
          }
        }
      })
      .state('me.publications', {
        url: '/publications',
        abstract:true,
        reloadOnSearch : false,
        controller: function($scope){
          $scope.urls = RUNTIME.stories.writing;
        },
        templateUrl: RUNTIME.static + 'templates/author.publications.html',
      })
      .state('me.publications.drafts', {
        url: '/drafts',
        reloadOnSearch : false,
        controller: 'ItemsCtrl',
        templateUrl: RUNTIME.static + 'templates/blog.news.html',
        resolve: {
          items: function(StoryFactory, $stateParams) {
            return StoryFactory.get({
              filters: JSON.stringify({
                status: 'draft',
                owner__username: RUNTIME.user.username,
                // authors__username__in: [RUNTIME.user.username]
              })
            }).$promise;
          },

          model: function() {
            return 'story';
          },
          factory: function(StoryFactory) {
            return StoryFactory;
          }
        }
      });

      _.each(RUNTIME.stories.writing, function(d){
        $stateProvider
          .state('me.publications.' + d.name, {
            url: d.url,
            controller: 'ItemsCtrl',
            templateUrl: RUNTIME.static + 'templates/blog.news.html',
              resolve: {
              items: function(StoryFactory, $stateParams) {
                return StoryFactory.get({
                  filters: d.slug? JSON.stringify({
                    tags__category: 'writing',
                    tags__slug: d.slug,
                    owner__username: RUNTIME.user.username
                  }): JSON.stringify({
                    tags__category: 'writing',
                    owner__username: RUNTIME.user.username
                  })
                }).$promise;
              },

              model: function() {
                return 'story';
              },
              factory: function(StoryFactory) {
                return StoryFactory;
              }
            }
          });
      });

    /*
      Other user stories
      ---
    */
    $stateProvider
      .state('author', {
        abstract: true,
        reloadOnSearch : false,
        url: '/author/{username:[0-9a-zA-Z\\.-_]+}',
        controller: 'AuthorCtrl',
        templateUrl: RUNTIME.static + 'templates/author.html',
        resolve: {
          profile: function(ProfileFactory, $stateParams){
            return ProfileFactory.get({
              username: $stateParams.username
            }).$promise;
          }
        }
      })
      .state('author.publications', {
        url: '',
        reloadOnSearch : false,
        controller: function($scope, profile){
          $scope.urls = RUNTIME.stories.writing;
        },
        resolve:{ // latest stories
          stories: function(profile){
            return {'value': profile};
          }
        },
        templateUrl: RUNTIME.static + 'templates/author.publications.html',
      });

      

    $stateProvider
     .state('blog', {
        url: '/blog',
        reloadOnSearch : false,
        abstract:true,
        controller: 'BlogCtrl',
        templateUrl: RUNTIME.static + 'templates/blog.html',
        
      })

      .state('blog.everything', {
        url: '',
        reloadOnSearch : false,
        controller: 'ItemsCtrl',
        templateUrl: RUNTIME.static + 'templates/blog.news.html',
        resolve: {
          items: function(StoryFactory, $stateParams) {
            return StoryFactory.get({
              filters: JSON.stringify({
                tags__category: 'blog'
              })
            }).$promise;
          },
          model: function() {
            return 'story';
          },
          factory: function(StoryFactory) {
            return StoryFactory;
          }
        }
      })
      .state('blog.events', {
        url: '/events',
        reloadOnSearch : false,
        controller: 'ItemsCtrl',
        templateUrl: RUNTIME.static + 'templates/blog.news.html',
        resolve: {
          items: function(StoryFactory, $stateParams) {
            return StoryFactory.get({
              filters: JSON.stringify({
                tags__category: 'blog',
                tags__slug: 'event'
              })
            }).$promise;
          },
          model: function() {
            return 'story';
          },
          factory: function(StoryFactory) {
            return StoryFactory;
          }
        }
      })
      
      // .state('events', {
      //   url: '/events',
      //   abstract:true,
      //   reloadOnSearch : false,
      //   // controller: function(){},
      //   templateUrl: RUNTIME.static + 'templates/events.html',
        
      // })

      // .state('events.everything', {
      //   url: '',
      //   controller: 'ItemsCtrl',
      //   reloadOnSearch : false,
      //   templateUrl: RUNTIME.static + 'templates/blog.news.html',
      //   resolve: {
      //     items: function(StoryFactory, $stateParams) {
      //       return StoryFactory.get({
      //         filters: JSON.stringify({
      //           tags__category: 'event'
      //         })
      //       }).$promise;
      //     },
      //     model: function() {
      //       return 'story';
      //     },
      //     factory: function(StoryFactory) {
      //       return StoryFactory;
      //     }
      //   }
      // })

      /*
        Kind of story:writings publications
      */
      .state('publications', {
        url: '/publications',
        abstract: true,
        reloadOnSearch : false,
        controller: function($scope){
          $scope.urls = RUNTIME.stories.writing;
        },
        templateUrl: RUNTIME.static + 'templates/publications.html',
        
      });

      _.each(RUNTIME.stories.writing, function(d){
        $stateProvider
          .state('publications.' + d.name, {
            url: d.url,
            controller: 'ItemsCtrl',
            templateUrl: RUNTIME.static + 'templates/blog.news.html',
              resolve: {
              items: function(StoryFactory, $stateParams) {
                return StoryFactory.get({
                  filters: d.slug? JSON.stringify({
                    tags__category: 'writing',
                    tags__slug: d.slug
                  }): JSON.stringify({
                    tags__category: 'writing'
                  })
                }).$promise;
              },

              model: function() {
                return 'story';
              },
              factory: function(StoryFactory) {
                return StoryFactory;
              }
            }
          });
      });
      
      


    $stateProvider
      .state('post', {
        url: '/story/:postId',
        controller: 'PostCtrl',
        reloadOnSearch : false,
        templateUrl: RUNTIME.static + 'templates/post.html',
        resolve: {
          post: function(StoryFactory, $stateParams) {
            return StoryFactory.get({id: $stateParams.postId}).$promise;
          },
        }
      })


      /*
        All the rest are static pages and will download the md files directly
      */
      .state('page', {
        url: '/:name',
        controller: 'PageCtrl',
        templateUrl: RUNTIME.static + 'templates/md.html',
        resolve: {
          page: function(PageFactory, $stateParams) {
            return PageFactory.get({name: $stateParams.name});
          },
        }
      });
  });

angular.module('miller')
  .filter('prefixTemplate', function (RUNTIME) {
    return function (input) {
      return RUNTIME.static + input;
    };
  })
  .filter('bibtex', function(){
    return function (text) {
      return text? text.replace(/[\{\}]/g,''): ''
    }
  })
  /*
    Translit non ascii chars and uniform punctuations signs
  */
  .filter('slugify', function(){
    return function (text) {
      var strip  = /[^\w\s-]/g,
          hyphen = /[-\s]+/g,
          slug   = text.toLowerCase();

      var map = {
        from: 'àáäãâèéëêìíïîòóöôõùúüûñç·/_,:;', 
        to  : 'aaaaaeeeeiiiiooooouuuunc------'
      };
 
      for (var i=0, j=map.from.length; i<j; i++) {
        slug = slug.replace(new RegExp(map.from.charAt(i), 'g'), map.to.charAt(i));
      }
      return slug.replace(strip, '').trim().replace(hyphen, '-');
    };
  });
/**
 * @ngdoc service
 * @name miller.services
 * @description
 * # core
 * Resource REST API service Factory.
 */
angular.module('miller')
  /*
    Get a list of stories
  */
  .factory('StoryFactory', function ($resource) {
    return $resource('/api/story/:id/', {},{
      update: {
        method:'PUT'
      },
      patch: {
        method:'PATCH'
      }
    });
  })
  .factory('StoryTagsFactory', function ($resource) {
    return $resource('/api/story/:id/tags/', {},{
      update: {
        method:'PUT'
      }
    });
  })
  .factory('StoryDocumentsFactory', function ($resource) {
    return $resource('/api/story/:id/documents/', {},{
      update: {
        method:'PUT'
      }
    });
  })
  .factory('ProfileFactory', function ($resource) {
    return $resource('/api/profile/:username/', {},{
      update: {
        method:'PUT'
      },
      patch: {
        method:'PATCH'
      }
    });
  })
  /*
    get a list of ralreeady saved document accessible by the user
  */
  // http://localhost:8888/api/document/
  .factory('DocumentFactory', function ($resource) {
    return $resource('/api/document/:id/', {},{
      update: {
        method:'PUT'
      }
    });
  })
  .factory('CaptionFactory', function ($resource) {
    return $resource('/api/caption/:id/', {},{
      update: {
        method:'PUT'
      },
      patch: {
        method:'PATCH'
      }
    });
  })
  /*
    list tags
  */
  .factory('TagFactory', function ($resource) {
    return $resource('/api/tag/:id/', {},{
      update: {
        method:'PUT'
      }
    });
  })
  /*
    get static pages
  */
  .factory('PageFactory', function ($http, RUNTIME) {
    return {
      get: function(params) {
        return $http.get(RUNTIME.static + 'pages/' + params.name + '.md');
      }
    };
  })

  /*
    Apply MLA or other citation style
  */
  .service('bibtexService', function($filter) {
    return function(json){

    }
  })
  /*
    Apply marked service for custom markdown ;)
  */
  .service('markedService', function($filter) {
    return function(value, language){
      var renderer = new marked.Renderer(),
          linkIndex = 0,
          result = '',
          ToC = [],
          docs = [];

      // split value according to language(reduce pairs)
      if(language){
        var candidate = _(value.split(/<!--\s*(lang:[a-zA-Z_]{2,5})\s*-->/))
          .compact()
          .chunk(2)
          .fromPairs()
          .value();
        // console.log(language, candidate)
        if(candidate['lang:'+language]) {
          value = candidate['lang:'+language];
        }
        //value = value.split();
      }
      // collect h1,h2, hn and get the table of contents ToC
      renderer.heading = function(text, level){
        var h = {
          text: text,
          level: level,
          slug: $filter('slugify')(text)
        };

        ToC.push(h);

        return '<h' + level + '><div class="anchor-sign" ng-click="hash(\''+ h.slug +'\')"><span class="icon-link"></span></div><a name="' + h.slug +'" class="anchor" href="#' + h.slug +'"><span class="header-link"></span></a>' + 
          text + '</h' + level + '>';
      };

      // collect miller document
      renderer.link = function(url, boh, text) {
        if(url.trim().indexOf('doc/') === 0){
          var documents = url.trim().replace('doc/','').split(',');
          for(var i in documents){
            docs.push({
              _index: 'link-' + (linkIndex++), // internal id
              citation: text,
              slug: documents[i]
            });
          }
          return '<a name="' + documents[0] +'" ng-click="hash(\''+url+'\')"><span class="anchor-wrapper"></span>'+text+'</a>';
        } else if (url.trim().indexOf('voc/') === 0){
          var terms = url.trim().replace('voc/','').split(',');
          for(var i in terms){
            docs.push({
              _index: 'link-' + (linkIndex++), // internal id
              citation: text,
              slug: terms[i],
              type: 'glossary'
            });
          }
          return '<a class="glossary" name="' + terms[0] +'" ng-click="hash(\''+url+'\')"><span class="anchor-wrapper"></span>'+text+' <span class="icon icon-arrow-right-circle"></span></a>';
        
        }
        return '<a href='+url+'>'+text+'</a>';
      };

      renderer.image = function(src, title, alt){
        if((alt||'').indexOf('profile/') === 0){
          return '<div class="profile-thumb" style="background-image:url('+src+')"></div>';
        }
        return '<img src="'+ src+ '" title="'+title+'" alt="'+alt+'"/>';
      };

      // get the new documents and save them in background if needed.
      result = marked(value, {
        renderer: renderer
      });

      return {
        html: result,
        ToC: ToC,
        docs: docs
      };
    }; 
  });
angular.module("miller").run(["$templateCache", function($templateCache) {$templateCache.put("/static/templates/author.html","<h2>{{profile.user.first_name}} {{profile.user.last_name}} <span ng-if=\'isMe\'>(you)</span></h2>\n<div class=\'type\'>author</div>\n<div markdown=\'profile.bio|| \"...\"\'></div>\n<div ui-view></div>");
$templateCache.put("/static/templates/author.publications.html","<h3 ng-if=\'isMe\' translate=\"me.publications\"></h3>\n<h3 ng-if=\'!isMe\' translate=\"latest publications\"></h3>\n<!-- Nav tabs -->\n  <ul class=\'nav nav-tabs\'>\n    <li ng-repeat=\'link in urls\' role=\"presentation\" ui-sref-active=\"active\">\n      <a href ui-sref=\'me.publications.{{link.name}}\' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate=\"{{link.name}}\"></a>\n    </li>\n    \n    <li ng-if=\'isMe\' ui-sref-active=\"active\">\n      <a href ui-sref=\'me.publications.drafts\' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate=\"drafts\"></a>\n    </li>\n  </ul>\n  \n\n<div ui-view></div>");
$templateCache.put("/static/templates/blog.html","<h2>news</h2>\n<!-- Nav tabs -->\n<ul class=\"nav nav-tabs\" role=\"tablist\">\n  <li role=\"presentation\" ui-sref-active=\"active\"><a href ui-sref=\'blog.everything\' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\">everything</a></li>\n  <li role=\"presentation\" ui-sref-active=\"active\"><a href ui-sref=\'blog.events\' aria-controls=\"profile\" role=\"tab\" data-toggle=\"tab\">events</a></li>\n</ul>\n\n<div ui-view></div>");
$templateCache.put("/static/templates/blog.news.html","<div class=\"post\" ng-repeat=\'post in items\' ng-include=\'\"templates/partials/post.html\"|prefixTemplate\'></div>");
$templateCache.put("/static/templates/draft.html","\n\n<!-- <span class=\'btn-line-group\'><button class=\'btn-line active\' ng-click=\'save()\'>{{isSaving? \"saving...\":\"save\"}}</button></span> -->\n\n<textarea id=\'draft-title\' rows=\"1\" msd-elastic ng-model=\'title\' type=\'text\' placeholder=\'Untitled\'></textarea>\n\n<blockquote>\n  <textarea id=\'draft-abstract\' rows=\"1\" msd-elastic ng-model=\'abstract\' type=\'text\' placeholder=\'abstract\'></textarea>\n</blockquote>\n\n<div style=\'position:absolute; top:-60px\' ng-if=\'!isDraft\'>\n  <!-- <div ng-if=\'metadata.owner.is_staff\' class=\'btn-line-group\'> -->\n  <div class=\'btn-line-group\'>\n    <button class=\'btn-line\' ng-click=\'setStatus(\"draft\")\' ng-class=\'metadata.status==\"draft\"?\"active\":\"\"\'>draft</button>\n    <button class=\'btn-line\' ng-click=\'setStatus(\"public\")\' ng-class=\'metadata.status==\"public\"?\"active\":\"\"\'>public</button>\n  </div>\n  <a ng-if=\'id\' ui-sref=\"post({postId: id})\">view</a>\n  </div>\n  <!-- </div> -->\n  \n</div>\n\n<div class=\'section\' ng-if=\'user.is_staff\'>\n  <!-- <label translate=\"displayed-as\"></label> -->\n  <tags-input class=\'tags-input\' placeholder=\'{{\"staff.drafts.tags.placeholder\"| translate}}\' on-tag-added=\'attachTag($tag)\' on-tag-removed=\'detachTag($tag)\' key-property=\'id\' display-property=\'name\' ng-model=\"displayedTags\" add-from-autocomplete-only=\"true\">\n    <auto-complete source=\"suggestTags($query, {category__in:[\'blog\',\'writing\', \'highlights\']})\" ></auto-complete>\n\n  </tags-input>\n</div>\n\n<div class=\'section\' ng-if=\'!isDraft && user.is_staff\'>\n  <!-- <label translate=\"keywords\"></label> -->\n  <tags-input class=\'tags-input\' placeholder=\'{{\"drafts.keywords.placeholder\"| translate}}\' key-property=\'id\' display-property=\'name\' ng-model=\"tags\">\n    <auto-complete source=\"suggestTags($query, {category:\'keyword\'})\"></auto-complete>\n\n  </tags-input>\n</div>\n\n<div class=\'authors\' ng-if=\'!isDraft\'>\nby <a href>{{metadata.owner.username}}</a>\n</div>\n<div class=\'authors\' ng-if=\'isDraft\'>\n  <div ng-if=\'user.username\'>\n    by <a href>{{user.username}}</a>\n  </div>\n  <div ng-if=\'!user.username\'>\n    by <a href>anonymous</a>\n  </div>\n</div>\n\n<!-- <div ng-if=\'!isDraft\'>\n  <form class=\"form-inline\">\n    <div class=\"form-group\">\n      <label translate=\'date\'></label>\n      <input type=\"text\" class=\"form-control\" ng-model=\"date\" name=\"date\" data-max-date=\"today\" timezone=\'UTC\' bs-datepicker data-autoclose=\"1\">{{date}}\n    </div>\n  </form>\n</div> -->\n\n<div id=\"draft-contents\">\n\n  <div style=\'min-height: 50px; position:relative\'>\n      <!-- <medium-editor ng-model=\'contents\' bind-options=\"mediumOptions\"></medium-editor> -->\n      \n      <div mde=\'contents\' setdocs=\'setDocuments(documents)\' settoc=\'setToC(items)\'></div>\n      \n  </div>\n</div>");
$templateCache.put("/static/templates/events.html","<h2>events</h2>\n<!-- Nav tabs -->\n<ul class=\"nav nav-tabs\" role=\"tablist\">\n  <li role=\"presentation\" ui-sref-active=\"active\"><a href ui-sref=\'events.everything\' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\">everything</a></li>\n  <li role=\"presentation\" ui-sref-active=\"active\"><a href ui-sref=\'events.events\' aria-controls=\"profile\" role=\"tab\" data-toggle=\"tab\">working seminars</a></li>\n</ul>\n\n<div ui-view></div>");
$templateCache.put("/static/templates/index.html","\n<div class=\"row\">\n  <div class=\"col-sm-8\">\n\n    <!-- CONVER STORY -->\n    <div class=\"coverstory\">\n      <div class=\"type\" ng-if=\"coverstory.tags.length\">\n        <span ng-repeat=\'tag in coverstory.tags\' ng-if=\'tag.category == \"writing\"\' ng-include=\'\"templates/partials/tag.html\"|prefixTemplate\'></span>\n      </div>\n\n      <h3><a href ui-sref=\"post({postId: coverstory.id})\">{{coverstory.title}}</a></h3>\n      <blockquote>{{coverstory.excerpt}} <a href ui-sref=\"post({postId: coverstory.id})\"><span class=\'icon-arrow-right-circle\'></span></a></blockquote>\n      <div class=\'authors\' ng-if=\"coverstory.authors.length\">\n        by <span ng-repeat=\'author in coverstory.authors\' ng-include=\'\"templates/partials/author.html\"|prefixTemplate\'></span>\n      </div>\n\n      <div ng-if=\'coverstory.cover\'>\n        <div class=\'cover\' style=\'background-size: cover; height:300px; background-image:url({{coverstory.cover}})\'></div>\n      </div>\n\n      \n    </div>\n\n    \n    <div class=\"row\">\n    <!-- REMAINING STORIES -->\n      <div ng-repeat=\'story in otherstories\' class=\"col-sm-6\">\n        <div class=\"coverstory other\">\n          <div class=\"divider\"></div>\n          <div class=\"tags\" ng-if=\"story.tags.length\">\n            <span  class=\'tag\' ng-repeat=\'tag in story.tags|filter:\"public\"\' ng-include=\'\"templates/partials/tag.html\"|prefixTemplate\'></span>\n          </div>\n          <h4><a href ui-sref=\"post({postId: story.id})\">{{story.title}}</a></h4>\n          \n          <blockquote class=\"reduced\">{{story.excerpt}} <span class=\'icon-arrow-right-circle\'></span></blockquote>\n          <div class=\'authors\' ng-if=\"coverstory.authors.length\">\n            by <span ng-repeat=\'author in coverstory.authors\' ng-include=\'\"templates/partials/author.html\"|prefixTemplate\'></span>\n          </div>\n        </div>\n      </div>\n    </div>\n\n  </div>\n  <div class=\"col-sm-4\">\n    <div ng-repeat=\'story in news\'>\n        <div class=\"coverstory news\">\n          <div ng-if=\'!$first\' class=\"divider\"></div>\n          <div class=\"date\">{{story.date_created|date:\'mediumDate\'}}</div>\n          <h4><a href ui-sref=\"post({postId: story.id})\">{{story.title}}</a></h4>\n\n          <div class=\'authors\' ng-if=\"coverstory.authors.length\">\n        by <span ng-repeat=\'author in coverstory.authors\' ng-include=\'\"templates/partials/author.html\"|prefixTemplate\'></span>\n      </div>\n          <blockquote class=\"reduced\">{{story.excerpt}} <span class=\'icon-arrow-right-circle\'></span></blockquote>\n          \n        </div>\n      </div>\n    </div>\n\n  </div>\n</div>");
$templateCache.put("/static/templates/login.html","login\n\n<div class=\'btn-group\'>\n  <a href=\'/auth/twitter\' class=\'btn btn-default\'>connect with twitter</a>\n  <a  class=\'btn btn-default\'>connect with google</a>\n</div>\n");
$templateCache.put("/static/templates/md.html","<div marked=\'md\' language=\'language\' settoc=\'setToC(ToC)\'></div>");
$templateCache.put("/static/templates/post.html","<div class=\"post\">\n  <div class=\"cover\" ng-if=\'hasCoverVideo\'>\n    <iframe width=\"100%\" height=\"320\" src=\"https://www.youtube.com/embed/Ca93bp-jpn8\" frameborder=\"0\" allowfullscreen></iframe>\n\n  </div>\n  <div class=\'overlay\'>\n    <div class=\"tags\" >\n      <span ng-if=\"post.tags.length\" class=\'tag\' ng-repeat=\'tag in post.tags|filter:\"public\"\' ng-include=\'\"templates/partials/tag.html\"|prefixTemplate\'></span>\n      <div class=\'btn-line-group\'>\n        <button class=\'btn-line active\' nref ui-sref=\'writing({storyId:post.id})\'>edit</button>\n      </div>\n    </div>\n    <h2>{{post.title}}</h2>  \n    <blockquote>\n      {{post.abstract}}\n    </blockquote>\n    \n  \n    <div class=\'authors\' ng-if=\"post.authors.length\">\n      by <span ng-repeat=\'author in post.authors\' ng-include=\'\"templates/partials/author.html\"|prefixTemplate\'></span>\n    </div>\n    <div class=\"contents\">\n     <div marked=\'post.contents\' settoc=\'setToC(ToC)\' setdocs=\'setDocuments(items)\'></div>\n    </div>  \n  </div>\n</div>\n");
$templateCache.put("/static/templates/publications.articles.html","publications.articles.html");
$templateCache.put("/static/templates/publications.html","<h2 translate=\"publications\"></h2>\n<!-- Nav tabs -->\n  <ul class=\'nav nav-tabs\'>\n    <li ng-repeat=\'link in urls\' role=\"presentation\" ui-sref-active=\"active\">\n      <a href ui-sref=\'publications.{{link.name}}\' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate=\"{{link.name}}\"></a>\n    </li>\n  </ul>\n  \n\n<div ui-view></div>");
$templateCache.put("/static/templates/partials/author.html","<a class=\'author\' ui-sref=\'author.publications({username:author.username})\'>{{author.first_name}} {{author.last_name}}</a>{{$last?\'\':\', \'}}");
$templateCache.put("/static/templates/partials/breakingNews.html","<div class=\"wrapper\" style=\'    background-size: cover; background-image: url({{news.cover}})\'>\n  <div class=\'overlay\'>\n    <div class=\"type\">\n      <span ng-repeat=\'tag in news.tags\' ng-if=\'tag.category == \"writing\"\' ng-include=\'\"templates/partials/tag.html\"|prefixTemplate\'></span>\n    </div>\n    <h3><a ui-sref=\"post({postId: news.id})\">{{news.title}}</a></h3>  \n  </div>\n</div>");
$templateCache.put("/static/templates/partials/document.html","<div class=\'doc doc-{{document.type}} {{document.isSelected?\"active\":\"\"}}\' ng-click=\'selectDocument(document)\'>\n\n      <div class=\'divider\'>&nbsp;</div>\n      <!-- this element has fixed height. -->\n      <div ng-if=\'document.type==\"video-cover\"\'>\n        \n        <div class=\'caption reference\' markdown=\'document.metadata.reference.fr\'></div>\n        <div class=\'copyright\'>{{document.copyrights}}</div>\n        \n      </div>\n\n      <div ng-if=\'document.type==\"picture\"\' lazy-image src=\'document.src\'></div>\n      \n      <div ng-if=\'document.type==\"image\" && document.metadata.urls\' lazy-image src=\'document.metadata.urls.Preview\'></div>\n\n      <div ng-if=\'document.type==\"pdf\"\' lazy-image src=\'document.snapshot\'></div>\n      \n\n      <blockquote ng-if=\'document.citation\' markdown=\'document.citation\'></blockquote>\n\n\n      \n      <div ng-if=\'!document.metadata\'>\n        <div ng-if=\'document.title\' class=\'title\'>{{document.title}}</div>\n        <div ng-if=\'document.caption\' class=\'caption\'>{{document.caption}}</div>\n        <div ng-if=\'document.copyrights\' class=\'copyright\'>{{document.copyrights}}</div>\n        \n      </div>\n\n      <div ng-if=\'document.type==\"bibtex\"\'>\n        <div class=\'caption\'>\n          <span ng-if=\'document.metadata.author\'>{{document.metadata.author|bibtex}},</span>\n          <span ng-if=\'document.metadata.editor\'>{{document.metadata.editor|bibtex}}</span>(edited by)</span> \n          \n          <em>{{document.metadata.title|bibtex}}</em>\n          <span>{{document.metadata.publisher|bibtex}}</span>\n          <span ng-if=\'document.metadata.year\'>, <span>{{document.metadata.year|bibtex}}</span> \n        </div>\n      </div>\n\n      <div ng-if=\'document.type!=\"bibtex\" && document.metadata.title\'>\n        <div class=\'caption\' markdown=\'document.metadata.title\'></div>\n        <div ng-if=\'document.metadata.reference\' class=\'caption reference\' markdown=\'document.metadata.reference\'></div>\n        <div ng-if=\'document.metadata.copyright\' class=\'copyright\' markdown=\'document.metadata.copyright\'></div>\n        <div ng-if=\'document.metadata.author_name\' class=\'copyright\'>\n          <a ng-href=\'{{document.metadata.author_url}}\' target=\'_blank\' markdown=\'document.metadata.author_name\'></a>\n        </div>\n      </div>\n\n    </div>");
$templateCache.put("/static/templates/partials/mde.html","<div class=\'mde\'>\n  <div class=\'toolbox\'> \n      <button ng-disabled=\'isPreviewEnabled\' class=\'btn {{activeStates.indexOf(\"strong\") != -1?\"active\": \"\"}}\' ng-click=\'action(\"toggleBold\")\'>B</button>\n      <button ng-disabled=\'isPreviewEnabled\' class=\'btn {{activeStates.indexOf(\"em\") != -1?\"active\": \"\"}}\' style=\'font-style:italic\' ng-click=\'action(\"toggleItalic\")\'>I</button>\n      <button ng-disabled=\'isPreviewEnabled\' class=\'btn {{activeStates.indexOf(\"header-1\") != -1?\"active\": \"\"}}\' ng-click=\'action(\"toggleHeading1\")\'>H1</button>\n      <button ng-disabled=\'isPreviewEnabled\' class=\'btn {{activeStates.indexOf(\"header-2\") != -1?\"active\": \"\"}}\' ng-click=\'action(\"toggleHeading2\")\'>H2</button>\n      <button ng-disabled=\'isPreviewEnabled\' class=\'btn {{activeStates.indexOf(\"header-3\") != -1?\"active\": \"\"}}\' ng-click=\'action(\"toggleHeading3\")\'>H3</button>\n      <button ng-disabled=\'isPreviewEnabled\' class=\'btn {{activeStates.indexOf(\"quote\") != -1?\"active\": \"\"}}\' ng-click=\'action(\"toggleBlockquote\")\'>Q</button>\n\n      <button style=\'width:70px\' class=\'sans-serif btn {{isPreviewEnabled? \"active\": \"\"}}\' ng-click=\'action(\"togglePreview\")\'>preview</button>\n\n      <button ng-disabled=\'isPreviewEnabled\' class=\'btn {{activeStates.indexOf(\"link\") != -1|| activeStates.indexOf(\"url\") != -1? \"active\": \"\"}}\' ng-click=\'showReferenceModal()\'><span class=\'icon-plus\'></span></button>\n      <!-- {{activeStates}} -->\n  </div>\n  <div class=\'wand\' >\n    <button class=\'btn\' ng-disabled=\'isPreviewEnabled\' ng-click=\'showReferenceModal()\'><span class=\'icon-plus\'></span></button>    \n  </div>\n\n	<textarea class=\'mde-textarea\' placeholder=\"write something...\"></textarea>\n</div>");
$templateCache.put("/static/templates/partials/oembed-search-results.html","<div class=\'doc doc-{{document.type}} {{document.isSelected?\"active\":\"\"}}\' ng-click=\'selectDocument(document)\'>\n\n  <div class=\'divider\'>&nbsp;</div>\n  \n  \n  <div ng-if=\'document.urls.Preview\' lazy-image src=\'document.urls.Preview\'></div>\n  \n  <div class=\'caption title\' markdown=\'document.title\'></div>\n  <div class=\'caption reference\' markdown=\'document.reference\'></div>\n</div>");
$templateCache.put("/static/templates/partials/post.html","<div class=\"wrapper\">\n  <div ng-if=\'!$first\' class=\"divider\"></div>\n  <div class=\"tags\" ng-if=\"post.tags.length\">\n      <span class=\'tag\' ng-repeat=\'tag in post.tags|filter:\"public\"\' ng-include=\'\"templates/partials/tag.html\"|prefixTemplate\'></span>\n  </div>\n  <div class=\"date\">{{post.date_created|date:\'mediumDate\'}}</div>\n\n  <h3><a ui-sref=\"post({postId: post.id})\">{{post.title}} {{post.status != \'public\'? \'(DRAFT)\': \'\'}}</a></h3>  \n  \n  <blockquote class=\"reduced\">{{post.excerpt}}.<a href ui-sref=\"post({postId: post.id})\"><span class=\'icon-arrow-right-circle\'></span></a></blockquote>\n  <em ng-if=\"post.difference\">{{post.difference}}</em>\n\n  <p>\n    \n    <span class=\'creator\' ng-if=\"!post.authors.length\">\n      created by <span ng-init=\'author=post.owner;$last=true\' ng-include=\'\"templates/partials/author.html\"|prefixTemplate\'></span>\n    </span>\n    <span class=\'authors\' ng-if=\"post.authors.length\">\n      written by <span ng-repeat=\'author in post.authors\' ng-include=\'\"templates/partials/author.html\"|prefixTemplate\'></span>\n    </span>\n  </p>\n</div>");
$templateCache.put("/static/templates/partials/table-of-contents.html","\n<div id=\'inner-table-of-contents-toggler\' >\n  <button class=\'btn-transparent\' ng-click=\'toggleTableOfContents()\'><span class=\'icon-action-undo\'></span></button>\n  <div class=\'save\' ng-if=\'state == \"writing\" || state == \"draft\"\' ng-click=\'save()\'>\n    <button class=\'btn-transparent btn-line\'><span  class=\'icon-disc\'></span></button>\n    <div class=\'sans-serif\' style=\'text-transform: uppercase; font-size:10px; text-align:center; line-height:20px\' translate=\'save\'></div>\n  </div>\n  <!-- <div class=\'edit\' ng-if=\'state == \"post\"\' ng-click=\'save()\'>\n    <button class=\'btn-transparent btn-line\'><span  class=\'icon-disc\'></span></button>\n    <div class=\'sans-serif\' style=\'text-transform: uppercase; font-size:10px; text-align:center; line-height:20px\' translate=\'save\'></div>\n  </div> -->\n</div>\n\n<h2>table of contents</h2>\n\n\n<ul>\n  <li ng-repeat=\"heading in ToC\" class=\'heading heading-{{heading.level}}\'>\n  <a ng-click=\'setHash(heading.slug)\'> {{heading.text}}</a></li>\n\n</ul>");
$templateCache.put("/static/templates/partials/table-of-documents.html","<!-- <h2>table of documents</h2>\n -->\n\n<ul>\n  <li ng-repeat=\"document in documents\">\n    <div class=\'doc doc-{{document.type}}\'>\n      <div class=\'divider\'>&nbsp;</div>\n      <!-- this element has fixed height. -->\n      <div ng-if=\'document.type==\"video-cover\"\'>\n        \n        \n      </div>\n\n      <div ng-if=\'document.type==\"picture\"\'>\n        \n        <div lazy-image src=\'document.src\'></div>\n        \n      </div>\n\n      <div ng-if=\'document.type==\"image\"\'>\n        <div lazy-image ng-click=\'fullsize(document)\' src=\'document.metadata.urls.Preview\'></div>\n      </div>\n\n      <div ng-if=\'document.type==\"video\"\'>\n        <div ng-if=\"document.metadata.thumbnail_url\" ng-click=\'fullsize(document)\' lazy-image src=\'document.metadata.thumbnail_url\'></div>\n        <div ng-if=\"!document.metadata.thumbnail_url && document.metadata.urls.Preview\" lazy-image src=\'document.metadata.urls.Preview\'></div>\n      </div>\n\n      <div ng-if=\'document.type==\"text\"\'>\n        <div lazy-image ng-click=\'fullsize(document)\' src=\'document.metadata.urls.Preview\'></div>\n      </div>\n\n      <div ng-if=\'document.type==\"pdf\"\'>\n        <div lazy-image src=\'{{document.snapshot}}\'></div>\n      </div>\n\n      <div ng-if=\'!document.metadata.title\'>\n        <blockquote>{{document.citation}}</blockquote>\n        <div class=\'caption\'>{{document.caption}}</div>\n        <div class=\'copyright\'>{{document.copyrights}}</div>\n        \n      </div>\n\n      <div ng-if=\'document.type==\"bibtex\"\'>\n        <div class=\'caption\'>\n          <span ng-if=\'document.metadata.author\'>{{document.metadata.author|bibtex}}\',</span>\n          <span ng-if=\'document.metadata.editor\'>{{document.metadata.editor|bibtex}}\'></span>(edited by)</span> \n          \n          <em>{{document.metadata.title|bibtex}}</em>\n          <span>{{document.metadata.publisher|bibtex}}</span>\n          <span ng-if=\'document.metadata.year\'>, <span>{{document.metadata.year|bibtex}}</span> \n        </div>\n      </div>\n\n      <div ng-if=\'document.type!=\"bibtex\" && document.metadata.title\'>\n        <div class=\'caption\' markdown=\'document.metadata.title\'></div>\n        <div ng-if=\'document.metadata.reference\' class=\'caption reference\' markdown=\'document.metadata.reference\'></div>\n        <div ng-if=\'document.metadata.copyright\' class=\'copyright\' markdown=\'document.metadata.copyright\'></div>\n        <div ng-if=\'document.metadata.author_name\' class=\'copyright\'>\n          <a ng-href=\'{{document.metadata.author_url}}\' target=\'_blank\' markdown=\'document.metadata.author_name\'></a>\n        </div>\n      </div>\n    </div>\n  </li>\n\n</ul>");
$templateCache.put("/static/templates/partials/tag.html","<span ng-class=\'tag.category\'>{{tag.name}}</span>{{$last?\' \': \', \'}}");
$templateCache.put("/static/templates/partials/tag.input.html","<span ng-class=\'data.category\'>\n  <span class=\'type\'>{{data.category}}/</span>\n  <span>{{data.name}}</span>\n	<a class=\"remove-button\" ng-click=\"$removeTag()\" ><span class=\'icon-close\'></span></a>\n</span>");
$templateCache.put("/static/templates/partials/term.html","<div ng-class=\'{\"active\": term.isSelected}\' class=\'doc term\' ng-click=\'selectDocument(term)\'>\n  <div class=\'divider\'>&nbsp;</div>\n  <!-- this element has fixed height. -->\n  \n  <div class=\'caption title\' markdown=\'term.title\'></div>\n  <div class=\'caption reference\' markdown=\'term.abstract\'></div>\n  <div class=\'copyright\' markdown=\'document.copyright\'></div>\n\n</div>");
$templateCache.put("/static/templates/partials/embeds/YouTube.html","\n<div class=\'caption title\' markdown=\'embed.title\'></div>\n<div class=\'copyright\'><a ng-href=\'embed.author_url\'>{{embed.author_name}}</a></div>\n\n\n<div lazy-image src=\'embed.thumbnail_url\'></div>\n\n");
$templateCache.put("/static/templates/partials/embeds/cvce.html","\n<div class=\'caption title\' markdown=\'embed.title.fr\'></div>\n<div class=\'caption reference\' markdown=\'embed.reference.fr\'></div>\n<div class=\'copyright\'>{{embed.copyrights}}</div>\n\n\n <div ng-if=\'embed.urls.Preview\'>\n  <div lazy-image src=\'embed.urls.Preview\'></div>\n </div>\n\n");
$templateCache.put("/static/templates/partials/modals/fullsize.html","<div class=\"modal fullsize\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\" style=\"z-index: 1050; display: block;\">\n  <div ng-click=\'$hide()\' class=\'close\'>\n  <span class=\'icon-close\'></span>\n  </div>\n  <div class=\'oversize\' style=\'\'>\n    <div class=\'wrapper\' ng-if=\'fullsized.type == \"image\"\'>\n\n      <div lazy-image size=\'contain\' src=\'fullsized.metadata.urls.Publishable\'></div>\n\n      <div class=\'heading\'>\n        <h2 marked=\'fullsized.metadata.title\'></h2>\n        <div marked=\'fullsized.metadata.reference\'></div>\n        \n      </div>\n      <div class=\'inner\'>\n        <div class=\'text caption\' marked=\'fullsized.metadata.caption\'></div>\n        <div class=\'text copyright\' marked=\'fullsized.metadata.copyright\'></div>\n      </div>\n    </div>\n\n    <div class=\'wrapper\' ng-if=\'fullsized.type == \"video\"\'>\n      <!-- <div class=\'heading\'>\n        <h2 marked=\'fullsized.metadata.title\'></h2>\n        <div ng-if=\'fullsized.metadata.reference\' marked=\'fullsized.metadata.reference\'></div>\n        \n      </div> -->\n\n   \n      <div style=\'height: 100%\' ng-if=\'fullsized.metadata.html\' marked=\'fullsized.metadata.html\'></div>\n    </div>\n  </div>\n</div>");
$templateCache.put("/static/templates/partials/modals/mde-enrich.html","<div class=\"modal\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\" style=\"z-index: 1050; display: block;\">\n  <div class=\"modal-dialog\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\" ng-show=\"title\">\n      <button type=\"button\" class=\"close\" aria-label=\"Close\" ng-click=\"$hide()\">\n      <span aria-hidden=\"true\" class=\'icon-close\'></span>\n      </button>\n      <h4 class=\"modal-title\">add resource</h4></div>\n      \n      <div class=\"modal-body\">\n\n        \n        <!-- <input type=\'text\' class=\"form-control\" placeholder=\"search ...\"> -->\n        <ul class=\"nav nav-tabs\" style=\'padding-left:15px\' role=\"tablist\">\n          <li role=\"presentation\" ng-class=\"tab == \'favourite\'? \'active\':\'\'\"><a ng-click=\'setTab(\"favourite\")\' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate=\'enrich.resources\'></a></li>\n          <li role=\"presentation\" ng-class=\'{\"active\": tab == \"glossary\"}\'><a ng-click=\'setTab(\"glossary\")\' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate=\'enrich.glossary\'></a></li>\n          <li role=\"presentation\" ng-class=\"tab == \'CVCE\'? \'active\':\'\'\"><a ng-click=\'setTab(\"CVCE\")\' aria-controls=\"profile\" role=\"tab\" data-toggle=\"tab\">cvce archives</a></li>\n          \n          <li role=\"presentation\" ng-class=\"tab == \'url\'? \'active\':\'\'\"><a ng-click=\'setTab(\"url\")\' aria-controls=\"messages\" role=\"tab\" data-toggle=\"tab\" translate=\'enrich.fromUrl\'></a></li>\n\n          <!-- <li role=\"presentation\" ng-class=\"tab == \'bibtex\'? \'active\':\'\'\"><a ng-click=\'setTab(\"bibtex\")\' aria-controls=\"messages\" role=\"tab\" data-toggle=\"tab\">new reference</a></li> -->\n          \n        </ul>\n\n        \n          <div ng-show=\"tab == \'favourite\'\" class=\"tab-content\">\n            <div class=\'section\' ng-class=\'{\"last\": !lookups.length}\'>\n              <label>\n                <span translate=\'search\'></span>\n                <span style=\'color: #b7b7b7\' translate=\'{{suggestMessage}}\'></span>\n              </label>\n              <input placeholder=\'...\' class=\'form-control\' type=\'text\' ng-model=\'query\' ng-model-options=\"{ debounce: 250 }\" ng-change=\'suggest(query, tab)\'>\n            </div>\n            <div class=\'section last\'>\n              <ul ><li ng-repeat=\'document in lookups\' ng-include=\'\"templates/partials/document.html\"|prefixTemplate\'></li>\n              </ul>\n            </div>\n          </div>\n\n          <div ng-show=\"tab == \'glossary\'\" class=\"tab-content\">\n            <div class=\'section\' ng-class=\'{\"last\": !glossary.length}\'>\n              <label>\n                <span translate=\'search\'></span>\n                <span style=\'color: #b7b7b7\' translate=\'{{suggestMessage}}\'></span>\n              </label>\n              <input placeholder=\'...\' class=\'form-control\' type=\'text\' ng-model=\'query\' ng-model-options=\"{ debounce: 250 }\" ng-change=\'suggest(query, tab)\'>\n            </div>\n            <div class=\'section last\'>\n              <ul ><li ng-repeat=\'term in glossary\' ng-include=\'\"templates/partials/term.html\"|prefixTemplate\'></li>\n              </ul>\n            </div>\n          </div>\n\n          <div ng-show=\"tab == \'CVCE\'\" class=\"tab-content\">\n            <div class=\'section\' ng-class=\'{\"last\": !suggestResults.length}\'>\n              <label>\n                <span translate=\'search\'></span>\n                <span style=\'color: #b7b7b7\' translate=\'{{suggestMessage}}\'></span>\n              </label>\n              <input placeholder=\'...\' class=\'form-control\' type=\'text\' ng-model=\'query\' ng-model-options=\"{ debounce: 250 }\" ng-change=\'suggest(query, tab)\'>\n            </div>\n            <div class=\'section last\'>\n              <ul >\n                <li ng-repeat=\'document in suggestResults\' ng-include=\'\"templates/partials/oembed-search-results.html\"|prefixTemplate\'>\n                </li>\n              </ul>\n            </div>\n          </div>\n\n          <div ng-show=\"tab == \'url\'\" class=\"tab-content\">\n            <div class=\'section\'>\n              <label translate=\'url\'></label>\n              <span style=\'color: #b7b7b7\' translate=\'{{suggestMessage}}\'></span>\n              <div class=\'elastic-textarea-wrapper\'>\n                <textarea class=\"elastic-textarea\" rows=\"3\" msd-elastic ng-model=\'url\' ng-change=\'previewUrl(url)\' type=\'text\' placeholder=\'http://\'></textarea>\n              </div>\n            \n              <div class=\'preview\' ng-class=\'embed.type\'>\n                <div ng-if=\'embed.provider_name==\"CVCE\"\' ng-include=\'\"templates/partials/embeds/cvce.html\"|prefixTemplate\'></div>\n                <div ng-if=\'embed.provider_name==\"YouTube\"\' ng-include=\'\"templates/partials/embeds/YouTube.html\"|prefixTemplate\'></div>\n                <div ng-if=\'embed.type == \"link\"\'>\n                  <a href=\'embed.url\'>{{embed.title}}</a>\n                  <div markdown=\'embed.description\'></div>\n                </div>\n                <div ng-if=\'embed.type == \"rich\"\'>\n                  <a ng-href=\'embed.url\' target=\'_blank\'>url</a>\n                  <div ng-if=\'embed.html\' markdown=\'embed.html\'></div>\n                  <div ng-if=\'!embed.title\' translate=\'enrich.type.notsupported\'></div>\n                  <div>\n                    <label translate=\'title\'></label>\n                    <input class=\'form-control\' ng-model=\'embed.title\'></input>\n                  </div>\n                </div>\n              </div>\n            </div>\n            <div class=\'section last\'>\n              <label translate=\'bibtex reference\'></label>\n              <div class=\'elastic-textarea-wrapper\'>\n                <textarea class=\"elastic-textarea\" rows=\"3\" msd-elastic ng-model=\'reference\' type=\'text\' placeholder=\'@{}\'></textarea>\n              </div>\n              <div class=\'sans-serif description\'>You can use <a href=\'http://truben.no/latex/bibtex/\'>this web app</a> to easily build a bibtex reference</div>\n              \n            </div>\n          </div>\n\n          <div ng-show=\"tab == \'bibtex\'\" class=\"tab-content\">\n            Add a reference (bibtex) Cfr <a href=\'https://www.zotero.org/support/creating_bibliographies\'>quick copy from Zotero</a>\n            <label translate=\'bibtex\'></label>\n            <div class=\'elastic-textarea-wrapper\'>\n              <textarea class=\"elastic-textarea\" style=\"font-family: monospace;\" rows=\"8\" msd-elastic ng-model=\'reference\' type=\'text\' placeholder=\'@BOOK {}\'></textarea>\n            </div>\n          </div>\n          <div style=\'clear:both\'></div>\n\n\n      </div>\n      <div class=\"modal-footer\">\n        <span class=\'btn-line-group\'><button type=\"button\" class=\"btn-line {{isSomethingSelected?\'active\':\'\'}}\" ng-click=\"addDocument(tab, contents, reference, url, embed)\" translate=\'button.add\'></button>\n        </span>\n        <span class=\'btn-line-group\'>\n        <button type=\"button\" class=\"btn-line\" ng-click=\"$hide()\">Close</button>\n        </span>\n      </div>\n    </div>\n  </div>\n</div>");}]);
/**
 * @ngdoc function
 * @name miller.controller:MeCtrl
 * @description
 * # MeCtrl
 * common functions go here.
 */
angular.module('miller')
  .controller('AuthorCtrl', function ($scope, $log, profile) {
    $scope.isMe = $scope.user.username == profile.username;
    $scope.profile = profile;
    $log.log('AuthorCtrl ready, user:', $scope.user, profile);
    
  });
  
/**
 * @ngdoc function
 * @name miller.controller:BlogCtrl
 * @description
 * # BlogCtrl
 * list stories of type blogpost.
 */
angular.module('miller')
  .controller('BlogCtrl', function ($scope, $log) {
    $log.log('BlogCtrl ready');

  });
  
/**
 * @ngdoc function
 * @name miller.controller:coreCtrl
 * @description
 * # CoreCtrl
 * common functions go here.
 */
angular.module('miller')
  .controller('CoreCtrl', function ($rootScope, $scope, $log, $location, $anchorScroll, $modal, $alert, localStorageService, $translate, $timeout, StoryFactory, TagFactory, RUNTIME, EVENTS) {    
    $log.log('CoreCtrl ready, user:', RUNTIME.user.username, RUNTIME);

    $scope.user = RUNTIME.user;

    $scope.hasToC = false;
    $scope.ToCEnabled = false;

    $scope.stopStateChangeStart = false; // cfr toggleStopStateChangeStart below

    $scope.toggleTableOfContents = function() {
      $scope.hasToC = !$scope.hasToC;
    };

    $scope.locationPath = '';

    // toggle stopStateChangeStart variable thus affecting the StateChangeStart event
    $scope.toggleStopStateChangeStart = function(value) {
      $log.debug('CoreCtrl > toggleStopStateChangeStart value:', value, '- current:',$scope.stopStateChangeStart)
      $scope.stopStateChangeStart = typeof value == 'boolean'? value: !$scope.stopStateChangeStart;
    };

    $scope.setToC = function(ToC) {
      $log.log('CoreCtrl > setToC data:', ToC);
      $scope.ToC = ToC;
      // $scope.ToCEnabled = false;
    };

    $scope.disableToC = function(){
      $scope.ToCDisabled = true;
    };

    // add document items to the table-of)documents
    $scope.setDocuments = function(documents) {
      $log.log('CoreCtrl > setDocuments items n.:', documents.length, documents);
      $scope.documents = documents;
      if($scope.qs.view) {
        // check if it's somewhere in the scope, otherwise callit
        for(var i=0,j=$scope.documents.length;i<j;i++){
          if($scope.qs.view == $scope.documents[i].short_url){
            $scope.fullsized = $scope.documents[i];
            fullsizeModal.$promise.then(fullsizeModal.show);
            break;
          }
        }
      };
    };

    $scope.save = function(){
      $log.log('CoreCtrl > @SAVE ...'); 
      $scope.$broadcast(EVENTS.SAVE);
    };

    $scope.update = function(key, value){
      $log.log('CoreCtrl > @UPDATE ',key,':',value,' ...'); 
      var _d = {};
      _d[key] = value;
      $scope.$broadcast(EVENTS.UPDATE, _d);
    };


    $scope.lock = function(){
      $log.log('CoreCtrl > lock .............'); 
      
    };

    $scope.unlock = function(){
      $log.log('CoreCtrl > unlock .............'); 
      
    };

    /*
      Suggest tags for writing purposes
    */
    $scope.suggestTags = function(query, options) {
      $log.log('CoreCtrl -> suggestTags', query, options);
      var filters = options || {};
      return TagFactory.get({
        filters: JSON.stringify(filters)
      }).$promise.then(function(response) {
        return response.results;
      });
    };

    /*

    */
    /*
      Set breaking news above the header.
      Cfr indexCtrl
    */
    $scope.breakingNews = [];
    $scope.setBreakingNews = function(breakingNews) {
      $scope.breakingNews = breakingNews.slice(0,3);
    };

    $rootScope.$on('$stateChangeStart', function (e, state) {
      $log.log('CoreCtrl @stateChangeStart new:', state.name, '- previous:', $scope.state);
      // for specific state only.

      if($scope.stopStateChangeStart === true){
        // check the user has wirtten sometihing..
        var answer = confirm("Are you sure you want to leave this page?")
        if (!answer) {
            e.preventDefault();
        }
      }
    });

    $rootScope.$on('$stateChangeSuccess', function (e, state) {
      var h =  $location.hash();

      $log.debug('CoreCtrl @stateChangeSuccess', state.name, h);

      // clean
      $scope.ToC = [];
      $scope.documents = [];

      // the ui.router state (cfr app.js)
      $scope.state = state.name;
      $timeout($anchorScroll, 0); // wait for the next digest cycle (cfr marked directive)

      // toggle stopChanceStart if the state is among the blocking ones
      $scope.toggleStopStateChangeStart(false);


    });


    $scope.setHash = function(hash) {
      $location.hash(hash);
    };

    $scope.changeLanguage = function(key) {
      $scope.language = key;
      localStorageService.set('lang', $scope.language);
      $translate.use(key);
    };

    $scope.isWithoutAuthors = function(story) {
      return story.authors.length !== 0;
    }
    /*
      When requested, fullsize for documents.
      Cfr also locationChangeSuccess listener 
    */
    var fullsizeModal = $modal({
      scope: $scope, 
      template: RUNTIME.static + 'templates/partials/modals/fullsize.html',
      id: 'dii',
      show: false
    });
    
    $scope.$on('modal.hide', function(e,modal){
      if(modal.$id== 'dii')
        $location.search('view', null);
    });

    $scope.fullsize = function(doc) {
      $log.log('CoreCtrl -> fullsize', doc);
      $scope.fullsized = doc;
      $location.search('view', doc.short_url);
    };


    /*
      Prevent from closing
    */
    window.onbeforeunload = function (event) {
      if($scope.state && ['draft', 'writing'].indexOf($scope.state) !== -1){
        var message = 'Sure you want to leave?';
        if (typeof event == 'undefined') {
          event = window.event;
        }
        if (event) {
          event.returnValue = message;
        }
        return message;
      }
    }

    /*
      On location change, collect the parameters.
      Since this is called BEFORE statehangeSuccess, the scrolling cannot be made at this level.
    */
    $scope.$on('$locationChangeSuccess', function (e, path) {
      $log.debug('CoreCtrl @locationChangeSuccess', path, $location);
      $scope.qs = $location.search();
      $scope.locationPath = path;
      $scope.path = $location.path();

      if($scope.qs.view && $scope.fullsized && $scope.fullsized.short_url == $scope.qs.view){
        // normal behaviour, after fullsize has been called the view param is present in location
        fullsizeModal.$promise.then(fullsizeModal.show);
      }
    });

    // watch 400 bad request form error. Cfr app.js interceptors.
    $rootScope.$on(EVENTS.BAD_REQUEST, function(e, rejection){
      $alert({
        placement: 'top',
        title: 'form errors', 
        'animation': 'bounceIn',
        content: _(rejection.data).map(function(d,k){
          return '<div><b>'+k+'</b>: '+d+'</div>';
        }).value().join(''),
        show: true, 
        type:'error'
      });
    });

    var timer_event_message;
    // watch for saving or MESSAGE events
    $scope.$on(EVENTS.MESSAGE, function (e, message) {
      $log.log('CoreCtrl @MESSAGE', message);
      $scope.message = message;
      if(timer_event_message)
        $timeout.cancel(timer_event_message);
      timer_event_message = $timeout(function(){
        $scope.message = null;
      }, 2000);
    });
    /*
      First load
    */
    // load language
    $scope.language = localStorageService.get('lang') || 'en_US';
    $scope.changeLanguage($scope.language);
    // load "huighlights"
    StoryFactory.get({
      filters: JSON.stringify({
        tags__slug: 'top'
      })
    }, function(data){
      $log.info('CoreCtrl breaking news loaded', data);
      $scope.setBreakingNews(data.results);
    }); 



  });
  
/**
 * @ngdoc function
 * @name miller.controller:DraftCtrl
 * @description
 * # DraftCtrl
 * handle draft writing ;)
 */
angular.module('miller')
  .controller('DraftCtrl', function ($scope, $log, $state, localStorageService, StoryFactory, EVENTS) {
    $log.debug('DraftCtrl welcome');
    
    $scope.isDraft = true;

    $scope.tags = [];

    $scope.$on(EVENTS.SAVE, function() {
      $scope.$emit(EVENTS.MESSAGE, 'saving');
      StoryFactory.save({}, {
        title: $scope.title,
        abstract: $scope.abstract,
        contents: $scope.contents,
        status: 'draft',
        tags: _.map($scope.tags, 'id')
      }, function(res) {
        $scope.$emit(EVENTS.MESSAGE, 'saved');
        $log.log('DraftCtrl -> @EVENTS.SAVE saved:', res);
        // handle redirection.
        $state.go('writing', {
          storyId: res.id
        })
        // debugger
      });
    });

    // handle attach tag
    $scope.attachTag = function(tag) {
      $log.log('DraftCtrl -> attachTag', tag);
      $scope.tags.push(tag);
    };

    // handle delete tad
    $scope.detachTag = function(tag) {
      $log.log('DraftCtrl -> detachTag', tag);
      // get indexOf current tag
      for(var i=0,j=$scope.tags.length;i<j;i++){
        if($scope.tags[i].id == tag.id){
          $scope.tags.splice(i, 1);
          break;
        }
      }
      // $log.log($scope.tags)
    };

    _offsetables['writing-tools'] = $('#writing-tools');

    /*
      Watch for relevant changes (i;e. trigger after n milliseconds at least)
    */

    // $scope.$watch('title', function(title){
    //   if(title && title.length) {
    //     console.log('DraftCtrl @title v', title);
    //     localStorageService.set('title', title);
    //   }
    // });

    // $scope.$watch('abstract', function(abstract){
    //   if(abstract && abstract.length) {
    //     localStorageService.set('abstract', abstract);
    //   }
    // });

    // $scope.$watch('contents', function(contents){
    //   if(contents && contents.length) {
    //     localStorageService.set('contents', contents);
    //   }
    // });

    // $scope.$watch('metadata', function(metadata){
    //   if(!_.isEmpty(metadata)) {
    //     localStorageService.set('metadata', metadata);
    //   }
    // }, true);

    /*
      load from localstorageservice
    */
    // $scope.title    = localStorageService.get('title') || '';
    // $scope.abstract = localStorageService.get('abstract') || '';
    // $scope.contents = localStorageService.get('contents') || '';
    // $scope.metadata   = localStorageService.get('metadata') || {
    //   status: 'draft',
    //   tags: [],
    //   authors: []
    // };
  });
  
/**
 * @ngdoc function
 * @name miller.controller:indexCtrl
 * @description
 * # IndexCtrl
 */
angular.module('miller')
  .controller('IndexCtrl', function ($scope, $log, writings, news) {
    $log.debug('IndexCtrl welcome', writings);

    /*
      Get the firs n sentence until the number of words are covered.
      return an array
    */
    function tokenize(text, words){
      var sentences = text.split(/[\.!\?]/);
      // console.log(text, sentences);
      return sentences;
    }

    writings.results = writings.results.map(function(d) {
      d.excerpt = d.abstract? tokenize(d.abstract, 10)[0]: '';
      return d;
    });

    $scope.coverstory = writings.results.shift();
    $scope.otherstories = writings.results;

    $scope.news = news.results.map(function(d) {
      d.excerpt = tokenize(d.abstract, 10)[0];
      return d;
    });



  });
  
/**
 * @ngdoc function
 * @name miller.controller:coreCtrl
 * @description
 * # CoreCtrl
 * common functions go here.
 */
angular.module('miller')
  .controller('ItemsCtrl', function ($scope, $log, items, model, factory) {
    $log.log('ItemsCtrl ready', items);

    /*
      Get the firs n sentence until the number of words are covered.
      return an array
    */
    function tokenize(text, words){
      var sentences = text.split(/[\.!\?]/);
      console.log(text, sentences);
      return sentences;
    }

    $scope.items = items.results.map(function(d){
      if(!d.abstract)
        return d;
      var sentences = tokenize(d.abstract, 10);

      d.excerpt = sentences.shift();

      if(sentences.length)
        d.difference = sentences.join('. ');

      return d;
    });

  });
  
/**
 * @ngdoc function
 * @name miller.controller:LoginCtrl
 * @description
 * # LoginCtrl
 * login!
 */
angular.module('miller')
  .controller('LoginCtrl', function ($scope, $log) {
    $log.log('LoginCtrl ready');
  });
  
/**
 * @ngdoc function
 * @name miller.controller:PageCtrl
 * @description
 * # PageCtrl
 * Ctrl for static contents, delivered in markdown.
 */
angular.module('miller')
  .controller('PageCtrl', function ($scope, $log, page) {
    $log.log('PageCtrl ready', page.status);
    // $scope.post = post;
    $scope.md = page.data;

    // colllect media

    // collect h1, h2, h3
  });
  
/**
 * @ngdoc function
 * @name miller.controller:coreCtrl
 * @description
 * # CoreCtrl
 * common functions go here.
 */
angular.module('miller')
  .controller('PostCtrl', function ($scope, $log, post) {
    $log.log('PostCtrl ready', post);
    $scope.post = post;

    // $scope.cover = _(post.documents).filter({type: 'video-cover'}).first();

    // $scope.hasCoverVideo = $scope.cover !== undefined;
    
    // guess if there's a document interview
    // cfr corectrl setDocuments function.
    $scope.setDocuments = function(items) {
      $log.log('PostCtrl > setDocuments items n.:', items.length);
      var documents = [],
          unlinkeddocument = [];


      documents = _.compact([$scope.cover].concat(items.map(function(item){
        var _docs = post.documents.filter(function(doc){
          return doc.slug == item.slug;
        });

        if(!_docs.length){
          $log.error("PostCtrl > cant't find any document matching the link:",item.slug);
          return null;
        }
        return angular.extend({
          citation: item.citation
        }, _docs[0]);

      })));

      $scope.$parent.setDocuments(documents.concat(unlinkeddocument));
    };
  });
  
/**
 * @ngdoc function
 * @name miller.controller:WritingCtrl
 * @description
 * # DraftCtrl
 * handle saved story writing ;)
 */
angular.module('miller')
  .controller('WritingCtrl', function ($scope, $log, $q, $modal, story, localStorageService, StoryFactory, StoryTagsFactory, StoryDocumentsFactory, CaptionFactory, DocumentFactory, EVENTS, RUNTIME) {
    $log.debug('WritingCtrl welcome', story);

    $scope.isDraft = false;
    $scope.isSaving = false;

    $scope.id = story.id;
    $scope.title = story.title;
    $scope.abstract = story.abstract;
    $scope.contents = story.contents;
    $scope.date     = story.date;
    $scope.keywords = _.filter(story.tags, {category: 'keyword'});

    
    $scope.displayedTags = _.filter(story.tags, function(d){
      return d.category != 'keyword';
    });

    $scope.metadata = {
      status: story.status,
      owner: story.owner
    };

    $scope.setStatus = function(status) {
      $scope.metadata.status = status;
      $scope.save();
    };

    /*
      Save or delete documents according to text contents.
    */
    var documentSlugs =  _.map(story.documents, 'slug');

    $scope.setDocuments = function(documents) {
      // check what to save vs what to discard.
      var saveable = documents.filter(function(d){
        return documentSlugs.indexOf(d.slug) == -1;
      });

      var deletable = documents.filter(function(d){
        return documentSlugs.indexOf(d.slug) == -1;
      });

      var included = _.map(documents, 'slug');

      // console.log(documentSlugs)
      $log.log('WritingCtrl -> setDocuments()', documents.length, '- to be saved:', saveable, '- to be deleted:');
      
      documents = story.documents.filter(function(d){
        return included.indexOf(d.slug) != -1;
      });

      if(saveable.length || deletable.length){
        $q.all(_.compact(
          saveable.map(function(d) {
            var p = CaptionFactory.save({
              story: story.id,
              document: d
            }, function(res){
              $log.warn('WritingCtrl -> setDocuments() CaptionFactory.save success', res);
              documents.push(res);
            }, function(err) {
              $log.warn('WritingCtrl -> setDocuments() CaptionFactory.save failed', err);
            }).promise;
            return p;
          })
          // .concat(deletable.map(function(d) {
          //   return CaptionFactory.save({
          //     story: story.id,
          //     document: d
          //   }, function(res){
          //     console.log('saved', res);
          //   }).promise
          // }))
        )).then(function(results){
          if(results.length){
            $scope.save();
            $scope.$parent.setDocuments(documents);
          } else {
            $scope.$parent.setDocuments(documents);
          }
        });
      } else{
        var indexed = _.keyBy(story.documents, 'slug'),
            docs = _(documents).uniq('slug').map(function(d){
              return indexed[d.slug];
            }).value();
        // console.log('indexed', docs)

        $scope.$parent.setDocuments(docs);
      }
    };

    $scope.references = [];
    $scope.lookups = [];// ref and docs and urls...

    // atthach the tag $tag for the current document.
    $scope.attachTag = function(tag) {
      $log.debug('WritingCtrl -> attachTag() tag', arguments);
      $scope.isSaving = true;
      $scope.lock();
      return StoryFactory.patch({id: story.id}, {
        tags: _.map($scope.displayedTags, 'id')
      }).$promise.then(function(res) {
        $log.debug('WritingCtrl -> attachTag() tag success', res);
        $scope.unlock();
        $scope.isSaving =false;
        return true;
      }, function(){
        // error
        return false;
      });
    };

    /*
      Detach a tag that was attached before.
    */
    $scope.detachTag = function(tag) {
      $log.debug('WritingCtrl -> detachTag() tag', arguments, $scope.displayedTags);
      $scope.isSaving = true;
      $scope.lock();
      
      return StoryFactory.patch({id: story.id}, {
        tags: _.map($scope.displayedTags, 'id')
      }).$promise.then(function(res) {
        $log.debug('WritingCtrl -> detachTag() tag success', res);
        $scope.unlock();
        $scope.isSaving =false;
        return true;
      }, function(){
        // error
        return false;
      });
    };

    $scope.suggestReferences = function(service) {
      if(!service)
        DocumentFactory.get(function(){
          console.log('list');
        });
    };
    

    $scope.save = function() {
      $log.debug('WritingCtrl @SAVE');
      $scope.$emit(EVENTS.MESSAGE, 'saving');
      $scope.isSaving = true;
      $scope.lock();
      StoryFactory.update({id: story.id}, angular.extend({
        title: $scope.title,
        abstract: $scope.abstract,
        contents: $scope.contents,
        date: $scope.date
      }, $scope.metadata), function(res) {
        $log.debug('WritingCtrl @SAVE: success');
        $scope.$emit(EVENTS.MESSAGE, 'saved');
        $scope.unlock();
        $scope.isSaving =false;
        // disable stopping change status, cfr core controller
        $scope.toggleStopStateChangeStart(false);
      });
    };

    // listener for save event.
    $scope.$on(EVENTS.SAVE, $scope.save);

    // listener for contents
    $scope.$watch('contents', function(v, p){
      if(!v || v == p)
        return;
      $scope.toggleStopStateChangeStart(true);
    });

    // enable stateChengestart by default
    // $scope.toggleStopStateChangeStart(false);
  });
  

/**
 * @ngdoc function
 * @name miller.directives:lazy
 * @description
 * # marked
 * transform markdown data in miller enhanced datas
 */
angular.module('miller')
  .directive('lazyImage', function ($log) {
    return {
      restrict : 'A',
      scope: {
        src: '='
      },
      link : function(scope, element, attrs) {
        $log.log(':::lazy on ',scope.src);

        element.addClass('lazy-box').css({
          'background-color': '#B7B2B2',
        }).html('<div class="loading">...</div>');
        
        function wakeup(){
          element.css({
            'background-size': attrs.size || 'cover',
            'background-position': 'center center',
            'background-repeat': 'no-repeat',
            'background-image': 'url(' + scope.src + ')'
          });
          element.find('.loading').hide();
        }

        scope.$watch('src', function(v){
          if(v)
            wakeup(); // or start watching for in page
        });

      }
    };
  });
/**
 * @ngdoc function
 * @name miller.directives:marked
 * @description
 * # marked
 * transform markdown data in miller enhanced datas
 */
angular.module('miller')
  .directive('markdown', function($compile, $log, $location){
    return {
      restrict : 'A',
      scope:{
        markdown: '=',
      },
      link : function(scope, element, attrs) {
        if(scope.markdown && scope.markdown.length) {
          element.html(marked(scope.markdown));
          $compile(element.contents())(scope);
        }
      }
    };
  })
  .directive('markedLanguage', function($compile, $log, $location){
    return {
      restrict : 'A',
      scope:{
        markedLanguage: '=',
      },
      link : function(scope, element, attrs) {
        if(scope.markdown && scope.markdown.length) {
          element.html(marked(scope.markdown));
          $compile(element.contents())(scope);
        }
      }
    };
  })
  .directive('marked', function ($compile, $log, $location, markedService) {
   return {
      restrict : 'A',
      scope:{
        marked: '=',
        settoc: '&',
        setdocs: '&',
        language: '='
      },
      link : function(scope, element, attrs) {
        var entities = [],
            renderer = new marked.Renderer(),

            annotable = false,
            ToC = [],
            docs = [],
            lp; // previous opened heading level, for ToC purposes

        scope.hash = function(what) {
          $location.hash(what);
        };

        scope.miller = function(url){
          // ?
        };
        
        function init(){
          if(!scope.marked || !scope.marked.length){
            $log.warn(':: marked init(), no text to be marked');
            return;
          }
          var rendered  = markedService(scope.marked, scope.language);

          element.html(rendered.html);
          $compile(element.contents())(scope);
          if(scope.settoc)
            scope.settoc({ToC:rendered.ToC});
          if(scope.setdocs)
            scope.setdocs({items:rendered.docs});
        }

        

        if(scope.language)
          scope.$watch('language', function(language){
            if(language)
              init();
          });
        else
          init();
      }
    };
  });
/**
 * @ngdoc function
 * @name miller.directives:lazy
 * @description
 * # marked
 * transform markdown data in miller enhanced datas
 */
angular.module('miller')
  .directive('mde', function ($log, $timeout, $modal,  $filter, DocumentFactory, StoryFactory, OembedSearchFactory, embedService, markedService, RUNTIME) {
    return {
      restrict: 'AE',
      scope: {
        mde: '=',
        settoc: '&',
        setdocs: '&'
      },
      templateUrl: RUNTIME.static + 'templates/partials/mde.html',
      link: function(scope, el, attributes){
        // active tab
        scope.activeStates = [];

        // preview enabled or disabled
        scope.isPreviewEnabled = false;

        // secretize bookmarks. Automatically clean the code sent to initialvalue
        // will set SetBookmarks 


        var simplemde,
            timer,
            timer_recompile,
            timer_preview,
            wand = el.find('.wand').hide(),
            textarea = el.find('textarea').hide(),
            toolbox =  el.find('.toolbox').hide(),
            lookups=[],
            referenceModal = $modal({
              scope: scope,
              title: 'h',
              template: RUNTIME.static + 'templates/partials/modals/mde-enrich.html',
              show: false
            });
            
        function init(){
          textarea.show();
          wand.show();
          toolbox.show();

          simplemde = new SimpleMDE({
            element: textarea[0],
            spellChecker: false,
            status: false,
            toolbar: false,
            toolbarTips: false,
            initialValue: scope.mde
          });

          // assign overlay
          // simplemde.codemirror.addOverlay({
          //     name: 'invisibles',
          //     token:  function nextToken(stream) {
          //         var ret,
          //             spaces  = 0,
          //             peek    = stream.peek() === ' ';

          //         if (peek) {
          //             while (peek && spaces < Maximum) {
          //                 ++spaces;

          //                 stream.next();
          //                 peek = stream.peek() === ' ';
          //             }

          //             ret = 'whitespace whitespace-' + spaces;
          //         } else {
          //             while (!stream.eol() && !peek) {
          //                 stream.next();

          //                 peek = stream.peek() === ' ';
          //             }

          //             ret = 'cm-eol';
          //         }

          //         return ret;
          //     }
          // });

          
          var cursor,
              pos,
              stat,
              followCursor,
              // table of contents hash. Are there differences?
              pcursor;// = simplemde.codemirror.display.find('.Codemirror-cursor');


          // listener codemirror@cursorActivity
          function move(){
            if(timer)
              clearTimeout(timer);

            timer = setTimeout(function(){

              if(simplemde.codemirror.display.cursorDiv.firstChild){
                // console.log('moving cruising', simplemde.codemirror.getSelection(), 'crui')
                
                cursor = {
                  top: simplemde.codemirror.display.cursorDiv.firstChild.offsetTop,
                  left: simplemde.codemirror.display.cursorDiv.firstChild.offsetLeft,
                  height: simplemde.codemirror.display.cursorDiv.firstChild.offsetHeight
                };
                wand.css('transform', 'translateY('+(cursor.top+cursor.height-20)+'px)');
                
                if(followCursor)
                  toolbox.css('transform', 'translate('+(cursor.left)+'px,'+(cursor.top)+'px)');

                // check cursor position: is it inside a BOLD or ITALIC?
                pos = simplemde.codemirror.getCursor("start");
                stat = simplemde.codemirror.getTokenAt(pos);
                // $log.log('     ', stat)
                scope.activeStates = (stat.type || '').split(' ');
                scope.$apply();
              }
            }, 20);
            

          }

          // // listener for the selection object.
          var _isSelection;
          function beforeSelectionChange(e, sel){
            var isSelection = (sel.ranges[0].head.ch - sel.ranges[0].anchor.ch) !== 0;
            // selection is on and it has changed. 
            if(isSelection && isSelection != _isSelection){
              toolbox.addClass('active');
            } else if(!isSelection && isSelection != _isSelection){
              toolbox.removeClass('active');
            }
            
            _isSelection = isSelection
          }

          

          /*
            Recompile with marked, analyzing the documents and
            the different stuff in the contents.
          */
          var _ToCHash,
              _docsHash;

          function recompile(){
            // $log.debug('::mde -> recompile() ...');
            var marked   = markedService(simplemde.value()),
                ToCHash = md5(JSON.stringify(marked.ToC)),
                docsHash = md5(_.map(marked.docs,'slug').join('--'));
            
            if(_ToCHash != ToCHash){
              $log.log('::mde -> recompile() items ToC:',marked.ToC.length, 'docs:', marked.docs.length, ToCHash);
              scope.settoc({items:marked.ToC});
            }
            if(_docsHash != docsHash){
              $log.log('::mde -> recompile() items docs:', _docsHash);
              scope.setdocs({documents: marked.docs});
            }
            scope.$apply();
            // apply toc hash not to reload twice
            _ToCHash = ToCHash;
            _docsHash = docsHash;
          }

          // listener codemirror@update
          // update event, recompile after n milliseconds
          function onUpdate(e){
            var value = simplemde.value();
            if(textarea.val() != value){
              scope.mde = value; // set model
              textarea.val(value); // get headers after some time
            }
            move();
            if(timer_recompile)
              clearTimeout(timer_recompile);
            timer_recompile = setTimeout(recompile, 500);  
          }

          // listener codemirror@changeEnd
          function onChange(e, change){
            var from = change.from;
            var text = change.text.join("\n");
            var removed = change.removed.join("\n");
            var to =  simplemde.codemirror.posFromIndex(simplemde.codemirror.indexFromPos(from) + text.length);

            simplemde.codemirror.markText(from, to, {
              className: 'mde-modified'
            })
          };

          // listener codemirror@focus
          function onFocus(e) {
            toolbox.show();
            wand.show()
          };
          // listener codemirror@focus
          function onBlur(e) {
            toolbox.hide();
            wand.hide();
          };
          // listener
          function beforeChange(){
            debugger
          }

          simplemde.codemirror.on('update', onUpdate);
          simplemde.codemirror.on('cursorActivity', move);
          simplemde.codemirror.on('beforeSelectionChange', beforeSelectionChange);
          simplemde.codemirror.on('beforeChange', beforeChange);
          simplemde.codemirror.on('change', onChange);
          // simplemde.codemirror.on('focus', onFocus);
          // simplemde.codemirror.on('blur', onBlur);
          
          // if a settoc, ask for recompiling
          if(scope.settoc)
            timer_recompile = setTimeout(recompile, 20);
        
        }

        // listen window event, instance specific
        var _isToolbarVisible;
        $(window).on('scroll.mde', function(){
          var toolbarOffset = el.offset().top - st,
              isToolbarVisible =  toolbarOffset > 100;

          if(!isToolbarVisible)
            toolbox.css('transform', 'translate(0px,'+(100 - toolbarOffset)+'px)');
          else if(isToolbarVisible!==_isToolbarVisible)
            toolbox.css('transform', 'translate(0px,0px)');
          

          _isToolbarVisible = isToolbarVisible;
        });

        // on destry, destroy scroll event
        scope.$on("$destroy", function(){
          $(window).off('scroll.mde');
        });

        /*
          Modal tabs
        */

        // open modal tab and store previously open tab in this scope.
        scope.setTab = function(tab){
          scope.tab = tab;
        };
        scope.tab = 'CVCE';

        // preview url
        scope.previewUrl = function(url){
          if(timer_preview)
            $timeout.cancel(timer_preview);
          // check url
          var regexp = /(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&&#37;@!\-\/]))?/;
          if(!regexp.test(url)){
            $log.error('::mde -> previewUrl() url provided:', url, 'is not valid');
            return false;
          }
          url = url.replace('#', '.hash.');
          timer_preview = $timeout(function(){
            $log.debug('::mde -> previewUrl() url:', url);
            scope.suggestMessage = '(loading...)';
            embedService.get(url).then(function(data){
              $log.debug(':: mde -> previewUrl() received:', data)
              scope.embed = data;
              scope.suggestMessage = '(<b>done</b>)';
            });
          }, 20);
        };

        // suggest from different archives, w timeout
        scope.suggestResults = [];
        scope.suggestMessage = '';
        scope.suggest = function(query, service){
          $log.log('::mde -> suggest()', scope.query, query, OembedSearchFactory);
          scope.suggestMessage = '(loading...)';
          // internal search
          if(service == 'favourite'){
            DocumentFactory.get({
              filters: JSON.stringify(query.length > 2? {contents__icontains: query}: {})
            },function(res){
              $log.log('::mde -> showReferenceModal documents loaded', res.results.length);

              scope.lookups = res.results;
              scope.suggestMessage = '(<b>' + res.count + '</b> results)';
            });
            return;
          }

          if(service == 'glossary') {
            var params = {
              tags__slug: 'glossary'
            }
            if(query.length > 2)
              params.contents__icontains = query;

            StoryFactory.get({
              filters: JSON.stringify(params)
            },function(res){
              $log.log('::mde -> showReferenceModal documents loaded', res.results.length);

              scope.glossary = res.results;
              scope.suggestMessage = '(<b>' + res.count + '</b> results)';
            });
            return;
          } 

          if(query.length < 3) {
            scope.suggestMessage = '(write something more)';
            scope.suggestResults = [];
            return;
          }

            // external search
          
          if(OembedSearchFactory[service])
            OembedSearchFactory[service](query).then(function(res){
              scope.suggestResults = res.data.results;
              scope.suggestMessage = '(<b>' + res.data.count + '</b> results)';
            });
          
        };

        // open
        scope.showReferenceModal = function(){
          if(scope.activeStates.indexOf("link") !== -1){
            $log.warn('oh dear, you should not click on it')
            return;
          }
          // if there is already a link, should add it.
          referenceModal.$promise.then(function(){
            $log.log('::mde -> showReferenceModal called');
            referenceModal.show();
          });
          
          DocumentFactory.get(function(res){
            $log.log('::mde -> showReferenceModal documents loaded', res.results.length);

            scope.lookups = res.results;
          });
          // console.log(simplemde)
          // debugger
        };

      

        scope.addDocument = function(type, contents, reference, url, embed){
          var slug;

          $log.debug('::mde -> addDocument() type:', type);

          if(type=='bibtex'){
            $log.debug('    reference:', bibtexParse.toJSON(reference));
            return;
          }

          if(type=='glossary'){
            referenceModal.hide();
            SimpleMDE.drawLink(simplemde,{
              // text: scope.selectedDocument.title,
              url: 'voc/' + scope.selectedDocument.slug
            });
            return;
          }
          // case it is an url
          if(type=='url'){
            if(!embed.title){
              referenceModal.hide();
              SimpleMDE.drawLink(simplemde,{
                url: url
              });
              return;
            }
            slug = $filter('slugify')(embed.title).substr(0,100);

            DocumentFactory.save({
              title: embed.title,
              contents: JSON.stringify(embed),
              type: (embed.type|| 'link').toLowerCase(),
              slug:  slug,
              url: url
            }, function(res){
              $log.debug('::mde -> addDocument() document saved:', res.slug, res.id, res.short_url);
              if(res.slug){
                referenceModal.hide();
                SimpleMDE.drawLink(simplemde,{
                  url: 'doc/' + res.slug
                });
              }
            }, function(err){
              // ignore duplicates (slug field) and put it directly.
              if(err.data.slug && _.keys(err.data).join('') == 'slug'){
                SimpleMDE.drawLink(simplemde,{
                  url: 'doc/' + slug
                });
              } else {
                $log.error('::mde -> addDocument() cannot save document', err);
              }
            });
            return;
          }

          if(!scope.selectedDocument) {
            $log.warn('::mde -> addDocument() no document selected');
            return;
          }

          if(type == 'CVCE'){
            slug = 'cvce/'+scope.selectedDocument.details.doi;
            $log.debug('::mde -> addDocument() doc:', slug);
            DocumentFactory.save({
              title: scope.selectedDocument.title,
              contents: JSON.stringify(scope.selectedDocument),
              type: (scope.selectedDocument.type|| 'link').toLowerCase(),
              slug:  slug,
              url: url
            }, function(res){
              $log.debug('::mde -> addDocument() document saved:', res.slug, res.id, res.short_url);
              if(res.slug){
                referenceModal.hide();
                SimpleMDE.drawLink(simplemde,{
                  url: 'doc/' + res.slug
                });
              }
            }, function(err){
              // debugger
              // ignore duplicates and put it directly.
              if(err.data.slug){
                $log.debug('::mde -> addDocument() document already saved:', slug);
                SimpleMDE.drawLink(simplemde,{
                  url: 'doc/' + slug
                });
              }
            });
            return;
          }

          // document type
          if(scope.selectedDocument.type == 'bibtex'){
            
            SimpleMDE.drawLink(simplemde,{
              // text: '('+ scope.selectedDocument.metadata.author + ' '+ scope.selectedDocument.metadata.year +')',
              url: 'doc/' + scope.selectedDocument.slug
            });
          }
          // the document has been selected.
          $log.debug('::mde -> addDocument() doc:', scope.selectedDocument);
          // lock ui
          // draw link at the end of the db
          referenceModal.hide();
          SimpleMDE.drawLink(simplemde,{
            url: 'doc/' + scope.selectedDocument.slug
          });
        };

        scope.selectDocument = function(doc){
          $log.log('::mde -> selectDocument()', doc);
          if(scope.selectedDocument)
            scope.selectedDocument.isSelected = false;
          if(scope.selectedDocument && (scope.selectedDocument.id == doc.id)){
            scope.isSomethingSelected = false;
            scope.selectedDocument = false;
          } else {
            doc.isSelected = true;
            scope.isSomethingSelected = true;
            scope.selectedDocument = doc;
          }
          
          
        };

        scope.action = function(action) {
          if(action == 'togglePreview'){
            scope.isPreviewEnabled = !scope.isPreviewEnabled;
          }
          SimpleMDE[action](simplemde);
        };
        
        // take into account custom font-face rendering.
        $timeout(init, 500);
        return;


      }
    };
  });