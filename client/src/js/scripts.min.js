angular.module("miller",["ui.router","ngResource","ngSanitize","ngCookies","ngTagsInput","mgcrea.ngStrap","monospaced.elastic","LocalStorageModule","pascalprecht.translate","ngDisqus","angular-embed","angular-embed.handlers","angularLazyImg","ngFileUpload"]).constant("LOCALES",{locales:{en_US:"English"},preferredLocale:"en_US"}).constant("EVENTS",{SAVE:"save",MESSAGE:"message",BAD_REQUEST:"bad_request",MARKDOWNIT_FULLSIZE:"markdownit_fullsize",MARKDOWNIT_RESOLVE:"markdownit_resolve"}).config(function($disqusProvider,RUNTIME){RUNTIME.settings.disqus&&$disqusProvider.setShortname(RUNTIME.settings.disqus)}).config(function($locationProvider){$locationProvider.hashPrefix("!")}).config(function(tagsInputConfigProvider,RUNTIME){tagsInputConfigProvider.setDefaults("tagsInput",{replaceSpacesWithDashes:!1,template:RUNTIME["static"]+"templates/partials/tag.input.html"}).setDefaults("autoComplete",{loadOnDownArrow:!0})}).config(function($translateProvider,RUNTIME){$translateProvider.useSanitizeValueStrategy("sanitize"),$translateProvider.useStaticFilesLoader({prefix:RUNTIME["static"]+"locale/locale-",suffix:".json"}),$translateProvider.preferredLanguage("en_US")}).config(function(localStorageServiceProvider){localStorageServiceProvider.setPrefix("miller")}).config(function($resourceProvider){$resourceProvider.defaults.stripTrailingSlashes=!1}).config(function($httpProvider){$httpProvider.defaults.xsrfCookieName="csrftoken",$httpProvider.defaults.xsrfHeaderName="X-CSRFToken",$httpProvider.interceptors.push(function($q,$rootScope,EVENTS){return{responseError:function(rejection){return 400==rejection.status&&$rootScope.$emit(EVENTS.BAD_REQUEST,rejection),$q.reject(rejection)}}})}).config(function($locationProvider){}).config(function(embedlyServiceProvider,RUNTIME){RUNTIME.oembeds.EMBEDLY_API_KEY&&embedlyServiceProvider.setKey(RUNTIME.oembeds.EMBEDLY_API_KEY)}).config(function($stateProvider,$urlRouterProvider,RUNTIME){$urlRouterProvider.otherwise("/"),$stateProvider.state("index",{url:"/",reloadOnSearch:!1,controller:"IndexCtrl",templateUrl:RUNTIME["static"]+"templates/index.html",resolve:{writings:function(StoryFactory){return StoryFactory.get({filters:JSON.stringify({tags__slug:"highlights"})}).$promise},news:function(StoryFactory){return StoryFactory.get({filters:JSON.stringify({tags__category:"blog"})}).$promise}}}).state("authors",{url:"/authors",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/authors.html",resolve:{items:function(ProfileFactory,$stateParams){return ProfileFactory.get({}).$promise},model:function(){return"profile"},factory:function(ProfileFactory){return ProfileFactory}}}).state("login",{url:"/login",reloadOnSearch:!1,controller:"LoginCtrl",templateUrl:RUNTIME["static"]+"templates/login.html"}).state("draft",{url:"/create",reloadOnSearch:!1,controller:"DraftCtrl",templateUrl:RUNTIME["static"]+"templates/draft.html"}).state("upload",{url:"/upload",reloadOnSearch:!1,controller:"UploadCtrl",templateUrl:RUNTIME["static"]+"templates/upload.html"}).state("uploaded",{url:"/uploaded/:storyId",reloadOnSearch:!1,controller:"UploadedCtrl",templateUrl:RUNTIME["static"]+"templates/uploaded.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.storyId}).$promise}}}).state("writing",{url:"/writing/:storyId",reloadOnSearch:!1,controller:"WritingCtrl",templateUrl:RUNTIME["static"]+"templates/draft.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.storyId}).$promise}}}),$stateProvider.state("author",{"abstract":!0,reloadOnSearch:!1,url:"/author/{username:[0-9a-zA-Z\\.-_]+}",controller:"AuthorCtrl",templateUrl:RUNTIME["static"]+"templates/author.html",resolve:{profile:function(ProfileFactory,$stateParams){return ProfileFactory.get({username:$stateParams.username}).$promise}}}).state("author.publications",{url:"/publications","abstract":!0,reloadOnSearch:!1,controller:function($scope){$scope.urls=RUNTIME.stories.writing},templateUrl:RUNTIME["static"]+"templates/author.publications.html"}).state("author.publications.drafts",{url:"/drafts",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,profile){return StoryFactory.get({filters:JSON.stringify({status:"draft",owner__username:profile.user.username})}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory}}}),_.each(RUNTIME.stories.writing,function(d){$stateProvider.state("author.publications."+d.name,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams,profile){return StoryFactory.get({filters:d.slug?JSON.stringify({tags__category:"writing",tags__slug:d.slug,authors__username__in:[profile.user.username]}):JSON.stringify({tags__category:"writing",authors__username__in:[profile.user.username]})}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory}}})}),$stateProvider.state("blog",{url:"/blog",reloadOnSearch:!1,"abstract":!0,controller:"BlogCtrl",templateUrl:RUNTIME["static"]+"templates/blog.html"}).state("blog.everything",{url:"",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({filters:JSON.stringify({tags__category:"blog"})}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory}}}).state("blog.events",{url:"/events",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({filters:JSON.stringify({tags__category:"blog",tags__slug:"event"})}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory}}}).state("publications",{url:"/publications","abstract":!0,reloadOnSearch:!1,controller:function($scope,$state){$scope.urls=RUNTIME.stories.writing,$state.params.slug&&($scope.slug=$state.params.slug)},templateUrl:RUNTIME["static"]+"templates/publications.html"}).state("publications.tags",{url:"/tags/:slug",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({filters:JSON.stringify({tags__slug:$stateParams.slug})}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory}}}),_.each(RUNTIME.stories.writing,function(d){$stateProvider.state("publications."+d.name,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({filters:d.slug?JSON.stringify({tags__category:"writing",tags__slug:d.slug}):JSON.stringify({tags__category:"writing"})}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory}}})}),$stateProvider.state("search",{url:"/search/:query",controller:function($scope,items){$scope.items=items.results},reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/search.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({id:"search",q:$stateParams.query}).$promise}}}),$stateProvider.state("story",{url:"/story/:postId",controller:"StoryCtrl",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/story.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.postId}).$promise}}}).state("page",{url:"/:name",controller:"PageCtrl",templateUrl:RUNTIME["static"]+"templates/md.html",resolve:{page:function(PageFactory,$stateParams){return PageFactory.get({name:$stateParams.name})}}})}),angular.module("miller").filter("prefixTemplate",function(RUNTIME){return function(input){return RUNTIME["static"]+input}}).filter("bibtex",function(){return function(text){return text?text.replace(/[\{\}]/g,""):""}}).filter("slugify",function(){return function(text){for(var strip=/[^\w\s-]/g,hyphen=/[-\s]+/g,slug=text.toLowerCase(),map={from:"àáäãâèéëêìíïîòóöôõùúüûñç·/_,:;",to:"aaaaaeeeeiiiiooooouuuunc------"},i=0,j=map.from.length;j>i;i++)slug=slug.replace(new RegExp(map.from.charAt(i),"g"),map.to.charAt(i));return slug.replace(strip,"").trim().replace(hyphen,"-")}}),angular.module("miller").factory("StoryFactory",function($resource){return $resource("/api/story/:id/",{},{update:{method:"PUT"},patch:{method:"PATCH"}})}).factory("StoryTagsFactory",function($resource){return $resource("/api/story/:id/tags/",{},{update:{method:"PUT"}})}).factory("StoryDocumentsFactory",function($resource){return $resource("/api/story/:id/documents/",{},{update:{method:"PUT"}})}).factory("ProfileFactory",function($resource){return $resource("/api/profile/:username/",{},{update:{method:"PUT"},patch:{method:"PATCH"}})}).factory("DocumentFactory",function($resource){return $resource("/api/document/:id/",{},{update:{method:"PUT"}})}).factory("CaptionFactory",function($resource){return $resource("/api/caption/:id/",{},{update:{method:"PUT"},patch:{method:"PATCH"}})}).factory("TagFactory",function($resource){return $resource("/api/tag/:id/",{},{update:{method:"PUT"}})}).factory("PageFactory",function($http,RUNTIME){return{get:function(params){return $http.get(RUNTIME["static"]+"pages/"+params.name+".md")}}}).service("QueryParamsService",function($filter){return function(queryparams){var params={};return queryparams.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(str,key,value){params[key]=decodeURIComponent(value)}),params}}).service("bibtexService",function($filter){return function(json){}}).service("markdownItService",function($filter){return function(value,language){var results,sections,md=new window.markdownit,linkIndex=0;if(results={md:value,html:"",ToC:[],docs:[],footnotes:{}},md.use(window.markdownitFootnote).use(window.markdownitContainer,"profile").use(window.markdownitContainer,"profile-committee").use(window.markdownitContainer,"profile-others"),md.renderer.rules.link_open=function(tokens,idx){var url=tokens[idx].attrGet("href");if(0===url.trim().indexOf("doc/")){var documents=url.trim().replace("doc/","").split(",");for(var i in documents)results.docs.push({_index:"link-"+linkIndex++,citation:tokens[idx+1].content,slug:documents[i]});return tokens[idx+1].content.length?'<a name="'+documents[0]+'" ng-click="fullsize(\''+url+"', 'doc')\"><span class=\"anchor-wrapper\"></span>":'<span type="doc" lazy-placeholder="'+documents[0]+'">'}if(0===url.trim().indexOf("voc/")){var terms=url.trim().replace("voc/","").split(",");for(var ind in terms)results.docs.push({_index:"link-"+linkIndex++,citation:tokens[idx+1].content,slug:terms[ind],type:"glossary"});return tokens[idx+1].content.length?(tokens[idx].attrSet("class","glossary"),'<a class="glossary" name="'+terms[0]+'" ng-click="fullsize(\''+url+"', 'voc')\"><span class=\"anchor-wrapper\"></span>"):'<span type="voc" lazy-placeholder="'+terms[0]+'">'+terms[0]}return'<a href="'+url+'" target="_blank">'},md.renderer.rules.link_close=function(tokens,idx){return tokens[idx-1].attrGet("href")?"</span>":"</a>"},md.renderer.rules.heading_open=function(tokens,idx){var text=tokens[idx+1].content,h={text:text,level:tokens[idx].tag.replace(/[^\d]/g,""),slug:$filter("slugify")(text)};return results.ToC.push(h),"<"+tokens[idx].tag+'><a name="'+h.slug+'" class="anchor" href="#'+h.slug+'"><span class="header-link"></span></a>'},console.log("rules",md.renderer.rules),md.renderer.rules.image=function(tokens,idx){var src=tokens[idx].attrGet("src"),title=tokens[idx].attrGet("title"),alt=tokens[idx].content;return 0===alt.indexOf("profile/")?'<div class="profile-thumb" style="background-image:url('+src+')"></div>':'<img src="'+src+'" title="'+title+'" alt="'+alt+'"/>'},md.renderer.rules.footnote_anchor=function(tokens,idx,options,env,slf){var caption=slf.rules.footnote_caption(tokens,idx,options,env,slf);return'<span style="float:left; margin-right: 10px">'+caption+"</span>"},md.renderer.rules.footnote_ref=function(tokens,idx,options,env,slf){var id=slf.rules.footnote_anchor_name(tokens,idx,options,env,slf),caption=slf.rules.footnote_caption(tokens,idx,options,env,slf);return'<span footnote="'+id+'" class="footnote-ref" caption="'+caption+'"></span>'},sections=_(value.split(/\s*[-_]{3,}\s*\n/)).value(),sections.length>1&&(results.footnotes=sections.pop(),value=sections.join("")),language){var candidate=_(value.split(/<!--\s*(lang:[a-zA-Z_]{2,5})\s*-->/)).compact().chunk(2).fromPairs().value();candidate["lang:"+language]&&(value=candidate["lang:"+language])}return results.html=md.render(value),results}}).factory("metadataFactory",function($log){return{parse:function(story){$log.info("[service] metadata.parse")},create:function(story){}}}).service("markedService",function($filter){return function(value,language){var renderer=new marked.Renderer,linkIndex=0,result="",ToC=[],docs=[],footnotes=[],sections=_(value.split(/\s*[-_]{3,}\s*/)).value();if(sections.length>1&&(footnotes=sections.pop(),value=sections.join("")),language){var candidate=_(value.split(/<!--\s*(lang:[a-zA-Z_]{2,5})\s*-->/)).compact().chunk(2).fromPairs().value();candidate["lang:"+language]&&(value=candidate["lang:"+language])}return renderer.heading=function(text,level){var h={text:text,level:level,slug:$filter("slugify")(text)};return ToC.push(h),"<h"+level+'><a name="'+h.slug+'" class="anchor" href="#'+h.slug+'"><span class="header-link"></span></a>'+text+"</h"+level+">"},renderer.link=function(url,boh,text){if(console.log("markedService link",url),0===url.trim().indexOf("doc/")){var documents=url.trim().replace("doc/","").split(",");for(var i in documents)docs.push({_index:"link-"+linkIndex++,citation:text,slug:documents[i]});return'<a name="'+documents[0]+'" ng-click="hash(\''+url+'\')"><span class="anchor-wrapper"></span>'+text+"</a>"}if(0===url.trim().indexOf("voc/")){var terms=url.trim().replace("voc/","").split(",");for(var j in terms)docs.push({_index:"link-"+linkIndex++,citation:text,slug:terms[j],type:"glossary"});return'<a class="glossary" name="'+terms[0]+'" ng-click="hash(\''+url+'\')"><span class="anchor-wrapper"></span>'+text+' <span class="icon icon-arrow-right-circle"></span></a>'}return"<a href="+url+">"+text+"</a>"},renderer.image=function(src,title,alt){return 0===(alt||"").indexOf("profile/")?'<div class="profile-thumb" style="background-image:url('+src+')"></div>':'<img src="'+src+'" title="'+title+'" alt="'+alt+'"/>'},result=marked(value,{renderer:renderer}),{html:result,md:value,ToC:ToC,docs:docs}}}),angular.module("miller").controller("AuthorCtrl",function($scope,$log,profile){$scope.isMe=$scope.user.username==profile.username,$scope.profile=profile,$log.log("AuthorCtrl ready, user:",$scope.user,profile)}),angular.module("miller").controller("BlogCtrl",function($scope,$log){$log.log("BlogCtrl ready")}),angular.module("miller").controller("CoreCtrl",function($rootScope,$scope,$log,$location,$anchorScroll,$state,$modal,$alert,localStorageService,$translate,$timeout,StoryFactory,DocumentFactory,TagFactory,RUNTIME,EVENTS){$log.log("CoreCtrl ready, user:",RUNTIME.user.username,RUNTIME),$scope.user=RUNTIME.user,$scope.hasToC=!1,$scope.ToCEnabled=!1,$scope.stopStateChangeStart=!1,$scope.toggleTableOfContents=function(){$scope.hasToC=!$scope.hasToC},$scope.locationPath="",$scope.toggleStopStateChangeStart=function(value){$log.debug("CoreCtrl > toggleStopStateChangeStart value:",value,"- current:",$scope.stopStateChangeStart),$scope.stopStateChangeStart="boolean"==typeof value?value:!$scope.stopStateChangeStart},$scope.setToC=function(ToC){$log.log("CoreCtrl > setToC data:",ToC),$scope.ToC=ToC},$scope.disableToC=function(){$scope.ToCDisabled=!0},$scope.search=function(searchquery){$log.log("CoreCtrl > search() searchquery:",searchquery),$state.go("search",{query:searchquery})},$scope.setDocuments=function(documents){if($log.log("CoreCtrl > setDocuments items n.:",documents.length,documents),$scope.documents=_.uniq(documents,"id"),$scope.qs.view)for(var i=0,j=$scope.documents.length;j>i;i++)if($scope.qs.view==$scope.documents[i].short_url){$scope.fullsized=$scope.documents[i],fullsizeModal.$promise.then(fullsizeModal.show);break}},$rootScope.resolve=function(slug,type,callback){if("voc"==type)$log.log("CoreCtrl > $scope.resolve [requesting] voc slug:",slug),StoryFactory.get({id:slug},callback);else{var matching=$scope.documents.filter(function(d){return d.slug==slug});matching.length?($log.log("CoreCtrl > $scope.resolve [cached] doc slug:",slug),callback(matching[0])):($log.log("CoreCtrl > $scope.resolve [requesting] doc slug:",slug),DocumentFactory.get({id:slug},callback))}},$scope.save=function(){$log.log("CoreCtrl > @SAVE ..."),$scope.$broadcast(EVENTS.SAVE)},$scope.update=function(key,value){$log.log("CoreCtrl > @UPDATE ",key,":",value," ...");var _d={};_d[key]=value,$scope.$broadcast(EVENTS.UPDATE,_d)},$scope.lock=function(){$log.log("CoreCtrl > lock .............")},$scope.unlock=function(){$log.log("CoreCtrl > unlock .............")},$scope.suggestTags=function(query,options){$log.log("CoreCtrl -> suggestTags",query,options);var filters=options||{};return TagFactory.get({filters:JSON.stringify(filters)}).$promise.then(function(response){return response.results})},$scope.breakingNews=[],$scope.setBreakingNews=function(breakingNews){$scope.breakingNews=breakingNews.slice(0,2).map(function(d){if(d.covers&&d.covers.length){var cover=d.covers[0];d.cover_url=_.get(cover,"metadata.thumbnail_url")||_.get(cover,"metadata.urls.Preview")||cover.url}return d})},$rootScope.$on("$stateChangeStart",function(e,state){if($log.log("CoreCtrl @stateChangeStart new:",state.name,"- previous:",$scope.state),$scope.stopStateChangeStart===!0){var answer=confirm("Are you sure you want to leave this page?");answer||e.preventDefault()}}),$rootScope.$on("$stateChangeSuccess",function(e,state){var h=$location.hash();$log.debug("CoreCtrl @stateChangeSuccess",state.name,h),$scope.ToC=[],$scope.documents=[],$scope.state=state.name,$timeout($anchorScroll,0),$scope.toggleStopStateChangeStart(!1)}),$scope.setHash=function(hash){$location.hash(hash)},$scope.changeLanguage=function(key){$scope.language=key,localStorageService.set("lang",$scope.language),$translate.use(key)},$scope.isWithoutAuthors=function(story){return 0!==story.authors.length},$scope.hasWritingPermission=function(user,story){return!!user.username&&user.username.length>0&&(user.is_staff||story.owner.username==user.username)};var fullsizeModal=$modal({scope:$scope,template:RUNTIME["static"]+"templates/partials/modals/fullsize.html",id:"dii",show:!1});$scope.$on("modal.hide",function(e,modal){"dii"==modal.$id&&$location.search("view",null)}),$rootScope.fullsize=function(slug,type){$log.log("CoreCtrl -> fullsize, doc slug:",slug,type),"doc"==type&&$location.search("view",slug)},window.onbeforeunload=function(event){if($scope.state&&-1!==["draft","writing"].indexOf($scope.state)){var message="Sure you want to leave?";return"undefined"==typeof event&&(event=window.event),event&&(event.returnValue=message),message}},$scope.$on("$locationChangeSuccess",function(e,path){$log.debug("CoreCtrl @locationChangeSuccess",path,$location),$scope.qs=$location.search(),$scope.locationPath=path,$scope.path=$location.path(),$scope.qs.view&&DocumentFactory.get({id:$scope.qs.view},function(res){$scope.fullsized=res,fullsizeModal.$promise.then(fullsizeModal.show)}),$scope.qs.view&&$scope.fullsized&&$scope.fullsized.short_url==$scope.qs.view?fullsizeModal.$promise.then(fullsizeModal.show):!$scope.qs.view&&$scope.fullsized&&fullsizeModal.hide()}),$rootScope.$on(EVENTS.BAD_REQUEST,function(e,rejection){$alert({placement:"top",title:"form errors",animation:"bounceIn",content:_(rejection.data).map(function(d,k){return"<div><b>"+k+"</b>: "+d+"</div>"}).value().join(""),show:!0,type:"error"})});var timer_event_message;$scope.$on(EVENTS.MESSAGE,function(e,message){$log.log("CoreCtrl @MESSAGE",message),$scope.message=message,timer_event_message&&$timeout.cancel(timer_event_message),timer_event_message=$timeout(function(){$scope.message=null},2e3)}),$scope.language=localStorageService.get("lang")||"en_US",$scope.changeLanguage($scope.language),StoryFactory.get({filters:JSON.stringify({tags__slug:"top"})},function(data){$log.info("CoreCtrl breaking news loaded",data),$scope.setBreakingNews(data.results)})}),angular.module("miller").controller("DraftCtrl",function($scope,$log,$state,localStorageService,StoryFactory,EVENTS){$log.debug("DraftCtrl welcome"),$scope.isDraft=!0,$scope.tags=[],$scope.save=function(){StoryFactory.save({},{title:$scope.title,"abstract":$scope["abstract"],contents:$scope.contents,status:"draft",tags:_.map($scope.tags,"id")},function(res){$scope.$emit(EVENTS.MESSAGE,"saved"),$log.log("DraftCtrl -> @EVENTS.SAVE saved:",res),$state.go("writing",{storyId:res.id})})},$scope.$on(EVENTS.SAVE,function(){$scope.$emit(EVENTS.MESSAGE,"saving"),$scope.save()}),$scope.attachTag=function(tag){$log.log("DraftCtrl -> attachTag",tag),$scope.tags.push(tag)},$scope.detachTag=function(tag){$log.log("DraftCtrl -> detachTag",tag);for(var i=0,j=$scope.tags.length;j>i;i++)if($scope.tags[i].id==tag.id){$scope.tags.splice(i,1);break}},_offsetables["writing-tools"]=$("#writing-tools")}),angular.module("miller").controller("IndexCtrl",function($scope,$log,writings,news){function tokenize(text,words){var sentences=text.split(/[\.!\?]/);return sentences}$log.debug("IndexCtrl welcome",writings,news),writings.results=writings.results.map(function(d){return d.excerpt=d.metadata["abstract"][$scope.language]?tokenize(d.metadata["abstract"][$scope.language],10)[0]:"",d}),$scope.coverstory=writings.results.shift(),$scope.otherstories=writings.results,$scope.coverstory&&$scope.coverstory.covers.length&&($scope.coverstory.cover=_.get(_.first($scope.coverstory.covers),"metadata.thumbnail_url")),$scope.news=news.results.map(function(d){return d.excerpt=d.metadata["abstract"][$scope.language]?tokenize(d.metadata["abstract"][$scope.language],10)[0]:"",d}),$log.debug("IndexCtrl welcome",$scope.news)}),angular.module("miller").controller("ItemsCtrl",function($scope,$log,items,model,factory,QueryParamsService){function tokenize(text,words){var sentences=text.split(/[\.!\?]/);return sentences}function normalizeItems(items){return items.map(function(d){if(!d.metadata["abstract"][$scope.language])return d;var sentences=tokenize(d.metadata["abstract"][$scope.language],10);return d.excerpt=sentences.shift(),sentences.length&&(d.difference=sentences.join(". ")),d})}$log.log("ItemsCtrl ready, n.:",items.count,"- items:",items),$scope.sync=function(res){$scope.isLoadingNextItems=!1,next=QueryParamsService(res.next||""),console.log("ItemsCtrl > sync()",next),$scope.count=res.count,$scope.items=($scope.items||[]).concat(normalizeItems(res.results)),$scope.missing=res.count-$scope.items.length},$scope.more=function(){return $scope.isLoadingNextItems?void $log.warn("is still loading"):($scope.isLoadingNextItems=!0,void factory.get(next,$scope.sync))},$scope.sync(items),$scope.$watch("language",function(v){v&&($scope.items=normalizeItems($scope.items))})}),angular.module("miller").controller("LoginCtrl",function($scope,$log){$log.log("LoginCtrl ready")}),angular.module("miller").controller("PageCtrl",function($scope,$log,page){$log.log("PageCtrl ready",page.status),$scope.md=page.data}),angular.module("miller").controller("StoryCtrl",function($rootScope,$scope,$log,story,StoryFactory,EVENTS){$scope.story=story,$scope.story.isWritable=$scope.hasWritingPermission($scope.user,$scope.story),$scope.layout="inline",$scope.setStatus=function(status){$log.debug("StoryCtrl -> setStatus - status:",status),$scope.user.is_staff&&($scope.$emit(EVENTS.MESSAGE,"saving"),StoryFactory.update({id:$scope.story.id},{title:$scope.story.title,status:status},function(res){$scope.story.status=res.status,$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock()}))},$scope.listener=function(event,data,callback){switch($log.log("StoryCtrl > listener, event:",event),event){case EVENTS.MARKDOWNIT_FULLSIZE:$rootScope.fullsize(data.slug,data.type);break;case EVENTS.MARKDOWNIT_RESOLVE:$rootScope.resolve(data.slug,data.type,callback)}},$log.log("StoryCtrl ready, title:",story.title,"isWritable:",$scope.story.isWritable),$scope.setDocuments=function(items){$log.log("StoryCtrl > setDocuments items n.:",items.length);var documents=[],unlinkeddocument=[];documents=_.compact([$scope.cover].concat(items.map(function(item){var _docs=story.documents.filter(function(doc){return doc.slug==item.slug});return _docs.length?angular.extend({citation:item.citation},_docs[0]):($log.error("StoryCtrl > cant't find any document matching the link:",item.slug),null)}))),$scope.$parent.setDocuments(documents.concat(unlinkeddocument))}}),angular.module("miller").controller("UploadCtrl",function($scope,$state,$log,Upload,EVENTS){$log.debug("UploadCtrl welcome"),$scope.uploadable={title:"","abstract":""},$scope.$watch("docx",function(v){v&&($log.debug("UploadCtrl @docx",v.name,v.size),$scope.uploadable.docx=v,$scope.uploadable.name=v.name,$scope.uploadable.size=v.size)}),$scope.upload=function(){return $log.debug("UploadCtrl -> upload()"),$scope.createForm.$valid?!$scope.uploadable.docx||$scope.uploadable.docx.$error?void $log.warn("UploadCtrl -> upload() cannot find a valid docx file"):void Upload.upload({url:"/api/story/",data:{title:$scope.uploadable.title,"abstract":$scope.uploadable["abstract"],source:$scope.uploadable.docx}}).then(function(res){$log.debug("UploadCtrl -> upload() status:",res.status),201==res.status&&($log.debug("UploadCtrl -> upload() status:","success!",res.data),$state.go("uploaded",{storyId:res.data.slug}))},null,function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);$log.log("progress: "+progressPercentage+"% "+evt.config.data.source.name)}):void $log.warn("UploadCtrl -> upload() errors:",$scope.createForm.$error)}}),angular.module("miller").controller("UploadedCtrl",function($scope,$log,story){$log.debug("UploadedCtrl welcome",story),$scope.story=story}),angular.module("miller").controller("WritingCtrl",function($scope,$log,$q,$modal,$filter,story,localStorageService,StoryFactory,StoryTagsFactory,StoryDocumentsFactory,CaptionFactory,DocumentFactory,EVENTS,RUNTIME){$log.debug("WritingCtrl writing title:",story.title,"-id:",story.id,"- current language:",$scope.language),$scope.isDraft=!1,$scope.isSaving=!1,$scope.story=story,"object"!=typeof $scope.story.metadata&&($scope.story.metadata={title:{},"abstract":{}}),["title","abstract"].forEach(function(d){$scope.language&&!$scope.story.metadata[d][$scope.language]&&($scope.story.metadata[d][$scope.language]=story[d])}),$scope.id=story.id,$scope.title=$scope.story.metadata.title[$scope.language],$scope["abstract"]=$scope.story.metadata["abstract"][$scope.language],$scope.contents=story.contents,$scope.date=story.date,$scope.keywords=_.filter(story.tags,{category:"keyword"}),$scope.displayedTags=_.filter(story.tags,function(d){return"keyword"!=d.category}),$scope.metadata={status:story.status,owner:story.owner},$scope.setStatus=function(status){$scope.metadata.status=status,$scope.save()};var documentSlugs=_.map(story.documents,"slug");$scope.setDocuments=function(documents){var saveable=documents.filter(function(d){return"glossary"!=d.type&&-1==documentSlugs.indexOf(d.slug)}),deletable=documents.filter(function(d){return-1==documentSlugs.indexOf(d.slug)}),included=_.map(documents,"slug");if($log.log("WritingCtrl -> setDocuments()",documents.length,"- to be saved:",saveable,"- to be deleted:"),documents=story.documents.filter(function(d){return-1!=included.indexOf(d.slug)}),saveable.length||deletable.length)$q.all(_.compact(saveable.map(function(d){var p=CaptionFactory.save({story:story.id,document:d},function(res){$log.warn("WritingCtrl -> setDocuments() CaptionFactory.save success",res),documents.push(res)},function(err){$log.warn("WritingCtrl -> setDocuments() CaptionFactory.save failed",err)}).promise;return p}))).then(function(results){results.length?($scope.save(),$scope.$parent.setDocuments(documents)):$scope.$parent.setDocuments(documents)});else{var indexed=_.keyBy(story.documents,"slug"),docs=_(documents).uniq("slug").map(function(d){return indexed[d.slug]}).value();$scope.$parent.setDocuments(docs)}},$scope.setCover=function(doc){$log.debug("WritingCtrl -> setCover() doc:",doc.id),$scope.isSaving=!0,$scope.lock(),StoryFactory.patch({id:story.id},{covers:[doc.id]}).$promise.then(function(res){$log.debug("WritingCtrl -> setCover() doc success",res),$scope.story.covers=[doc],$scope.unlock(),$scope.isSaving=!1})},$scope.references=[],$scope.lookups=[],$scope.attachTag=function(tag){return $log.debug("WritingCtrl -> attachTag() tag",arguments),$scope.isSaving=!0,$scope.lock(),StoryFactory.patch({id:story.id},{tags:_.compact(_.map($scope.displayedTags,"id").concat(_.map($scope.keywords,"id")))}).$promise.then(function(res){return $log.debug("WritingCtrl -> attachTag() tag success",res),$scope.unlock(),$scope.isSaving=!1,!0},function(){return!1})},$scope.detachTag=function(tag){return $log.debug("WritingCtrl -> detachTag() tag",arguments,$scope.displayedTags),$scope.isSaving=!0,$scope.lock(),StoryFactory.patch({id:story.id},{tags:_.map($scope.displayedTags,"id")}).$promise.then(function(res){return $log.debug("WritingCtrl -> detachTag() tag success",res),$scope.unlock(),$scope.isSaving=!1,!0},function(){return!1})},$scope.suggestReferences=function(service){service||DocumentFactory.get(function(){console.log("list")})};var coversModal=$modal({controller:"CoversModalCtrl",templateUrl:RUNTIME["static"]+"templates/partials/modals/covers.html",show:!1,scope:$scope});$scope.openCoversModal=function(){coversModal.$promise.then(function(){$log.log("WritingCtrl -> openCoversModal()"),coversModal.show()})},$scope.save=function(){$log.debug("WritingCtrl @SAVE"),$scope.$emit(EVENTS.MESSAGE,"saving"),$scope.isSaving=!0,$scope.lock(),StoryFactory.update({id:story.id},angular.extend({title:$scope.title,"abstract":$scope["abstract"],contents:$scope.contents,metadata:JSON.stringify($scope.story.metadata),date:$scope.date},$scope.metadata),function(res){$log.debug("WritingCtrl @SAVE: success"),$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock(),$scope.isSaving=!1,$scope.toggleStopStateChangeStart(!1)})},$scope.$on(EVENTS.SAVE,$scope.save),$scope.$watch("contents",function(v,p){v&&v!=p&&$scope.toggleStopStateChangeStart(!0)}),$scope.$watch("language",function(v,p){v&&v!=p&&(["title","abstract"].forEach(function(d){$scope[d]=$scope.story.metadata[d][v]||$scope[d]}),$log.log("WritingCtrl @language"))}),$scope.$watch("title",function(v){$scope.language&&($scope.story.metadata.title[$scope.language]=v)}),$scope.$watch("abstract",function(v){$scope.language&&($scope.story.metadata["abstract"][$scope.language]=v)})}),angular.module("miller").controller("CoversModalCtrl",function($scope,$log,QueryParamsService,DocumentFactory){$log.info("CoversModalCtrl ready with crazy scope, n. covers:",$scope.story.covers.length),$scope.tabs={favourite:{name:"favourite",items:[],count:0,next:void 0,isLoadingNextItems:!1,suggest:function(query,isNextPage){var $s=this;$log.debug("CoversModalCtrl - tab.favourite > suggest",$s),$s.isLoadingNextItems=!0,isNextPage||($s.next=void 0),DocumentFactory.get($s.next||{filters:JSON.stringify(query.length>2?{caption__story__owner__username:$scope.user.username,contents__icontains:query}:{caption__story__owner__username:$scope.user.username})},function(res){$log.debug("CoversModalCtrl - tab.favourite > suggest loaded n.docs:",res.results.length,"- total:",res.count,"-filters:",QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.debug("CoversModalCtrl - tab.favourite > init"),this.suggest($scope.query||"");
}},all:{name:"all",items:[],count:0,next:void 0,isLoadingNextItems:!1,suggest:function(query,isNextPage){var $s=this;$log.debug("CoversModalCtrl - tab.all > suggest",$s),$s.isLoadingNextItems=!0,isNextPage||($s.next=void 0),DocumentFactory.get($s.next||{filters:JSON.stringify(query.length>2?{contents__icontains:query}:{})},function(res){$log.debug("CoversModalCtrl - tab.all > suggest loaded n.docs:",res.results.length,"- total:",res.count,"-filters:",QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.debug("CoversModalCtrl - tab.all > init"),this.suggest($scope.query||"")}}},$scope.selectDocument=function(doc){$log.debug("CoversModalCtrl -> selectDocument() id:",doc.id),$scope.selectedDocument&&$scope.selectedDocument.id==doc.id?($scope.isSomethingSelected=!1,$scope.selectedDocument=!1):($scope.isSomethingSelected=!0,$scope.selectedDocument=angular.copy(doc))},$scope.addDocument=function(){return $scope.selectedDocument?($log.debug("CoversModalCtrl -> addDocument() id:",$scope.selectedDocument.id),void $scope.setCover($scope.selectedDocument)):void $log.warn("CoversModalCtrl -> addDocument() no document has been selected")},$scope.setTab=function(tabname){$log.debug("CoversModalCtrl -> setTab() tab.name:",tabname),$scope.tab=$scope.tabs[tabname],$scope.tab.init()},$scope.suggest=function(query){$log.debug("CoversModalCtrl -> suggest() q:",query),$scope.tab.suggest(query)},$scope.more=function(query,tab){$log.debug("CoversModalCtrl -> more()"),$scope.tab.suggest(query,!0)},$scope.setTab("favourite")}),angular.module("miller").controller("EnrichModalCtrl",function($timeout,$scope,$log,QueryParamsService,DocumentFactory,StoryFactory,OembedSearchFactory,embedService){$log.info("EnrichModalCtrl ready with crazy scope"),$scope.tabs={favourite:{name:"favourite",items:[],count:0,next:void 0,isLoadingNextItems:!1,suggest:function(query,keep){var $s=this;$log.log("tab.favourite > suggest",$s),$s.isLoadingNextItems=!0,keep||($s.next=void 0),DocumentFactory.get($s.next||{filters:JSON.stringify(query.length>2?{contents__icontains:query}:{})},function(res){$log.log("tab.favourite > suggest loaded n.docs:",res.results.length,QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.log("init",this),this.suggest($scope.query||"")}},glossary:{name:"glossary",items:[],count:0,next:void 0,suggest:function(query,keep){var $s=this;$log.log("tab.glossary > suggest",$s),$s.isLoadingNextItems=!0,keep||($s.next=void 0),StoryFactory.get($s.next||{filters:JSON.stringify(query.length>2?{contents__icontains:query,tags__slug:"glossary"}:{tags__slug:"glossary"})},function(res){$log.log("tab.glossary > suggest loaded n.docs:",res.results.length,QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.log("init",this),this.suggest($scope.query||"")}},url:{name:"url",items:[],suggest:function(url,keep){},init:function(){$log.log("init",this),this.suggest($scope.url||"")}},CVCE:{name:"CVCE",items:[],count:0,next:void 0,suggest:function(query,keep){var $s=this;return $log.log("tab.CVCE > suggest",$s),$s.isLoadingNextItems=!0,OembedSearchFactory.CVCE?void OembedSearchFactory.CVCE({q:query}).then(function(res){$log.log("tab.CVCE > suggest loaded n.docs:",res.data.results),$s.items=res.data.results,$s.count=res.data.count,$s.isLoadingNextItems=!1}):void $log.error("OembedSearchFactory.CVCE does not exist")},init:function(){$log.log("init",this),this.suggest($scope.query||"")}}};var timer_preview;$scope.previewUrl=function(url){timer_preview&&$timeout.cancel(timer_preview);var regexp=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&&#37;@!\-\/]))?/;return regexp.test(url)?(url=url.replace("#",".hash."),void(timer_preview=$timeout(function(){$log.debug("::mde -> previewUrl() url:",url),$scope.suggestMessage="(loading...)",embedService.get(url).then(function(data){$log.debug(":: mde -> previewUrl() received:",data),$scope.embed=data,$scope.suggestMessage="(<b>done</b>)"})},20))):($log.error("::mde -> previewUrl() url provided:",url,"is not valid"),$scope.suggestMessage="(url is not valid)",!1)},$scope.setTab=function(tabname){$log.log("EnrichModalCtrl -> setTab() tab.name:",tabname),$scope.tab=$scope.tabs[tabname],$scope.tab.init()},$scope.suggest=function(query){$log.log("EnrichModalCtrl -> suggest() q:",query),$scope.tab.suggest(query)},$scope.more=function(query,tab){$log.log("EnrichModalCtrl -> more()"),$scope.tab.suggest(query,!0)},$scope.setTab("favourite")}),angular.module("miller").directive("lazyImage",function($log){return{restrict:"A",scope:{src:"="},link:function(scope,element,attrs){function wakeup(){element.css({"background-size":attrs.size||"cover","background-position":"center center","background-repeat":"no-repeat","background-image":"url("+scope.src+")"}),element.find(".loading").hide()}$log.log(":::lazy on ",scope.src),element.addClass("lazy-box").css({"background-color":"#B7B2B2"}).html('<div class="loading">...</div>'),scope.$watch("src",function(v){v&&wakeup()})}}}).directive("lazyPlaceholder",function($log,$rootScope,$compile,RUNTIME){return{scope:{},templateUrl:RUNTIME["static"]+"templates/partials/placeholder.html",link:function(scope,element,attrs){var slug=element.attr("lazy-placeholder"),type=element.attr("type");scope.type=type,$log.log("⏣ lazy-placeholder on type:",type,"- slug:",slug),scope.complete=function(res){res?(scope.resolved=res,$log.log("⏣ lazy-placeholder resolved for type:",type,"- slug:",slug,res),$compile(element.contents())(scope)):$log.error("⏣ lazy-placeholder cannot find",slug)},$rootScope.resolve&&"string"==typeof slug&&$rootScope.resolve(slug,type,scope.complete),scope.fullsize=function(slug,type){$rootScope.fullsize(slug,type)}}}}),angular.module("miller").directive("footnote",function($compile){return{restrict:"A",scope:{caption:"=",footnote:"="},require:"^?markdownit",template:'<span class="footnote"><a ng-click="toggleFootnote()" style="cursor:pointer">{{caption}}</a><div class="footnote-contents" ng-show="isOpened"></div></span>',link:function(scope,element,attrs){var footnoteSl="#fn"+scope.caption+" p",contents=$(footnoteSl).clone(),wrapper=element.find(".footnote-contents");wrapper.html(contents),$compile(wrapper.contents())(scope),scope.isOpened=!1,scope.toggleFootnote=function(){console.log("::footnote > toggleFootnote"),scope.isOpened=!scope.isOpened},scope.fullsize=function(slug,type){scope.$parent.fullsize(slug,type)}}}}).directive("embedit",function($sce){return{restrict:"A",scope:{embedit:"=",stretch:"=",language:"="},link:function(scope,element,attrs){scope.language&&"object"==typeof scope.embedit?element.html(scope.embedit[scope.language]||""):element.html(scope.embedit),scope.stretch&&element.find("iframe").width("100%").height("100%"),scope.language&&"object"==typeof scope.embedit&&scope.$watch("language",function(language){"object"==typeof scope.embedit&&element.html(scope.embedit[scope.language]||"")})}}}).directive("markdownit",function($compile,$log,$location,markdownItService,EVENTS){return{restrict:"A",scope:{markdownit:"=",settoc:"&",setdocs:"&",language:"=",listener:"&"},link:function(scope,element,attrs){function parse(){if(!scope.markdownit||!scope.markdownit.length)return void $log.warn(":: markdownit parse() without any markdown text! Check the value for `markdownit`");var results=markdownItService(scope.markdownit,scope.language);element.html(results.html),$compile(element.contents())(scope),scope.settoc&&scope.settoc({ToC:results.ToC}),scope.setdocs&&scope.setdocs({items:results.docs})}scope.hash=function(what){$location.hash(what)},scope.fullsize=function(slug,type){scope.listener&&scope.listener({event:EVENTS.MARKDOWNIT_FULLSIZE,data:{slug:slug.replace(/^.*\//,""),type:type}})},scope.resolve=function(slug,type,notify){scope.listener&&scope.listener({event:EVENTS.MARKDOWNIT_RESOLVE,data:{slug:slug,type:type},callback:notify})},scope.language?scope.$watch("language",function(language){language&&parse()}):parse()}}}).directive("marked",function($compile,$log,$location,markedService){return{restrict:"A",scope:{marked:"=",settoc:"&",setdocs:"&",language:"="},link:function(scope,element,attrs){function init(){if(!scope.marked||!scope.marked.length)return void $log.warn(":: marked init(), no text to be marked");var rendered=markedService(scope.marked,scope.language);element.html(rendered.html),$compile(element.contents())(scope),scope.settoc&&scope.settoc({ToC:rendered.ToC}),scope.setdocs&&scope.setdocs({items:rendered.docs})}new marked.Renderer;scope.hash=function(what){$location.hash(what)},scope.miller=function(url){},scope.language?scope.$watch("language",function(language){language&&init()}):init()}}}),angular.module("miller").directive("mde",function($log,$timeout,$modal,$filter,DocumentFactory,StoryFactory,OembedSearchFactory,embedService,markedService,RUNTIME){return{restrict:"AE",scope:{mde:"=",settoc:"&",setdocs:"&"},templateUrl:RUNTIME["static"]+"templates/partials/mde.html",link:function(scope,el,attributes){function init(){function move(){timer&&clearTimeout(timer),timer=setTimeout(function(){simplemde.codemirror.display.cursorDiv.firstChild&&(cursor={top:simplemde.codemirror.display.cursorDiv.firstChild.offsetTop,left:simplemde.codemirror.display.cursorDiv.firstChild.offsetLeft,height:simplemde.codemirror.display.cursorDiv.firstChild.offsetHeight},wand.css("transform","translateY("+(cursor.top+cursor.height-20)+"px)"),followCursor&&toolbox.css("transform","translate("+cursor.left+"px,"+cursor.top+"px)"),pos=simplemde.codemirror.getCursor("start"),stat=simplemde.codemirror.getTokenAt(pos),scope.activeStates=(stat.type||"").split(" "),scope.$apply())},20)}function beforeSelectionChange(e,sel){var isSelection=sel.ranges[0].head.ch-sel.ranges[0].anchor.ch!==0;isSelection&&isSelection!=_isSelection?toolbox.addClass("active"):isSelection||isSelection==_isSelection||toolbox.removeClass("active"),_isSelection=isSelection}function recompile(){var marked=markedService(simplemde.value()),ToCHash=md5(JSON.stringify(marked.ToC)),docsHash=md5(_.map(marked.docs,"slug").join("--"));_ToCHash!=ToCHash&&($log.log("::mde -> recompile() items ToC:",marked.ToC.length,"docs:",marked.docs.length,ToCHash),scope.settoc({items:marked.ToC})),_docsHash!=docsHash&&($log.log("::mde -> recompile() items docs:",_docsHash),scope.setdocs({documents:marked.docs})),_ToCHash=ToCHash,_docsHash=docsHash}function onUpdate(e){var value=simplemde.value();textarea.val()!=value&&(scope.mde=value,textarea.val(value)),move(),timer_recompile&&clearTimeout(timer_recompile),timer_recompile=setTimeout(function(){recompile(),scope.$apply()},500)}function onChange(e,change){var from=change.from,text=change.text.join("\n"),to=(change.removed.join("\n"),simplemde.codemirror.posFromIndex(simplemde.codemirror.indexFromPos(from)+text.length));simplemde.codemirror.markText(from,to,{className:"mde-modified"})}function beforeChange(){}textarea.show(),wand.show(),toolbox.show(),simplemde=new SimpleMDE({element:textarea[0],spellChecker:!1,status:!1,toolbar:!1,toolbarTips:!1,initialValue:scope.mde});var cursor,pos,stat,followCursor,_isSelection,_ToCHash,_docsHash;simplemde.codemirror.on("update",onUpdate),simplemde.codemirror.on("cursorActivity",move),simplemde.codemirror.on("beforeSelectionChange",beforeSelectionChange),simplemde.codemirror.on("beforeChange",beforeChange),simplemde.codemirror.on("change",onChange),scope.settoc&&(timer_recompile=setTimeout(recompile,20))}scope.activeStates=[],scope.isPreviewEnabled=!1;var simplemde,timer,timer_recompile,timer_preview,wand=el.find(".wand").hide(),textarea=el.find("textarea").hide(),toolbox=el.find(".toolbox").hide(),referenceModal=$modal({scope:scope,title:"h",controller:"EnrichModalCtrl",template:RUNTIME["static"]+"templates/partials/modals/mde-enrich.html",show:!1});scope.setTab=function(tab){scope.tab=tab},scope.tab="CVCE",scope.previewUrl=function(url){timer_preview&&$timeout.cancel(timer_preview);var regexp=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&&#37;@!\-\/]))?/;return regexp.test(url)?(url=url.replace("#",".hash."),void(timer_preview=$timeout(function(){$log.debug("::mde -> previewUrl() url:",url),scope.suggestMessage="(loading...)",embedService.get(url).then(function(data){$log.debug(":: mde -> previewUrl() received:",data),scope.embed=data,scope.suggestMessage="(<b>done</b>)"})},20))):($log.error("::mde -> previewUrl() url provided:",url,"is not valid"),!1)};scope.suggestResults=[],scope.suggestMessage="",scope.suggest=function(query,service){if($log.log("::mde -> suggest()",scope.query,query,OembedSearchFactory),query.length<3)return scope.suggestMessage="(write something more)",void(scope.suggestResults=[]);if(scope.lookups=[],scope.count=0,scope.next=void 0,scope.suggestMessage="(loading...)","favourite"==service)return void DocumentFactory.get({filters:JSON.stringify(query.length>2?{contents__icontains:query}:{})},function(res){$log.log("::mde -> showReferenceModal documents loaded",res.results.length),scope.lookups=res.results,scope.suggestMessage="(<b>"+res.count+"</b> results)"});if("glossary"==service){var params={tags__slug:"glossary"};return query.length>2&&(params.contents__icontains=query),void StoryFactory.get({filters:JSON.stringify(params)},function(res){$log.log("::mde -> showReferenceModal documents loaded",res.results.length),scope.glossary=res.results,scope.suggestMessage="(<b>"+res.count+"</b> results)"})}OembedSearchFactory[service]&&OembedSearchFactory[service](query).then(function(res){scope.suggestResults=res.data.results,scope.suggestMessage="(<b>"+res.data.count+"</b> results)"})},scope.showReferenceModal=function(){return-1!==scope.activeStates.indexOf("link")?void $log.warn("oh dear, you should not click on it"):void referenceModal.$promise.then(function(){$log.log("::mde -> showReferenceModal called"),referenceModal.show()})},scope.addDocument=function(type,contents,reference,url,embed){var slug;return $log.debug("::mde -> addDocument() type:",type),"bibtex"==type?void $log.debug("    reference:",bibtexParse.toJSON(reference)):"glossary"==type?(referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:"voc/"+scope.selectedDocument.slug})):"url"==type?embed.title?(slug=$filter("slugify")(embed.title).substr(0,100),void DocumentFactory.save({title:embed.title,contents:JSON.stringify(embed),type:(embed.type||"link").toLowerCase(),slug:slug,url:url},function(res){$log.debug("::mde -> addDocument() document saved:",res.slug,res.id,res.short_url),res.slug&&(referenceModal.hide(),SimpleMDE.drawLink(simplemde,{url:"doc/"+res.slug}))},function(err){err.data.slug&&"slug"==_.keys(err.data).join("")?SimpleMDE.drawLink(simplemde,{url:"doc/"+slug}):$log.error("::mde -> addDocument() cannot save document",err)})):(referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:url})):scope.selectedDocument?"CVCE"==type?(slug="cvce/"+scope.selectedDocument.details.doi,$log.debug("::mde -> addDocument() doc:",slug),void DocumentFactory.save({title:scope.selectedDocument.title,contents:JSON.stringify(scope.selectedDocument),type:(scope.selectedDocument.type||"link").toLowerCase(),slug:slug,url:url},function(res){$log.debug("::mde -> addDocument() document saved:",res.slug,res.id,res.short_url),res.slug&&(referenceModal.hide(),SimpleMDE.drawLink(simplemde,{url:"doc/"+res.slug}))},function(err){err.data.slug&&($log.debug("::mde -> addDocument() document already saved:",slug),SimpleMDE.drawLink(simplemde,{url:"doc/"+slug}))})):("bibtex"==scope.selectedDocument.type&&SimpleMDE.drawLink(simplemde,{url:"doc/"+scope.selectedDocument.slug}),$log.debug("::mde -> addDocument() doc:",scope.selectedDocument),referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:"doc/"+scope.selectedDocument.slug})):void $log.warn("::mde -> addDocument() no document selected")},scope.selectDocument=function(doc){$log.log("::mde -> selectDocument()",doc.id),scope.selectedDocument&&scope.selectedDocument.id==doc.id?(scope.isSomethingSelected=!1,scope.selectedDocument=!1):(scope.isSomethingSelected=!0,scope.selectedDocument=angular.copy(doc))},scope.action=function(action){"togglePreview"==action&&(scope.isPreviewEnabled=!scope.isPreviewEnabled),SimpleMDE[action](simplemde)},$timeout(init,500)}}}),angular.module("miller").run(["$templateCache",function($templateCache){$templateCache.put("/static/templates/author.html","<h2>{{profile.user.first_name}} {{profile.user.last_name}} <!-- <span ng-if='isMe'>(you)</span> --></h2>\n<div class='type' translate='profile.type.author'></div>\n<div markdown='profile.bio|| \"...\"'></div>\n<div ui-view></div>"),$templateCache.put("/static/templates/author.publications.html",'<h3 ng-if=\'isMe\' translate="me.publications"></h3>\n<h3 ng-if=\'!isMe\' translate="latest publications"></h3>\n<!-- Nav tabs -->\n  <ul class=\'nav nav-tabs\'>\n    <li ng-repeat=\'link in urls\' role="presentation" ui-sref-active="active">\n      <a href ui-sref=\'author.publications.{{link.name}}({username: profile.username})\' aria-controls="home" role="tab" data-toggle="tab" translate="{{link.name}}"></a>\n    </li>\n    \n    <li ng-if=\'isMe\' ui-sref-active="active">\n      <a href ui-sref=\'author.publications.drafts({username: profile.username})\' aria-controls="home" role="tab" data-toggle="tab" translate="drafts"></a>\n    </li>\n  </ul>\n  \n\n<div ui-view></div>'),$templateCache.put("/static/templates/authors.html","\n<h2 translate=\"headline.authors\"></h2>\n<ul class=\"nav nav-tabs ng-scope\">\n</ul>\n<div ui-view>\n  <div class='post' ng-repeat='profile in items'>\n    <div class='wrapper'>\n      <div ng-if=\"!$first\" class=\"divider ng-scope\"></div>\n      <div class='tags'><span class='tag'>author</span></div>\n      <h3><a ui-sref=\"author.publications({username: profile.user.username})\">{{profile.user.first_name}} {{profile.user.last_name}}</a></h3>\n      <div class='type'>{{profile.user.username}}</div>\n      <div markdown='profile.bio|| \"...\"'></div>\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/blog.html",'<div class=\'row\'>\n<div class=\'col-lg-8\'>\n  <div>\n    <h1 translate="headline.blog.title"></h1>\n\n    <blockquote translate="headline.blog.abstract"></blockquote>\n\n    </div>\n  </div>\n</div>\n<!-- Nav tabs -->\n<ul class="nav nav-tabs" role="tablist">\n  <li role="presentation" ui-sref-active="active"><a href ui-sref=\'blog.everything\' aria-controls="home" role="tab" data-toggle="tab">everything</a></li>\n  <li role="presentation" ui-sref-active="active"><a href ui-sref=\'blog.events\' aria-controls="profile" role="tab" data-toggle="tab">events</a></li>\n</ul>\n\n<div ui-view></div>'),$templateCache.put("/static/templates/draft.html","\n\n<!-- <span class='btn-line-group'><button class='btn-line active' ng-click='save()'>{{isSaving? \"saving...\":\"save\"}}</button></span> -->\n\n\n<div class=\"row\">\n  <div ng-class='{\"col-md-8\": !isDraft && story.id}'>\n    <label>\n      <span translate=\"field.label.title\"></span>\n    </label>\n    <textarea id='draft-title' class='elastic-textarea' rows=\"1\" msd-elastic ng-model='title'   type='text' placeholder='Untitled'></textarea>\n    <label></label>\n    <label>\n      <span translate=\"field.label.abstract\"></span>\n    </label>\n    <textarea id='draft-abstract' class='elastic-textarea' rows=\"1\" msd-elastic ng-model='abstract' type='text' placeholder='abstract'></textarea>\n  \n  </div>\n  <div class=\"col-md-4\" ng-if='!isDraft && story.id'>\n    \n    <div class='cover-preview-wrapper'>\n      <label translate=\"field.label.cover\"></label>\n      <div class=\"cover-preview\" ng-repeat=\"document in story.covers\">\n        <div ng-if='document.metadata'>\n          <div ng-if='document.metadata.thumbnail_url' lazy-image src='document.metadata.thumbnail_url'></div>\n\n          <div ng-if='!document.metadata.thumbnail_url && document.metadata.urls.Preview' lazy-image src='document.metadata.urls.Preview'></div>\n\n          <div ng-if='!document.metadata.thumbnail_url && !document.metadata.urls.Preview' class='lazy-box'></div>\n\n          <div class='tile'>\n            <div class='title' embedit='document.metadata.title' language='language'></div>\n            <div class='copyright' embedit='document.metadata.copyright'></div>\n          </div>\n        </div>\n\n      </div>\n      <div class='btn-line-group'>\n        <button   class='btn-line' ng-click='openCoversModal()' translate=\"button.choosecover\"></button>\n      </div>\n    </div>\n  </div>\n</div>\n\n\n<div class='actions'>\n  <!-- <div ng-if='metadata.owner.is_staff' class='btn-line-group'> -->\n  \n  <div class='btn-line-group' ng-if='!isDraft && id'>\n    <button  class='btn-line' ui-sref=\"story({postId: id})\" translate=\"button.viewmode\"></button>\n  </div>\n  <div class='btn-line-group primary'>\n    <button ng-click='save()' class='btn-line'  translate=\"button.save\"></button>\n  </div>\n  <!-- </div> -->\n  \n</div>\n\n<div class='section' style='margin-bottom:20px'>\n  <div class=\"row\">\n    <div ng-class='{\"col-md-8\": !isDraft}' ng-if='!isDraft'>\n      <label translate=\"drafts.keywords.placeholder\"></label>\n  <tags-input class='tags-input' placeholder='{{\"drafts.keywords.placeholder\"| translate}}' on-tag-added='attachTag($tag)' on-tag-removed='detachTag($tag)' key-property='id' display-property='name' ng-model=\"keywords\" add-from-autocomplete-only=\"true\">\n    <auto-complete source=\"suggestTags($query, {category:'keyword'})\"></auto-complete>\n\n  </tags-input>\n    </div>\n\n    <div class=\"col-md-4\" ng-if='!isDraft && user.is_staff'>\n      <label translate=\"staff.drafts.tags.placeholder\"></label>\n      <tags-input class='tags-input'  on-tag-added='attachTag($tag)' on-tag-removed='detachTag($tag)' key-property='id' display-property='name' ng-model=\"displayedTags\" add-from-autocomplete-only=\"true\">\n        <auto-complete source=\"suggestTags($query, {category__in:['blog','writing', 'highlights']})\" ></auto-complete>\n\n      </tags-input>\n    </div>\n  </div>\n\n</div>\n\n<!-- <div class='authors' ng-if='!isDraft'>\nby <a href>{{metadata.owner.username}}</a>\n</div>\n<div class='authors' ng-if='isDraft'>\n  <div ng-if='user.username'>\n    by <a href>{{user.username}}</a>\n  </div>\n  <div ng-if='!user.username'>\n    by <a href>anonymous</a>\n  </div>\n</div> -->\n\n<!-- <div ng-if='!isDraft'>\n  <form class=\"form-inline\">\n    <div class=\"form-group\">\n      <label translate='date'></label>\n      <input type=\"text\" class=\"form-control\" ng-model=\"date\" name=\"date\" data-max-date=\"today\" timezone='UTC' bs-datepicker data-autoclose=\"1\">{{date}}\n    </div>\n  </form>\n</div> -->\n\n<div id=\"draft-contents\">\n  \n  <div style='min-height: 50px; position:relative'>\n      <!-- <medium-editor ng-model='contents' bind-options=\"mediumOptions\"></medium-editor> -->\n      \n      <div mde='contents' setdocs='setDocuments(documents)' settoc='setToC(items)'></div>\n      \n  </div>\n</div>"),$templateCache.put("/static/templates/events.html",'<h2>events</h2>\n<!-- Nav tabs -->\n<ul class="nav nav-tabs" role="tablist">\n  <li role="presentation" ui-sref-active="active"><a href ui-sref=\'events.everything\' aria-controls="home" role="tab" data-toggle="tab">everything</a></li>\n  <li role="presentation" ui-sref-active="active"><a href ui-sref=\'events.events\' aria-controls="profile" role="tab" data-toggle="tab">working seminars</a></li>\n</ul>\n\n<div ui-view></div>'),$templateCache.put("/static/templates/index.html","\n<div class=\"row\">\n  <div class=\"col-md-8\">\n\n    <!-- CONVER STORY -->\n    <div class=\"coverstory story lite\">\n      <div class=\"tags\" ng-if=\"coverstory.tags.length\">\n        <span class=\"tag\" ng-repeat='tag in coverstory.tags|filter:{ category: \"writing\" }' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n      </div>\n\n      <h3><a href ui-sref=\"story({postId: coverstory.slug})\" embedit='coverstory.metadata.title' language='language'></a></h3>\n      <blockquote>{{coverstory.excerpt}} <a href ui-sref=\"story({postId: coverstory.slug})\"><span class='icon-arrow-right-circle'></span></a></blockquote>\n      <div class='authors' ng-if=\"coverstory.authors.length\">\n        by <span ng-repeat='author in coverstory.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n      </div>\n      <div class='authors' ng-if=\"coverstory.authors.length == 0\">\n        edited by <span onload='author = coverstory.owner' ng-init='$single=true' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n      </div>\n      <div ng-if='coverstory.cover' class='cover-wrapper'>\n        <div class='cover' style='background-size: cover; height:300px; background-image:url({{coverstory.cover}})'></div>\n      </div>\n\n      \n    </div>\n\n    \n    <div class=\"row\">\n    <!-- REMAINING STORIES -->\n      <div ng-repeat='story in otherstories' class=\"col-md-6\">\n        <div class=\"coverstory other\">\n          <div class=\"divider\"></div>\n          <div class=\"tags\" ng-if=\"story.tags.length\">\n            <span  class='tag' ng-repeat='tag in story.tags|filter:\"public\"' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n          </div>\n          <h4><a href ui-sref=\"story({postId: story.slug})\" embedit='story.metadata.title' language='language'></a></h4>\n          \n          <blockquote class=\"reduced\">{{story.excerpt}} <span class='icon-arrow-right-circle'></span></blockquote>\n          <div class='authors' ng-if=\"story.authors.length\">\n            by <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n          </div>\n        </div>\n      </div>\n    </div>\n\n  </div>\n  <div class=\"col-md-4\">\n    <div ng-repeat='story in news'>\n        <div class=\"coverstory news\">\n          <div ng-if='!$first' class=\"divider\"></div>\n          <div class=\"date\">{{story.date_created|date:'mediumDate'}}</div>\n          <h4><a href ui-sref=\"story({postId: story.slug})\" embedit='story.metadata.title' language='language'></a></h4>\n\n          <div class='authors' ng-if=\"story.authors.length\">\n            by <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n          </div>\n          <div class='authors' ng-if=\"story.authors.length == 0\">\n            edited by <span onload='author = story.owner' ng-init='$single=true' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n          </div>\n          <blockquote class=\"reduced\">{{story.excerpt}} <span class='icon-arrow-right-circle'></span></blockquote>\n          \n        </div>\n      </div>\n    </div>\n\n  </div>\n</div>"),$templateCache.put("/static/templates/items.html","<div ng-if='count == 0' translate='items.empty'></div>\n<div ng-repeat='story in items' ng-include='\"templates/partials/story.html\"|prefixTemplate'></div>\n\n<div style='text-align: center'>\n  <div ng-if='items.length > 0 && items.length < count' class=\"btn-line-group primary\">\n    <button class='btn-line' ng-click='more()'>\n      <span ng-if='!isLoadingNextItems'>\n        <span translate='button.more'></span>\n        <span translate='missing' translate-values=\"{count: missing}\"></span>\n      </span>\n      <span ng-if='isLoadingNextItems' translate='button.loading'></span>\n    </button>\n  </div>\n  <!-- when count equals item length, we are at the end -->\n</div>"),$templateCache.put("/static/templates/login.html","login\n\n<div class='btn-group'>\n  <a href='/auth/twitter' class='btn btn-default'>connect with twitter</a>\n  <a  class='btn btn-default'>connect with google</a>\n</div>\n"),$templateCache.put("/static/templates/md.html","<div class='row'>\n  <div class='col-lg-8'>\n    <div markdownit='md' language='language' settoc='setToC(ToC)'></div>\n  </div>\n</div>"),$templateCache.put("/static/templates/publications.articles.html","publications.articles.html"),$templateCache.put("/static/templates/publications.html",'<div class=\'row\'>\n<div class=\'col-lg-8\'>\n  <div>\n    <h1 translate="headline.publications.title"></h1>\n\n    <blockquote translate="headline.publications.abstract"></blockquote>\n\n    </div>\n  </div>\n</div>\n\n\n<!-- Nav tabs -->\n<ul class=\'nav nav-tabs\'>\n  <li ng-repeat=\'link in urls\' role="presentation" ui-sref-active="active">\n    <a href ui-sref=\'publications.{{link.name}}\' aria-controls="home" role="tab" data-toggle="tab" translate="state.publications.{{link.name}}.label"></a>\n  </li>\n  <li ng-if=\'slug\' role="presentation" ui-sref-active="active" >\n    <a href ui-sref=\'publications.tags({slug: slug})\' aria-controls="home" role="tab" data-toggle="tab">/filter: <b>{{slug}}</b>/</a>\n  </li>\n</ul>\n\n\n<div ui-view></div>\n<!-- <div class=\'row\'>\n  \n  <div class=\'col-md-4\'>\n    <h2 class=\'no-margin-top\' translate=\'state.{{state}}.title\'></h2>\n    <p class="small" translate=\'state.{{state}}.abstract\'></p>\n  </div>\n  <div class=\'col-md-8\'>\n    <div ui-view></div>\n  </div>\n</div> -->\n'),$templateCache.put("/static/templates/search.html",'<div class=\'row\'>\n  <div class=\'col-md-8\'>\n\n  search: {{query}}\n  </div>\n</div>\n<!-- Nav tabs -->\n<ul class=\'nav nav-tabs\'>\n</ul>\n<div>\n  <div ng-repeat="story in items">\n    <div class="story lite">\n      <div class="coverstory other">\n        <div class="divider"></div>\n        <div class="tags" ng-if="story.tags.length">\n          <span  class=\'tag\' ng-repeat=\'tag in story.tags|filter:"public"\' ng-include=\'"templates/partials/tag.html"|prefixTemplate\'></span>\n        </div>\n        <h4><a href ui-sref="story({postId: story.id})">{{story.title}}</a></h4>\n        \n        <blockquote class="reduced">\n            <div embedit=\'story.matches.highlights\'></div>\n            <span class=\'icon-arrow-right-circle\'></span>\n        </blockquote>\n        <div class=\'authors\' ng-if="coverstory.authors.length">\n          by <span ng-repeat=\'author in coverstory.authors\' ng-include=\'"templates/partials/author.html"|prefixTemplate\'></span>\n        </div>\n      </div>\n    </div>\n\n  </div>\n</div>'),$templateCache.put("/static/templates/story.html","<div class=\"story\">\n  <div class=\"actions\" ng-if='story.isWritable'>\n    <div class='btn-line-group primary'>\n      <button  class='btn-line' nref ui-sref='writing({storyId:story.id})'>edit</button>\n    </div>\n\n    <div ng-if='user.is_staff' class='btn-line-group'>\n      <button class='btn-line' ng-click='setStatus(\"draft\")' ng-class='{\"active warning\": story.status==\"draft\"}' translate=\"story.status.draft\"></button>\n      <button class='btn-line' ng-click='setStatus(\"public\")' ng-class='{\"active\": story.status==\"public\"}' translate=\"story.status.public\"></button>\n    </div>\n\n  </div>\n  <div class='row'>\n    <div class='col-md-8'>\n      <div class='overlay'>\n        \n\n        <div class=\"tags\" >\n          <span ng-if=\"story.tags.length\" class='tag sans-serif' ng-repeat='tag in story.tags|filter:\"public\"' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n          \n        </div>\n        <div class='authors' ng-if=\"story.authors.length\">\n          by <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n        </div>\n        <h1 embedit='story.metadata.title' language='language'></h1>\n\n\n        <blockquote embedit='story.metadata.abstract' language='language'></blockquote>\n        \n        <div ng-if='story.covers.length' class=\"cover\">\n          <div ng-repeat='document in story.covers'>\n            <div ng-include='\"templates/partials/document.image.html\"|prefixTemplate'></div>\n            <div ng-include='\"templates/partials/document.metadata.html\"|prefixTemplate''></div>\n          </div>\n        </div>\n        \n        <div class=\"contents\">\n         <div markdownit='story.contents' listener='listener(event, data, callback)' settoc='setToC(ToC)' setdocs='setDocuments(items)'></div>\n        </div>\n\n        <div style='margin-top: 50px' disqus=\"story.slug\"></div>\n      </div>\n    </div>\n  </div>\n</div>\n"),
$templateCache.put("/static/templates/upload.html",'<div class="row">\n  <div class="col-lg-8">\n    <div>\n      <h1 translate="upload.title" class="ng-scope">Publications</h1>\n\n      <blockquote translate="upload.description" class="ng-scope"></blockquote>\n\n      </div>\n    </div>\n  </div>\n</div>\n \n\n<div ngf-no-file-drop>File Drag/Drop is not supported for this browser</div>\n\n<div class=\'drop-box-form-wrapper\'>\n  <form name="createForm" novalidate class="simple-form">\n    <label>\n      <span class="number" ng-class=\'{"active": createForm.utitle.$valid, "error": createForm.utitle.$dirty && !createForm.utitle.$valid}\'>1</span>\n      <span translate="field.label.upload.title"></span>\n    </label>\n    <textarea id=\'draft-title\' class=\'elastic-textarea\' rows="1" msd-elastic ng-model=\'uploadable.title\' name=\'utitle\' required type=\'text\' placeholder=\'Untitled\'></textarea>\n    \n    <label>\n      <span class="number" ng-class=\'{"active": createForm.uabstract.$valid, "error": createForm.uabstract.$dirty && !createForm.uabstract.$valid}\'>2</span>\n      <span translate="field.label.upload.abstract"></span>\n    </label>\n    <textarea id=\'draft-abstract\' class=\'elastic-textarea\' rows="1" msd-elastic ng-model=\'uploadable.abstract\' name=\'uabstract\' required type=\'text\' placeholder=\'abstract\'></textarea>\n\n    <label>\n      <span class="number" ng-class=\'{"active": uploadable.size}\'>3</span>\n      <span translate="field.label.upload.docx"></span>\n    </label>\n    <div ng-show=\'!uploadable.size\'>\n    <div ngf-drop ngf-select ng-model="docx" class="drop-box sans-serif" \n    ngf-drag-over-class="\'dragover\'" ngf-multiple="false" ngf-allow-dir="true"\n    accept="application/vnd.openxmlformats-officedocument.wordprocessingml.document" \n    ngf-pattern="application/vnd.openxmlformats-officedocument.wordprocessingml.document">Drop docx or click to upload</div>\n    </div>\n    <div ng-if="uploadable.size" class="uploadable">\n      <span class=\'icon-doc\'></span> \n      <span class=\'sans-serif\'>{{uploadable.name}}</span>\n      <span class="size">{{uploadable.size}}</span>\n    </div>\n\n    <div class=\'button-wrapper\'>\n      <span class="number" ng-class=\'{"active": createForm.$valid && uploadable.size}\'>4</span>\n      <div class=\'btn-line-group\' ng-class=\'{"primary": createForm.$valid && uploadable.size}\'>\n        <button class=\'btn-line\' type="submit" ng-click="upload()">\n          <span ng-if=\'createForm.$valid && uploadable.size\' translate=\'button.upload.story\'></span>\n          <span ng-if=\'!createForm.$valid || !uploadable.size\' translate-values=\'{ steps: (3 - +createForm.utitle.$valid - +createForm.uabstract.$valid - +!!uploadable.size)}\' translate=\'upload.missing.steps\'></span>\n        </button>\n      </div>\n    </div>\n    \n  </form>\n  \n</div>'),$templateCache.put("/static/templates/uploaded.html",'<div class="row">\n  <div class="col-lg-8">\n    <div>\n      <h1 translate="upload.success.title" class="ng-scope">Your content has been submitted</h1>\n\n      <blockquote translate="upload.success.description" class="ng-scope"></blockquote>\n\n      <div ng-include=\'"templates/partials/story.html"|prefixTemplate\'></div>\n\n      </div>\n    </div>\n  </div>\n</div>'),$templateCache.put("/static/templates/partials/author.html","<a class='author' ui-sref='author.publications.all({username:author.username})'>{{author.first_name}} {{author.last_name}}</a>{{$single || $last? '':', '}}"),$templateCache.put("/static/templates/partials/breakingNews.html","<div class=\"wrapper\" style='    background-size: cover; background-image: url({{news.cover_url}})'>\n  <div class='overlay'>\n    <div class=\"type\">\n      <span ng-repeat='tag in news.tags | filter:{ category: \"writing\" }' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n    </div>\n    <h3><a ui-sref=\"story({postId: news.slug})\" embedit='news.metadata.title' language='language'></a></h3>  \n  </div>\n</div>"),$templateCache.put("/static/templates/partials/document.html","\n<div class='doc doc-{{document.type}} {{document.isSelected?\"active\":\"\"}}' ng-click='selectDocument(document)'>\n  <div class='divider'>&nbsp;</div>\n  \n  <div ng-if='document.type==\"image\"' ng-include='\"templates/partials/document.image.html\"|prefixTemplate'></div>\n\n  <div ng-if='document.type==\"photo\"' ng-include='\"templates/partials/document.photo.html\"|prefixTemplate'></div>\n\n  <div ng-if='document.type==\"rich\"' ng-include='\"templates/partials/document.rich.html\"|prefixTemplate'></div>\n\n    <div ng-if='document.type==\"link\" && document.metadata.thumbnail_url' ng-include='\"templates/partials/document.image.html\"|prefixTemplate'></div>\n\n  <div ng-if='document.metadata' ng-include='\"templates/partials/document.metadata.html\"|prefixTemplate'></div>\n\n      <!-- this element has fixed height. -->\n      <div ng-if='document.type==\"video-cover\"'>\n        \n        <div class='caption reference' markdown='document.metadata.reference.fr'></div>\n        <div class='copyright'>{{document.copyrights}}</div>\n        \n      </div>\n\n      <div ng-if='document.type==\"picture\"' lazy-image src='document.src'></div>\n\n      <div ng-if='document.type==\"pdf\"' lazy-image src='document.snapshot'></div>\n      \n\n      <blockquote ng-if='document.citation' markdown='document.citation'></blockquote>\n\n\n      \n      <div ng-if='!document.metadata'>\n        <div ng-if='document.title' class='title'>{{document.title}}</div>\n        <div ng-if='document.caption' class='caption'>{{document.caption}}</div>\n        <div ng-if='document.copyrights' class='copyright'>{{document.copyrights}}</div>\n        \n      </div>\n\n      <div ng-if='document.type==\"bibtex\"'>\n        <div class='caption'>\n          <span ng-if='document.metadata.author'>{{document.metadata.author|bibtex}},</span>\n          <span ng-if='document.metadata.editor'>{{document.metadata.editor|bibtex}}</span>(edited by)</span> \n          \n          <em>{{document.metadata.title|bibtex}}</em>\n          <span>{{document.metadata.publisher|bibtex}}</span>\n          <span ng-if='document.metadata.year'>, <span>{{document.metadata.year|bibtex}}</span> \n        </div>\n      </div>\n\n      <div ng-if='document.type!=\"bibtex\" && document.metadata.title'>\n        <div class='caption' markdown='document.metadata.title'></div>\n        <div ng-if='document.metadata.reference' class='caption reference' markdown='document.metadata.reference'></div>\n        <div ng-if='document.metadata.copyright' class='copyright' markdown='document.metadata.copyright'></div>\n        <div ng-if='document.metadata.author_name' class='copyright'>\n          <a ng-href='{{document.metadata.author_url}}' target='_blank' markdown='document.metadata.author_name'></a>\n        </div>\n      </div>\n\n    </div>"),$templateCache.put("/static/templates/partials/document.image.html","<div class='image-wrapper'>\n  <!-- <div ng-if='document.metadata.urls' lazy-image src='document.metadata.urls.Preview' size='contain'></div>\n -->\n  <img ng-if='!document.metadata.thumbnail_url && document.metadata.urls.Preview' lazy-img='{{document.metadata.urls.Preview}}' />\n\n  <img ng-if='document.metadata.thumbnail_url' src='{{\"images/spinner.gif\"|prefixTemplate}}' lazy-img='{{document.metadata.thumbnail_url}}' />\n</div>"),$templateCache.put("/static/templates/partials/document.metadata.html","<div class='metadata'>\n  <div ng-if='document.metadata.reference' embedit='document.metadata.reference' language='language'></div>\n  <div>\n    <span embedit='document.metadata.title' language='language'></span>\n    <a ng-if='!document.metadata.reference && document.metadata.title' ng-click='fullsize(document.slug, \"doc\")' translate='document.preview'></a>\n  </div>\n  \n  <div ng-if='document.metadata.copyright' embedit='document.metadata.copyright' language='language'></div>\n\n  <div>\n    <span ng-if='document.metadata.author_name'>\n      <span translate='author'></span>\n      <a ng-href='{{document.metadata.author_url}}' target='_blank'>{{document.metadata.author_name}}</a>\n    </span>\n    <span ng-if='document.metadata.provider_name'>\n      <span translate='source'></span>:\n      <a ng-href='{{document.metadata.provider_url}}' target='_blank'>{{document.metadata.provider_name}}</a>\n    </span>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/document.photo.html","<div class='image-wrapper'>\n  <!-- <div ng-if='document.metadata.urls' lazy-image src='document.metadata.urls.Preview' size='contain'></div>\n -->\n  <img src='images/spinner.gif' lazy-img='{{document.metadata.media_url}}' />\n</div>"),$templateCache.put("/static/templates/partials/document.placeholder.html","<div onload='document=resolved' ng-include='\"templates/partials/document.html\"|prefixTemplate' ></div>"),$templateCache.put("/static/templates/partials/document.rich.html","<div class='iframe-wrapper' ng-class='{\"with-thumbnail\": document.metadata.thumbnail_url}'>\n  \n  <a class='toggle-preview' href ng-click='__isIntoViewport = !__isIntoViewport'><span class='icon icon-eye'></span></a>\n  <div class='iframe-viewport' ng-class='{\"active\":__isIntoViewport}'>\n    <img ng-if='document.metadata.thumbnail_url' src='{{\"images/spinner.gif\"|prefixTemplate}}' lazy-img='{{document.metadata.thumbnail_url}}' />\n    <div ng-if='__isIntoViewport' style='height: 100%' stretch='true' embedit='document.metadata.html' language='language'></div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/mde.html","<div class='mde'>\n  <div class='toolbox'> \n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"strong\") != -1?\"active\": \"\"}}' ng-click='action(\"toggleBold\")'>B</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"em\") != -1?\"active\": \"\"}}' style='font-style:italic' ng-click='action(\"toggleItalic\")'>I</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"header-1\") != -1?\"active\": \"\"}}' ng-click='action(\"toggleHeading1\")'>H1</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"header-2\") != -1?\"active\": \"\"}}' ng-click='action(\"toggleHeading2\")'>H2</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"header-3\") != -1?\"active\": \"\"}}' ng-click='action(\"toggleHeading3\")'>H3</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"quote\") != -1?\"active\": \"\"}}' ng-click='action(\"toggleBlockquote\")'>Q</button>\n\n      <button style='width:70px' class='sans-serif btn {{isPreviewEnabled? \"active\": \"\"}}' ng-click='action(\"togglePreview\")'>preview</button>\n\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"link\") != -1|| activeStates.indexOf(\"url\") != -1? \"active\": \"\"}}' ng-click='showReferenceModal()'><span class='icon-plus'></span></button>\n      <!-- {{activeStates}} -->\n  </div>\n  <div class='wand' >\n    <button class='btn' ng-disabled='isPreviewEnabled' ng-click='showReferenceModal()'><span class='icon-plus'></span></button>    \n  </div>\n\n	<textarea class='mde-textarea' placeholder=\"write something...\"></textarea>\n</div>"),$templateCache.put("/static/templates/partials/oembed-search-results.html","<div class='oembedded doc doc-{{document.type}}' ng-class='{\"active\": document.url == selectedDocument.url}' ng-click='selectDocument(document)'>\n\n  <!-- <div class='divider'>&nbsp;</div> -->\n  \n  <div class='wrapper'>\n    <div ng-if='document.urls.Preview' lazy-image src='document.urls.Preview'></div>\n    <div class='tile'>\n      <div class='title' embedit='document.metadata.title' languagle='language'></div>\n      <div class='copyright' embedit='document.copyright'></div>\n    </div>\n  </div>\n  <div class='excerpt' embedit='document.title'></div>\n</div>"),$templateCache.put("/static/templates/partials/placeholder.html","<div ng-if='type==\"doc\"' ng-include='\"templates/partials/document.placeholder.html\"|prefixTemplate'></div>\n<span ng-if='type==\"voc\"' ng-include='\"templates/partials/term.placeholder.html\"|prefixTemplate'></span>"),$templateCache.put("/static/templates/partials/story.html","<div class=\"story lite\">\n  <!-- <div ng-if='!$first' class=\"divider\"></div> -->\n  <div class=\"tags\" ng-if=\"story.tags.length\">\n      <span class='tag' ng-repeat='tag in story.tags|filter:\"public\"' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n  </div>\n  <div class=\"date\">{{story.date_created|date:'mediumDate'}}</div>\n\n  <div  class=\"divider\"></div>\n\n  <h3 class=\"title\"><a ui-sref=\"story({postId: story.slug})\"><span embedit='story.metadata.title' language='language'></span> {{story.status != 'public'? '(DRAFT)': ''}}</a></h3>  \n  \n  <blockquote ng-if='story.excerpt' class=\"reduced\">{{story.excerpt}}.\n    <a href ui-sref=\"story({postId: story.id})\">\n      <span class='icon-arrow-right-circle'></span>\n    </a>\n    <p>\n      <em ng-if=\"story.difference\">{{story.difference}}</em>\n    </p>\n  </blockquote>\n  \n  <blockquote ng-if='!story.excerpt' embedit='story.metadata.abstract' language='language'></blockquote>\n\n\n  <p>\n    \n    <span class='creator' ng-if=\"!story.authors.length\">\n      created by <span ng-init='author=story.owner;$last=true' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n    </span>\n    <span class='authors' ng-if=\"story.authors.length\">\n      written by <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n    </span>\n  </p>\n</div>"),$templateCache.put("/static/templates/partials/table-of-contents.html","\n<div id='inner-table-of-contents-toggler' >\n  <button class='btn-transparent' ng-click='toggleTableOfContents()'><span class='icon-action-undo'></span></button>\n  <div class='save' ng-if='state == \"writing\" || state == \"draft\"' ng-click='save()'>\n    <button class='btn-transparent btn-line'><span  class='icon-disc'></span></button>\n    <div class='sans-serif' style='text-transform: uppercase; font-size:10px; text-align:center; line-height:20px' translate='save'></div>\n  </div>\n  <!-- <div class='edit' ng-if='state == \"post\"' ng-click='save()'>\n    <button class='btn-transparent btn-line'><span  class='icon-disc'></span></button>\n    <div class='sans-serif' style='text-transform: uppercase; font-size:10px; text-align:center; line-height:20px' translate='save'></div>\n  </div> -->\n</div>\n\n<h2>table of contents</h2>\n\n\n<ul>\n  <li ng-repeat=\"heading in ToC\" class='heading heading-{{heading.level}}'>\n  <a ng-click='setHash(heading.slug)'> {{heading.text}}</a></li>\n\n</ul>"),$templateCache.put("/static/templates/partials/table-of-documents.html","<!-- <h2>table of documents</h2>\n -->\n<div class=\"container\">\n  <div class=\"row\">\n    <div class=\"col-md-4\">\n      <ul>\n        <li ng-repeat=\"document in _______documents\">\n          <div class='doc doc-{{document.type}}'>\n            <div class='divider'>&nbsp;</div>\n            <!-- <div class=\"citation caption\" ng-if='document.citation'>{{document.citation}}</div> -->\n            <!-- this element has fixed height. -->\n\n            <div ng-if='document.type==\"video-cover\"'>\n              \n              \n            </div>\n\n            <div ng-if='document.type==\"picture\"'>\n              \n              <div lazy-image src='document.src'></div>\n              \n            </div>\n\n            <div ng-if='document.type==\"image\"'>\n              <div lazy-image ng-click='fullsize(document)' src='document.metadata.urls.Preview'></div>\n            </div>\n\n            <div ng-if='document.type==\"video\"'>\n              <div ng-if=\"document.metadata.thumbnail_url\" ng-click='fullsize(document)' lazy-image src='document.metadata.thumbnail_url'></div>\n              <div ng-if=\"!document.metadata.thumbnail_url && document.metadata.urls.Preview\" lazy-image src='document.metadata.urls.Preview'></div>\n            </div>\n\n            <div ng-if='document.type==\"link\"' class=\"caption\">\n              <a ng-href='{{document.metadata.url}}' target='_blank'>cfr. {{document.metadata.url}}</a>\n              <!-- {{document.metadata}} -->\n              <!-- <div lazy-image src='document.metadata.thumbnail_url'></div> -->\n            </div>\n\n            <div ng-if='document.type==\"text\"'>\n              <div lazy-image ng-click='fullsize(document)' src='document.metadata.urls.Preview'></div>\n            </div>\n\n            <div ng-if='document.type==\"pdf\"'>\n              <div lazy-image src='{{document.snapshot}}'></div>\n            </div>\n\n            <div ng-if='document.type==\"rich\"' marked=\"document.metadata.html\">\n            </div>\n\n            <div ng-if='!document.metadata.title'>\n              <blockquote>{{document.citation}}</blockquote>\n              <div class='caption'>{{document.caption}}</div>\n              <div class='copyright'>{{document.copyrights}}</div>\n              \n            </div>\n\n            <div ng-if='document.type==\"bibtex\"'>\n              <div class='caption'>\n                <span ng-if='document.metadata.author'>{{document.metadata.author|bibtex}}</span>\n                <span ng-if='document.metadata.editor'>{{document.metadata.editor|bibtex}}'> (edited by) </span>\n                \n                <em>{{document.metadata.title|bibtex}}</em>\n                <span>{{document.metadata.publisher|bibtex}}</span>\n                <span ng-if='document.metadata.year'>, <span>{{document.metadata.year|bibtex}}</span> </span>\n              </div>\n            </div>\n\n            <div ng-if='document.type!=\"bibtex\" && document.metadata.title'>\n              <div class='caption' markdown='document.metadata.title'></div>\n              <div ng-if='document.metadata.reference' class='caption reference' markdown='document.metadata.reference'></div>\n              <div ng-if='document.metadata.copyright' class='copyright' markdown='document.metadata.copyright'></div>\n              <div ng-if='document.metadata.author_name' class='copyright'>\n                <a ng-href='{{document.metadata.author_url}}' target='_blank' markdown='document.metadata.author_name'></a>\n              </div>\n            </div>\n          </div>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/tag.html","<span ng-if='tag.category != \"keyword\"' class='tag' ng-class='tag.category'>{{tag.name}}</span><span ng-if='tag.category == \"keyword\"' class='tag' ng-class='tag.category'><a a href ui-sref='publications.tags({slug: tag.slug})'>{{tag.name}}</a></span>{{$last?' ': ', '}}"),$templateCache.put("/static/templates/partials/tag.input.html","<span ng-class='data.category'>\n  <span class='type'>{{data.category}}/</span>\n  <span>{{data.name}}</span>\n	<a class=\"remove-button\" ng-click=\"$removeTag()\" ><span class='icon-close'></span></a>\n</span>"),$templateCache.put("/static/templates/partials/term.html","<div ng-class='{\"active\": selectedDocument.id == term.id}' class='doc term oembedded' ng-click='selectDocument(term)'>\n  <!-- this element has fixed height. -->\n  <!-- {{term}} -->\n  <div class='wrapper'>\n    <div class='lazy-box'>\n      <div class='title' embedit='term.title'></div>\n      <div class='copyright' embedit='term.abstract'></div>\n    </div>\n    <div class='tile'>\n      <div class='title' embedit='term.title'></div>\n      <div class='authors' ng-if=\"term.authors.length\">\n        by <span ng-repeat='author in term.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n      </div>\n      \n    </div>\n  </div>\n  <div class='excerpt' embedit='term.title'></div>\n</div>"),$templateCache.put("/static/templates/partials/term.placeholder.html","<a ui-sref='story({postId: resolved.id})'>{{resolved.title}}</a>\n"),$templateCache.put("/static/templates/partials/embeds/Flickr.html","\n<div class='caption title' markdown='embed.title'></div>\n<div class='copyright'><a ng-href='embed.author_url'>{{embed.author_name}}</a></div>\n\n<div class='image-wrapper'>\n  <img lazy-img='{{embed.media_url}}' />\n</div>"),$templateCache.put("/static/templates/partials/embeds/Ina.fr.html","<div class='caption title' embedit='embed.title'></div>\n<div class='caption reference' embedit='embed.description'></div>\n<img lazy-img src='{{embed.thumbnail_url}}' />\n\n"),$templateCache.put("/static/templates/partials/embeds/YouTube.html","\n<div class='caption title' markdown='embed.title'></div>\n<div class='copyright'><a ng-href='embed.author_url'>{{embed.author_name}}</a></div>\n\n\n<div lazy-image src='embed.thumbnail_url'></div>\n\n"),$templateCache.put("/static/templates/partials/embeds/cvce.html","\n<div class='caption title' markdown='embed.title.fr'></div>\n<div class='caption reference' markdown='embed.reference.fr'></div>\n<div class='copyright'>{{embed.copyrights}}</div>\n\n\n <div ng-if='embed.urls.Preview'>\n  <div lazy-image src='embed.urls.Preview'></div>\n </div>\n\n"),$templateCache.put("/static/templates/partials/embeds/document.html","<div class='oembedded doc doc-{{document.type}}' ng-class='{\"active\": document.id == selectedDocument.id}' ng-click='selectDocument(document)'>\n\n  <!-- <div class='divider'>&nbsp;</div> -->\n  \n  <div class='wrapper'>\n    <div ng-if='document.metadata'>\n      <div ng-if='document.metadata.thumbnail_url' lazy-image src='document.metadata.thumbnail_url'></div>\n\n      <div ng-if='!document.metadata.thumbnail_url && document.metadata.urls.Preview' lazy-image src='document.metadata.urls.Preview'></div>\n\n      <div ng-if='!document.metadata.thumbnail_url && !document.metadata.urls.Preview' class='lazy-box'></div>\n\n      <div class='tile'>\n        <div class='title' embedit='document.metadata.title' language='language'></div>\n        <div class='copyright' embedit='document.metadata.copyright'></div>\n      </div>\n    </div>\n    <div ng-if='!document.metadata'>\n      <div ng-if='document.urls.Preview' lazy-image src='document.urls.Preview'></div>\n      <div class='tile'>\n        <div class='title' embedit='document.title'></div>\n        <div class='copyright' embedit='document.copyright'></div>\n      </div>\n    </div>\n  </div>\n  <div class='excerpt' embedit='document.title'></div>\n</div>"),$templateCache.put("/static/templates/partials/modals/covers.html","<div class=\"modal\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\" style=\"z-index: 1051; display: block;\">\n  <div class=\"modal-dialog\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n      <button type=\"button\" class=\"close\" aria-label=\"Close\" ng-click=\"$hide()\">\n      <span aria-hidden=\"true\" class='icon-close'></span>\n      </button>\n      <h4 class=\"modal-title\" translate=\"modal.covers.title\"></h4></div>\n      \n      <div class=\"modal-body\">\n        <div class='section padded' style='padding-bottom: 0'>\n          <label>\n            <span translate='search'></span>{{isSomethingSelected}}\n            <span style='color: #b7b7b7' translate='results.amount' translate-values='{count: tab.count}'></span>\n          </label>\n          <input placeholder='....' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 200 }\" ng-change='suggest(query)'>\n        </div>\n\n        <ul class=\"nav nav-tabs\" style='margin-bottom: 20px; padding-left:15px;' role=\"tablist\">\n          <li role='presentation' ng-class='{\"active\": _tab.name == tab.name}' ng-repeat='_tab in tabs'>\n            <a ng-click='setTab(_tab.name)' translate='tab.{{_tab.name}}' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\"></a>\n          </li>\n        </ul>\n\n        <div>\n          <ul class='list-of-documents'><li ng-repeat='document in tab.items' ng-include='\"templates/partials/embeds/document.html\"|prefixTemplate'></li>\n              </ul>\n          <div class='more-wrapper'>\n                <div ng-if='tab.items.length > 0 && tab.items.length < tab.count' class=\"btn-line-group primary\">\n                  <button class='btn-line' ng-click='more()'>\n                    <span ng-if='!tab.isLoadingNextItems'>\n                      <span translate='button.more'></span>\n                      <span translate='missing' translate-values=\"{count: tab.missing}\"></span>\n                    </span>\n                    <span ng-if='tab.isLoadingNextItems' translate='button.loading'></span>\n                  </button>\n                </div>\n                <!-- when count equals item length, we are at the end -->\n              </div>\n        </div>\n      </div>\n      <!-- eof body -->\n      <div class=\"modal-footer\">\n        <span class='btn-line-group' ng-class=\"{'primary':isSomethingSelected}\"><button type=\"button\" class=\"btn-line \" ng-class=\"{'active':isSomethingSelected}\" ng-click=\"addDocument(tab.name, contents, reference, url, embed)\" translate='button.add'></button>\n        </span>\n        <span class='btn-line-group'>\n        <button type=\"button\" class=\"btn-line\" ng-click=\"$hide()\">Close</button>\n        </span>\n      </div>\n      <!-- eof footer -->\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/modals/fullsize.html","<div ng-class='fullsized.type' class=\"modal fullsize\"  tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\" style=\"z-index: 1050; display: block;\">\n  <div ng-click='$hide()' class='close'>\n  <span class='icon-close'></span>\n  </div>\n  <div ng-class='fullsized.type' class='oversize' style=''>\n    <div class=\"wrapper\">\n      <div class=\"header\">\n        <div class=\"inner\">\n        <h2 embedit='fullsized.metadata.title'></h2>\n        <div class='contents'>\n          <span embedit='fullsized.metadata.reference'></span>\n          <span ng-if='fullsized.metadata.author_name'>by {{fullsized.metadata.author_name}}</span>\n          <a ng-if='fullsized.url' target='_blank' ng-href='{{fullsized.url}}' translate='link.to.original'></a>\n        </div>\n        </div>\n      </div>\n      <div class=\"main\">\n        <div class=\"box sidebar\"></div>\n        <div class=\"box content\" ng-if='fullsized.type == \"photo\" || fullsized.type == \"rich\" || fullsized.type == \"video\"'>\n          <div class='embedded' ng-if='fullsized.metadata.html' stretch='true' embedit='fullsized.metadata.html'></div>\n        </div>\n        <div class=\"box content\" ng-if='fullsized.type == \"text\"'>\n          <div class='embedded' stretch='true' embedit='fullsized.metadata.caption'></div>\n        </div>\n        <div class=\"box sidebar\"></div>\n      </div>\n      <div class=\"footer\">\n        <div class='inner'>\n          <div class='text copyright' marked='fullsized.metadata.copyright'></div>\n        </div>\n      </div>\n    </div>\n\n    <div class='table' style='display: none'>\n      \n\n      <div class='wrapper' ng-if='fullsized.type == \"link\"'>\n        \n      </div>\n      <!-- flickr -->\n      <div class='wrapper' ng-if='fullsized.type == \"photo\"'>\n        <div class='embedded' ng-if='fullsized.metadata.html' stretch='true' embedit='fullsized.metadata.html'></div>\n      </div>\n      <div class='wrapper' ng-if='fullsized.type == \"rich\"'>\n      \n        \n\n         <div class='embedded' ng-if='fullsized.metadata.html' stretch='true' embedit='fullsized.metadata.html'></div>\n      </div>\n\n      <div class='wrapper' ng-if='fullsized.type == \"image\"'>\n\n        <div lazy-image size='contain' src='fullsized.metadata.urls.Publishable'></div>\n\n        <div class='heading'>\n          <h2 marked='fullsized.metadata.title'></h2>\n          <div marked='fullsized.metadata.reference'></div>\n          \n        </div>\n        <div class='inner'>\n          <div class='text caption' marked='fullsized.metadata.caption'></div>\n          <div class='text copyright' marked='fullsized.metadata.copyright'></div>\n        </div>\n      </div>\n\n      \n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/modals/mde-enrich.html","<div class=\"modal\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\" style=\"z-index: 1050; display: block;\">\n  <div class=\"modal-dialog\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\" ng-show=\"title\">\n      <button type=\"button\" class=\"close\" aria-label=\"Close\" ng-click=\"$hide()\">\n      <span aria-hidden=\"true\" class='icon-close'></span>\n      </button>\n      <h4 class=\"modal-title\">add resource</h4></div>\n      \n      <div class=\"modal-body\">\n\n        \n        <!-- <input type='text' class=\"form-control\" placeholder=\"search ...\"> -->\n        <ul class=\"nav nav-tabs\" style='padding-left:15px; margin-bottom:0' role=\"tablist\">\n          <li role=\"presentation\" ng-class=\"tab.name == 'favourite'? 'active':''\"><a ng-click='setTab(\"favourite\")' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate='enrich.resources'></a></li>\n          <li role=\"presentation\" ng-class='{\"active\": tab.name == \"glossary\"}'><a ng-click='setTab(\"glossary\")' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate='enrich.glossary'></a></li>\n          <li role=\"presentation\" ng-class=\"tab.name == 'CVCE'? 'active':''\"><a ng-click='setTab(\"CVCE\")' aria-controls=\"profile\" role=\"tab\" data-toggle=\"tab\">cvce archives</a></li>\n          \n          <li role=\"presentation\" ng-class=\"tab.name == 'url'? 'active':''\"><a ng-click='setTab(\"url\")' aria-controls=\"messages\" role=\"tab\" data-toggle=\"tab\" translate='enrich.fromUrl'></a></li>\n\n          <!-- <li role=\"presentation\" ng-class=\"tab.name == 'bibtex'? 'active':''\"><a ng-click='setTab(\"bibtex\")' aria-controls=\"messages\" role=\"tab\" data-toggle=\"tab\">new reference</a></li> -->\n          \n        </ul>\n\n        \n          <div ng-show=\"tab.name == 'favourite'\" class=\"tab-content\">\n            <div class='section padded' ng-class='{\"last\": !lookups.length}'>\n              <label>\n                <span translate='search'></span>\n                <span style='color: #b7b7b7' translate='results.amount' translate-values='{count: tab.count}'></span>\n              </label>\n              <input placeholder='...' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 450 }\" ng-change='suggest(query)'>\n            </div>\n            <div class='section last'>\n              <ul class='list-of-documents'><li ng-repeat='document in tab.items' ng-include='\"templates/partials/embeds/document.html\"|prefixTemplate'></li>\n              </ul>\n              <div class='more-wrapper'>\n                <div ng-if='tab.items.length > 0 && tab.items.length < tab.count' class=\"btn-line-group primary\">\n                  <button class='btn-line' ng-click='more()'>\n                    <span ng-if='!tab.isLoadingNextItems'>\n                      <span translate='button.more'></span>\n                      <span translate='missing' translate-values=\"{count: tab.missing}\"></span>\n                    </span>\n                    <span ng-if='tab.isLoadingNextItems' translate='button.loading'></span>\n                  </button>\n                </div>\n                <!-- when count equals item length, we are at the end -->\n              </div>\n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'glossary'\" class=\"tab-content\">\n            <div class='section padded' ng-class='{\"last\": !glossary.length}'>\n              <label>\n                <span translate='search'></span>\n                <span style='color: #b7b7b7' translate='results.amount' translate-values='{count: tab.count}'></span>\n              </label>\n              <input placeholder='...' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 250 }\" ng-change='suggest(query)'>\n            </div>\n            <div class='section last'>\n              <ul class='list-of-documents'><li ng-repeat='term in tab.items' ng-include='\"templates/partials/term.html\"|prefixTemplate'></li>\n              </ul>\n              <div class='more-wrapper'>\n                <div ng-if='tab.items.length > 0 && tab.items.length < tab.count' class=\"btn-line-group primary\">\n                  <button class='btn-line' ng-click='more()'>\n                    <span ng-if='!tab.isLoadingNextItems'>\n                      <span translate='button.more'></span>\n                      <span translate='missing' translate-values=\"{count: tab.missing}\"></span>\n                    </span>\n                    <span ng-if='tab.isLoadingNextItems' translate='button.loading'></span>\n                  </button>\n                </div>\n                <!-- when count equals item length, we are at the end -->\n              </div>\n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'CVCE'\" class=\"tab-content\">\n            <div class='section padded' ng-class='{\"last\": !suggestResults.length}'>\n              <label>\n                <span translate='search'></span>\n                <span style='color: #b7b7b7' translate='results.amount' translate-values='{count: tab.count}'></span>\n              </label>\n              <input placeholder='...' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 250 }\" ng-change='suggest(query)'>\n            </div>\n            <div class='section last'>\n              <ul class='list-of-documents'>\n                <li ng-repeat='document in tab.items' ng-include='\"templates/partials/oembed-search-results.html\"|prefixTemplate'>\n                </li>\n              </ul>\n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'url'\" class=\"tab-content\">\n            <div class='section padded'>\n              <label translate='url'></label>\n              <span style='color: #b7b7b7' translate='{{suggestMessage}}'></span>\n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea\" rows=\"3\" msd-elastic ng-model='url' ng-change='previewUrl(url)' type='text' placeholder='http://'></textarea>\n              </div>\n            \n              <div class='preview' ng-show='embed.provider_name' ng-class='embed.type'>\n                <div ng-if='embed.provider_name==\"CVCE\"' ng-include='\"templates/partials/embeds/cvce.html\"|prefixTemplate'></div>\n                <div ng-if='embed.provider_name==\"YouTube\"' ng-include='\"templates/partials/embeds/YouTube.html\"|prefixTemplate'></div>\n                <div ng-if='embed.provider_name==\"Flickr\"' ng-include='\"templates/partials/embeds/Flickr.html\"|prefixTemplate'></div>\n                <div ng-if='embed.provider_name==\"Ina.fr\"' ng-include='\"templates/partials/embeds/Ina.fr.html\"|prefixTemplate'></div>\n\n                <div ng-if='embed.type == \"link\"'>\n                  <div embedit='embed.description'></div>\n                </div>\n                <div ng-if='embed.type == \"rich\"'>\n                  <div ng-if='embed.html' style='height: 200px; width: 100%' embedit='embed.html' stretch=\"true\"></div>\n                  <div ng-if='!embed.title' translate='enrich.type.notitle'></div>\n                  <div>\n                    \n                  </div>\n                </div>\n                <div><span translate='remote.url'></span>: <a ng-href='{{embed.url}}' target='_blank' translate='remote.url.placeholder'></a></div>\n                <label translate='title'></label>\n                <input class='form-control' ng-model='embed.title'></input>\n              </div>\n            </div>\n            <div class='section padded last'>\n              <label translate='bibtex reference'></label>\n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea\" rows=\"3\" msd-elastic ng-model='reference' type='text' placeholder='@{}'></textarea>\n              </div>\n              <div class='sans-serif description'>You can use <a href='http://truben.no/latex/bibtex/'>this web app</a> to easily build a bibtex reference</div>\n              \n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'iframe'\" class=\"tab-content\">\n            <!-- @todo -->\n          </div>\n\n          <div ng-show=\"tab.name == 'bibtex'\" class=\"tab-content\">\n            Add a reference (bibtex) Cfr <a href='https://www.zotero.org/support/creating_bibliographies'>quick copy from Zotero</a>\n            <label translate='bibtex'></label>\n            <div class='elastic-textarea-wrapper'>\n              <textarea class=\"elastic-textarea\" style=\"font-family: monospace;\" rows=\"8\" msd-elastic ng-model='reference' type='text' placeholder='@BOOK {}'></textarea>\n            </div>\n          </div>\n          <div style='clear:both'></div>\n\n\n      </div>\n      <div class=\"modal-footer\">\n        <span class='btn-line-group'><button type=\"button\" class=\"btn-line {{isSomethingSelected?'active':''}}\" ng-click=\"addDocument(tab.name, contents, reference, url, embed)\" translate='button.add'></button>\n        </span>\n        <span class='btn-line-group'>\n        <button type=\"button\" class=\"btn-line\" ng-click=\"$hide()\">Close</button>\n        </span>\n      </div>\n    </div>\n  </div>\n</div>");
}]);