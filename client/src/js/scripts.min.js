angular.module("miller",["ui.router","ngResource","ngSanitize","ngCookies","ngTagsInput","mgcrea.ngStrap","monospaced.elastic","LocalStorageModule","pascalprecht.translate","ngDisqus","angular-embed","angular-embed.handlers","angularLazyImg"]).constant("LOCALES",{locales:{en_US:"English"},preferredLocale:"en_US"}).constant("EVENTS",{SAVE:"save",MESSAGE:"message",BAD_REQUEST:"bad_request",MARKDOWNIT_FULLSIZE:"markdownit_fullsize",MARKDOWNIT_RESOLVE:"markdownit_resolve"}).config(function($disqusProvider,RUNTIME){RUNTIME.settings.disqus&&$disqusProvider.setShortname(RUNTIME.settings.disqus)}).config(function($locationProvider){$locationProvider.hashPrefix("!")}).config(function(tagsInputConfigProvider,RUNTIME){tagsInputConfigProvider.setDefaults("tagsInput",{replaceSpacesWithDashes:!1,template:RUNTIME["static"]+"templates/partials/tag.input.html"}).setDefaults("autoComplete",{loadOnDownArrow:!0})}).config(function($translateProvider,RUNTIME){$translateProvider.useSanitizeValueStrategy("sanitize"),$translateProvider.useStaticFilesLoader({prefix:RUNTIME["static"]+"locale/locale-",suffix:".json"}),$translateProvider.preferredLanguage("en_US")}).config(function(localStorageServiceProvider){localStorageServiceProvider.setPrefix("miller")}).config(function($resourceProvider){$resourceProvider.defaults.stripTrailingSlashes=!1}).config(function($httpProvider){$httpProvider.defaults.xsrfCookieName="csrftoken",$httpProvider.defaults.xsrfHeaderName="X-CSRFToken",$httpProvider.interceptors.push(function($q,$rootScope,EVENTS){return{responseError:function(rejection){return 400==rejection.status&&$rootScope.$emit(EVENTS.BAD_REQUEST,rejection),$q.reject(rejection)}}})}).config(function($locationProvider){}).config(function(embedlyServiceProvider,RUNTIME){RUNTIME.oembeds.EMBEDLY_API_KEY&&embedlyServiceProvider.setKey(RUNTIME.oembeds.EMBEDLY_API_KEY)}).config(function($stateProvider,$urlRouterProvider,RUNTIME){$urlRouterProvider.otherwise("/"),$stateProvider.state("index",{url:"/",reloadOnSearch:!1,controller:"IndexCtrl",templateUrl:RUNTIME["static"]+"templates/index.html",resolve:{writings:function(StoryFactory){return StoryFactory.get({filters:JSON.stringify({tags__slug:"highlights"})}).$promise},news:function(StoryFactory){return StoryFactory.get({filters:JSON.stringify({tags__category:"blog"})}).$promise}}}).state("authors",{url:"/authors",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/authors.html",resolve:{items:function(ProfileFactory,$stateParams){return ProfileFactory.get({}).$promise},model:function(){return"profile"},factory:function(ProfileFactory){return ProfileFactory}}}).state("login",{url:"/login",reloadOnSearch:!1,controller:"LoginCtrl",templateUrl:RUNTIME["static"]+"templates/login.html"}).state("draft",{url:"/create",reloadOnSearch:!1,controller:"DraftCtrl",templateUrl:RUNTIME["static"]+"templates/draft.html"}).state("writing",{url:"/writing/:storyId",reloadOnSearch:!1,controller:"WritingCtrl",templateUrl:RUNTIME["static"]+"templates/draft.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.storyId}).$promise}}}),$stateProvider.state("author",{"abstract":!0,reloadOnSearch:!1,url:"/author/{username:[0-9a-zA-Z\\.-_]+}",controller:"AuthorCtrl",templateUrl:RUNTIME["static"]+"templates/author.html",resolve:{profile:function(ProfileFactory,$stateParams){return ProfileFactory.get({username:$stateParams.username}).$promise}}}).state("author.publications",{url:"/publications","abstract":!0,reloadOnSearch:!1,controller:function($scope){$scope.urls=RUNTIME.stories.writing},templateUrl:RUNTIME["static"]+"templates/author.publications.html"}).state("author.publications.drafts",{url:"/drafts",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,profile){return StoryFactory.get({filters:JSON.stringify({status:"draft",owner__username:profile.user.username})}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory}}}),_.each(RUNTIME.stories.writing,function(d){$stateProvider.state("author.publications."+d.name,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams,profile){return StoryFactory.get({filters:d.slug?JSON.stringify({tags__category:"writing",tags__slug:d.slug,authors__username__in:[profile.user.username]}):JSON.stringify({tags__category:"writing",authors__username__in:[profile.user.username]})}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory}}})}),$stateProvider.state("blog",{url:"/blog",reloadOnSearch:!1,"abstract":!0,controller:"BlogCtrl",templateUrl:RUNTIME["static"]+"templates/blog.html"}).state("blog.everything",{url:"",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({filters:JSON.stringify({tags__category:"blog"})}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory}}}).state("blog.events",{url:"/events",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({filters:JSON.stringify({tags__category:"blog",tags__slug:"event"})}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory}}}).state("publications",{url:"/publications","abstract":!0,reloadOnSearch:!1,controller:function($scope,$state){$scope.urls=RUNTIME.stories.writing,$state.params.slug&&($scope.slug=$state.params.slug)},templateUrl:RUNTIME["static"]+"templates/publications.html"}).state("publications.tags",{url:"/tags/:slug",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({filters:JSON.stringify({tags__slug:$stateParams.slug})}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory}}}),_.each(RUNTIME.stories.writing,function(d){$stateProvider.state("publications."+d.name,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({filters:d.slug?JSON.stringify({tags__category:"writing",tags__slug:d.slug}):JSON.stringify({tags__category:"writing"})}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory}}})}),$stateProvider.state("search",{url:"/search/:query",controller:function($scope,items){console.log(items),$scope.items=items.results},reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/search.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({id:"search",q:$stateParams.query}).$promise}}}),$stateProvider.state("story",{url:"/story/:postId",controller:"StoryCtrl",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/story.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.postId}).$promise}}}).state("page",{url:"/:name",controller:"PageCtrl",templateUrl:RUNTIME["static"]+"templates/md.html",resolve:{page:function(PageFactory,$stateParams){return PageFactory.get({name:$stateParams.name})}}})}),angular.module("miller").filter("prefixTemplate",function(RUNTIME){return function(input){return RUNTIME["static"]+input}}).filter("bibtex",function(){return function(text){return text?text.replace(/[\{\}]/g,""):""}}).filter("slugify",function(){return function(text){for(var strip=/[^\w\s-]/g,hyphen=/[-\s]+/g,slug=text.toLowerCase(),map={from:"àáäãâèéëêìíïîòóöôõùúüûñç·/_,:;",to:"aaaaaeeeeiiiiooooouuuunc------"},i=0,j=map.from.length;j>i;i++)slug=slug.replace(new RegExp(map.from.charAt(i),"g"),map.to.charAt(i));return slug.replace(strip,"").trim().replace(hyphen,"-")}}),angular.module("miller").factory("StoryFactory",function($resource){return $resource("/api/story/:id/",{},{update:{method:"PUT"},patch:{method:"PATCH"}})}).factory("StoryTagsFactory",function($resource){return $resource("/api/story/:id/tags/",{},{update:{method:"PUT"}})}).factory("StoryDocumentsFactory",function($resource){return $resource("/api/story/:id/documents/",{},{update:{method:"PUT"}})}).factory("ProfileFactory",function($resource){return $resource("/api/profile/:username/",{},{update:{method:"PUT"},patch:{method:"PATCH"}})}).factory("DocumentFactory",function($resource){return $resource("/api/document/:id/",{},{update:{method:"PUT"}})}).factory("CaptionFactory",function($resource){return $resource("/api/caption/:id/",{},{update:{method:"PUT"},patch:{method:"PATCH"}})}).factory("TagFactory",function($resource){return $resource("/api/tag/:id/",{},{update:{method:"PUT"}})}).factory("PageFactory",function($http,RUNTIME){return{get:function(params){return $http.get(RUNTIME["static"]+"pages/"+params.name+".md")}}}).service("QueryParamsService",function($filter){return function(queryparams){var params={};return queryparams.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(str,key,value){params[key]=decodeURIComponent(value)}),params}}).service("bibtexService",function($filter){return function(json){}}).service("markdownItService",function($filter){return function(value,language){var results,sections,md=new window.markdownit,linkIndex=0;if(results={md:value,html:"",ToC:[],docs:[],footnotes:{}},md.use(window.markdownitFootnote).use(window.markdownitContainer,"profile").use(window.markdownitContainer,"profile-committee").use(window.markdownitContainer,"profile-others"),md.renderer.rules.link_open=function(tokens,idx){var url=tokens[idx].attrGet("href");if(0===url.trim().indexOf("doc/")){var documents=url.trim().replace("doc/","").split(",");for(var i in documents)results.docs.push({_index:"link-"+linkIndex++,citation:tokens[idx+1].content,slug:documents[i]});return tokens[idx+1].content.length?'<a name="'+documents[0]+'" ng-click="fullsize(\''+url+"', 'doc')\"><span class=\"anchor-wrapper\"></span>":'<span type="doc" lazy-placeholder="'+documents[0]+'">'}if(0===url.trim().indexOf("voc/")){var terms=url.trim().replace("voc/","").split(",");for(var i in terms)results.docs.push({_index:"link-"+linkIndex++,citation:tokens[idx+1].content,slug:terms[i],type:"glossary"});return tokens[idx+1].content.length?(tokens[idx].attrSet("class","glossary"),'<a class="glossary" name="'+terms[0]+'" ng-click="fullsize(\''+url+"', 'voc')\"><span class=\"anchor-wrapper\"></span>"):'<span type="voc" lazy-placeholder="'+terms[0]+'">'+terms[0]}return'<a href="'+url+'" target="_blank">'},md.renderer.rules.link_close=function(tokens,idx){return tokens[idx-1].attrGet("href")?"</span>":"</a>"},md.renderer.rules.heading_open=function(tokens,idx){var text=tokens[idx+1].content,h={text:text,level:tokens[idx].tag.replace(/[^\d]/g,""),slug:$filter("slugify")(text)};return results.ToC.push(h),"<"+tokens[idx].tag+'><a name="'+h.slug+'" class="anchor" href="#'+h.slug+'"><span class="header-link"></span></a>'},console.log("rules",md.renderer.rules),md.renderer.rules.image=function(tokens,idx){var src=tokens[idx].attrGet("src"),title=tokens[idx].attrGet("title"),alt=tokens[idx].content;return console.log("IMAGE",src,"title:",title,"alt:",alt,tokens[idx]),0===alt.indexOf("profile/")?'<div class="profile-thumb" style="background-image:url('+src+')"></div>':'<img src="'+src+'" title="'+title+'" alt="'+alt+'"/>'},md.renderer.rules.footnote_anchor=function(tokens,idx,options,env,slf){var caption=slf.rules.footnote_caption(tokens,idx,options,env,slf);return'<span style="float:left; margin-right: 10px">'+caption+"</span>"},md.renderer.rules.footnote_ref=function(tokens,idx,options,env,slf){console.log(" md.renderer.rules.footnote_ref");var id=slf.rules.footnote_anchor_name(tokens,idx,options,env,slf),caption=slf.rules.footnote_caption(tokens,idx,options,env,slf);return'<span footnote="'+id+'" class="footnote-ref" caption="'+caption+'"></span>'},sections=_(value.split(/\s*[-_]{3,}\s*\n/)).value(),sections.length>1&&(results.footnotes=sections.pop(),value=sections.join("")),language){var candidate=_(value.split(/<!--\s*(lang:[a-zA-Z_]{2,5})\s*-->/)).compact().chunk(2).fromPairs().value();candidate["lang:"+language]&&(value=candidate["lang:"+language])}return results.html=md.render(value),results}}).factory("metadataFactory",function($log){return{parse:function(story){$log.info("[service] metadata.parse")},create:function(story){}}}).service("markedService",function($filter){return function(value,language){var renderer=new marked.Renderer,linkIndex=0,result="",ToC=[],docs=[],sections=_(value.split(/\s*[-_]{3,}\s*/)).value();if(console.log("markedService",sections.length),sections.length>1){sections.pop();value=sections.join("")}if(language){var candidate=_(value.split(/<!--\s*(lang:[a-zA-Z_]{2,5})\s*-->/)).compact().chunk(2).fromPairs().value();candidate["lang:"+language]&&(value=candidate["lang:"+language])}return renderer.heading=function(text,level){var h={text:text,level:level,slug:$filter("slugify")(text)};return ToC.push(h),"<h"+level+'><a name="'+h.slug+'" class="anchor" href="#'+h.slug+'"><span class="header-link"></span></a>'+text+"</h"+level+">"},renderer.link=function(url,boh,text){if(console.log("markedService link",url),0===url.trim().indexOf("doc/")){var documents=url.trim().replace("doc/","").split(",");for(var i in documents)docs.push({_index:"link-"+linkIndex++,citation:text,slug:documents[i]});return'<a name="'+documents[0]+'" ng-click="hash(\''+url+'\')"><span class="anchor-wrapper"></span>'+text+"</a>"}if(0===url.trim().indexOf("voc/")){var terms=url.trim().replace("voc/","").split(",");for(var i in terms)docs.push({_index:"link-"+linkIndex++,citation:text,slug:terms[i],type:"glossary"});return'<a class="glossary" name="'+terms[0]+'" ng-click="hash(\''+url+'\')"><span class="anchor-wrapper"></span>'+text+' <span class="icon icon-arrow-right-circle"></span></a>'}return"<a href="+url+">"+text+"</a>"},renderer.image=function(src,title,alt){return 0===(alt||"").indexOf("profile/")?'<div class="profile-thumb" style="background-image:url('+src+')"></div>':'<img src="'+src+'" title="'+title+'" alt="'+alt+'"/>'},result=marked(value,{renderer:renderer}),{html:result,md:value,ToC:ToC,docs:docs}}}),angular.module("miller").controller("AuthorCtrl",function($scope,$log,profile){$scope.isMe=$scope.user.username==profile.username,$scope.profile=profile,$log.log("AuthorCtrl ready, user:",$scope.user,profile)}),angular.module("miller").controller("BlogCtrl",function($scope,$log){$log.log("BlogCtrl ready")}),angular.module("miller").controller("CoreCtrl",function($rootScope,$scope,$log,$location,$anchorScroll,$state,$modal,$alert,localStorageService,$translate,$timeout,StoryFactory,DocumentFactory,TagFactory,RUNTIME,EVENTS){$log.log("CoreCtrl ready, user:",RUNTIME.user.username,RUNTIME),$scope.user=RUNTIME.user,$scope.hasToC=!1,$scope.ToCEnabled=!1,$scope.stopStateChangeStart=!1,$scope.toggleTableOfContents=function(){$scope.hasToC=!$scope.hasToC},$scope.locationPath="",$scope.toggleStopStateChangeStart=function(value){$log.debug("CoreCtrl > toggleStopStateChangeStart value:",value,"- current:",$scope.stopStateChangeStart),$scope.stopStateChangeStart="boolean"==typeof value?value:!$scope.stopStateChangeStart},$scope.setToC=function(ToC){$log.log("CoreCtrl > setToC data:",ToC),$scope.ToC=ToC},$scope.disableToC=function(){$scope.ToCDisabled=!0},$scope.search=function(searchquery){$log.log("CoreCtrl > search() searchquery:",searchquery),$state.go("search",{query:searchquery})},$scope.setDocuments=function(documents){if($log.log("CoreCtrl > setDocuments items n.:",documents.length,documents),$scope.documents=_.uniq(documents,"id"),$scope.qs.view)for(var i=0,j=$scope.documents.length;j>i;i++)if($scope.qs.view==$scope.documents[i].short_url){$scope.fullsized=$scope.documents[i],fullsizeModal.$promise.then(fullsizeModal.show);break}},$rootScope.resolve=function(slug,type,callback){if("voc"==type)$log.log("CoreCtrl > $scope.resolve [requesting] voc slug:",slug),StoryFactory.get({id:slug},callback);else{var matching=$scope.documents.filter(function(d){return d.slug==slug});matching.length?($log.log("CoreCtrl > $scope.resolve [cached] doc slug:",slug),callback(matching[0])):($log.log("CoreCtrl > $scope.resolve [requesting] doc slug:",slug),DocumentFactory.get({id:slug},callback))}},$scope.save=function(){$log.log("CoreCtrl > @SAVE ..."),$scope.$broadcast(EVENTS.SAVE)},$scope.update=function(key,value){$log.log("CoreCtrl > @UPDATE ",key,":",value," ...");var _d={};_d[key]=value,$scope.$broadcast(EVENTS.UPDATE,_d)},$scope.lock=function(){$log.log("CoreCtrl > lock .............")},$scope.unlock=function(){$log.log("CoreCtrl > unlock .............")},$scope.suggestTags=function(query,options){$log.log("CoreCtrl -> suggestTags",query,options);var filters=options||{};return TagFactory.get({filters:JSON.stringify(filters)}).$promise.then(function(response){return response.results})},$scope.breakingNews=[],$scope.setBreakingNews=function(breakingNews){$scope.breakingNews=breakingNews.slice(0,2).map(function(d){if(d.covers&&d.covers.length){var cover=d.covers[0];d.cover_url=_.get(cover,"metadata.thumbnail_url")||_.get(cover,"metadata.urls.Preview")||cover.url}return d})},$rootScope.$on("$stateChangeStart",function(e,state){if($log.log("CoreCtrl @stateChangeStart new:",state.name,"- previous:",$scope.state),$scope.stopStateChangeStart===!0){var answer=confirm("Are you sure you want to leave this page?");answer||e.preventDefault()}}),$rootScope.$on("$stateChangeSuccess",function(e,state){var h=$location.hash();$log.debug("CoreCtrl @stateChangeSuccess",state.name,h),$scope.ToC=[],$scope.documents=[],$scope.state=state.name,$timeout($anchorScroll,0),$scope.toggleStopStateChangeStart(!1)}),$scope.setHash=function(hash){$location.hash(hash)},$scope.changeLanguage=function(key){$scope.language=key,localStorageService.set("lang",$scope.language),$translate.use(key)},$scope.isWithoutAuthors=function(story){return 0!==story.authors.length},$scope.hasWritingPermission=function(user,story){return!!user.username&&user.username.length>0&&(user.is_staff||story.owner.username==user.username)};var fullsizeModal=$modal({scope:$scope,template:RUNTIME["static"]+"templates/partials/modals/fullsize.html",id:"dii",show:!1});$scope.$on("modal.hide",function(e,modal){"dii"==modal.$id&&$location.search("view",null)}),$rootScope.fullsize=function(slug,type){$log.log("CoreCtrl -> fullsize, doc slug:",slug,type),"doc"==type&&$location.search("view",slug)},window.onbeforeunload=function(event){if($scope.state&&-1!==["draft","writing"].indexOf($scope.state)){var message="Sure you want to leave?";return"undefined"==typeof event&&(event=window.event),event&&(event.returnValue=message),message}},$scope.$on("$locationChangeSuccess",function(e,path){$log.debug("CoreCtrl @locationChangeSuccess",path,$location),$scope.qs=$location.search(),$scope.locationPath=path,$scope.path=$location.path(),$scope.qs.view&&DocumentFactory.get({id:$scope.qs.view},function(res){$scope.fullsized=res,fullsizeModal.$promise.then(fullsizeModal.show)}),$scope.qs.view&&$scope.fullsized&&$scope.fullsized.short_url==$scope.qs.view?fullsizeModal.$promise.then(fullsizeModal.show):!$scope.qs.view&&$scope.fullsized&&fullsizeModal.hide()}),$rootScope.$on(EVENTS.BAD_REQUEST,function(e,rejection){$alert({placement:"top",title:"form errors",animation:"bounceIn",content:_(rejection.data).map(function(d,k){return"<div><b>"+k+"</b>: "+d+"</div>"}).value().join(""),show:!0,type:"error"})});var timer_event_message;$scope.$on(EVENTS.MESSAGE,function(e,message){$log.log("CoreCtrl @MESSAGE",message),$scope.message=message,timer_event_message&&$timeout.cancel(timer_event_message),timer_event_message=$timeout(function(){$scope.message=null},2e3)}),$scope.language=localStorageService.get("lang")||"en_US",$scope.changeLanguage($scope.language),StoryFactory.get({filters:JSON.stringify({tags__slug:"top"})},function(data){$log.info("CoreCtrl breaking news loaded",data),$scope.setBreakingNews(data.results)})}),angular.module("miller").controller("DraftCtrl",function($scope,$log,$state,localStorageService,StoryFactory,EVENTS){$log.debug("DraftCtrl welcome"),$scope.isDraft=!0,$scope.tags=[],$scope.save=function(){StoryFactory.save({},{title:$scope.title,"abstract":$scope["abstract"],contents:$scope.contents,status:"draft",tags:_.map($scope.tags,"id")},function(res){$scope.$emit(EVENTS.MESSAGE,"saved"),$log.log("DraftCtrl -> @EVENTS.SAVE saved:",res),$state.go("writing",{storyId:res.id})})},$scope.$on(EVENTS.SAVE,function(){$scope.$emit(EVENTS.MESSAGE,"saving"),$scope.save()}),$scope.attachTag=function(tag){$log.log("DraftCtrl -> attachTag",tag),$scope.tags.push(tag)},$scope.detachTag=function(tag){$log.log("DraftCtrl -> detachTag",tag);for(var i=0,j=$scope.tags.length;j>i;i++)if($scope.tags[i].id==tag.id){$scope.tags.splice(i,1);break}},_offsetables["writing-tools"]=$("#writing-tools")}),angular.module("miller").controller("IndexCtrl",function($scope,$log,writings,news){function tokenize(text,words){var sentences=text.split(/[\.!\?]/);return sentences}$log.debug("IndexCtrl welcome",writings,news),writings.results=writings.results.map(function(d){return d.excerpt=d.metadata["abstract"][$scope.language]?tokenize(d.metadata["abstract"][$scope.language],10)[0]:"",d}),$scope.coverstory=writings.results.shift(),$scope.otherstories=writings.results,$scope.coverstory&&$scope.coverstory.covers.length&&($scope.coverstory.cover=_.get(_.first($scope.coverstory.covers),"metadata.thumbnail_url")),$scope.news=news.results.map(function(d){return d.excerpt=d.metadata["abstract"][$scope.language]?tokenize(d.metadata["abstract"][$scope.language],10)[0]:"",d}),$log.debug("IndexCtrl welcome",$scope.news)}),angular.module("miller").controller("ItemsCtrl",function($scope,$log,items,model,factory,QueryParamsService){function tokenize(text,words){var sentences=text.split(/[\.!\?]/);return sentences}function normalizeItems(items){return items.map(function(d){if(!d.metadata["abstract"][$scope.language])return d;var sentences=tokenize(d.metadata["abstract"][$scope.language],10);return d.excerpt=sentences.shift(),sentences.length&&(d.difference=sentences.join(". ")),d})}$log.log("ItemsCtrl ready, n.:",items.count,"- items:",items),$scope.sync=function(res){$scope.isLoadingNextItems=!1,next=QueryParamsService(res.next||""),console.log("ItemsCtrl > sync()",next),$scope.count=res.count,$scope.items=($scope.items||[]).concat(normalizeItems(res.results)),$scope.missing=res.count-$scope.items.length},$scope.more=function(){return $scope.isLoadingNextItems?void $log.warn("is still loading"):($scope.isLoadingNextItems=!0,void factory.get(next,$scope.sync))},$scope.sync(items),$scope.$watch("language",function(v){v&&($scope.items=normalizeItems($scope.items))})}),angular.module("miller").controller("LoginCtrl",function($scope,$log){$log.log("LoginCtrl ready")}),angular.module("miller").controller("PageCtrl",function($scope,$log,page){$log.log("PageCtrl ready",page.status),$scope.md=page.data}),angular.module("miller").controller("StoryCtrl",function($rootScope,$scope,$log,story,StoryFactory,EVENTS){$scope.story=story,$scope.story.isWritable=$scope.hasWritingPermission($scope.user,$scope.story),$scope.layout="inline",$scope.setStatus=function(status){$log.debug("StoryCtrl -> setStatus - status:",status),$scope.user.is_staff&&($scope.$emit(EVENTS.MESSAGE,"saving"),StoryFactory.update({id:$scope.story.id},{title:$scope.story.title,status:status},function(res){$scope.story.status=res.status,$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock()}))},$scope.listener=function(event,data,callback){switch($log.log("StoryCtrl > listener, event:",event),event){case EVENTS.MARKDOWNIT_FULLSIZE:$rootScope.fullsize(data.slug,data.type);break;case EVENTS.MARKDOWNIT_RESOLVE:$rootScope.resolve(data.slug,data.type,callback)}},$log.log("StoryCtrl ready, title:",story.title,"isWritable:",$scope.story.isWritable),$scope.setDocuments=function(items){$log.log("StoryCtrl > setDocuments items n.:",items.length);var documents=[],unlinkeddocument=[];documents=_.compact([$scope.cover].concat(items.map(function(item){var _docs=story.documents.filter(function(doc){return doc.slug==item.slug});return _docs.length?angular.extend({citation:item.citation},_docs[0]):($log.error("StoryCtrl > cant't find any document matching the link:",item.slug),null)}))),$scope.$parent.setDocuments(documents.concat(unlinkeddocument))}}),angular.module("miller").controller("WritingCtrl",function($scope,$log,$q,$modal,$filter,story,localStorageService,StoryFactory,StoryTagsFactory,StoryDocumentsFactory,CaptionFactory,DocumentFactory,EVENTS,RUNTIME){$log.debug("WritingCtrl writing title:",story.title,"-id:",story.id,"- current language:",$scope.language),$scope.isDraft=!1,$scope.isSaving=!1,$scope.story=story,"object"!=typeof $scope.story.metadata&&($scope.story.metadata={title:{},"abstract":{}}),["title","abstract"].forEach(function(d){$scope.language&&!$scope.story.metadata[d][$scope.language]&&($scope.story.metadata[d][$scope.language]=story[d])}),$scope.id=story.id,$scope.title=$scope.story.metadata.title[$scope.language],$scope["abstract"]=$scope.story.metadata["abstract"][$scope.language],$scope.contents=story.contents,$scope.date=story.date,$scope.keywords=_.filter(story.tags,{category:"keyword"}),$scope.displayedTags=_.filter(story.tags,function(d){return"keyword"!=d.category}),$scope.metadata={status:story.status,owner:story.owner},$scope.setStatus=function(status){$scope.metadata.status=status,$scope.save()};var documentSlugs=_.map(story.documents,"slug");$scope.setDocuments=function(documents){var saveable=documents.filter(function(d){return"glossary"!=d.type&&-1==documentSlugs.indexOf(d.slug)}),deletable=documents.filter(function(d){return-1==documentSlugs.indexOf(d.slug)}),included=_.map(documents,"slug");if($log.log("WritingCtrl -> setDocuments()",documents.length,"- to be saved:",saveable,"- to be deleted:"),documents=story.documents.filter(function(d){return-1!=included.indexOf(d.slug)}),saveable.length||deletable.length)$q.all(_.compact(saveable.map(function(d){var p=CaptionFactory.save({story:story.id,document:d},function(res){$log.warn("WritingCtrl -> setDocuments() CaptionFactory.save success",res),documents.push(res)},function(err){$log.warn("WritingCtrl -> setDocuments() CaptionFactory.save failed",err)}).promise;return p}))).then(function(results){results.length?($scope.save(),$scope.$parent.setDocuments(documents)):$scope.$parent.setDocuments(documents)});else{var indexed=_.keyBy(story.documents,"slug"),docs=_(documents).uniq("slug").map(function(d){return indexed[d.slug]}).value();$scope.$parent.setDocuments(docs)}},$scope.references=[],$scope.lookups=[],$scope.attachTag=function(tag){return $log.debug("WritingCtrl -> attachTag() tag",arguments),$scope.isSaving=!0,$scope.lock(),StoryFactory.patch({id:story.id},{tags:_.compact(_.map($scope.displayedTags,"id").concat(_.map($scope.keywords,"id")))}).$promise.then(function(res){return $log.debug("WritingCtrl -> attachTag() tag success",res),$scope.unlock(),$scope.isSaving=!1,!0},function(){return!1})},$scope.detachTag=function(tag){return $log.debug("WritingCtrl -> detachTag() tag",arguments,$scope.displayedTags),$scope.isSaving=!0,$scope.lock(),StoryFactory.patch({id:story.id},{tags:_.map($scope.displayedTags,"id")}).$promise.then(function(res){return $log.debug("WritingCtrl -> detachTag() tag success",res),$scope.unlock(),$scope.isSaving=!1,!0},function(){return!1})},$scope.suggestReferences=function(service){service||DocumentFactory.get(function(){console.log("list")})},$scope.save=function(){$log.debug("WritingCtrl @SAVE"),$scope.$emit(EVENTS.MESSAGE,"saving"),$scope.isSaving=!0,$scope.lock(),StoryFactory.update({id:story.id},angular.extend({title:$scope.title,"abstract":$scope["abstract"],contents:$scope.contents,metadata:JSON.stringify($scope.story.metadata),date:$scope.date},$scope.metadata),function(res){$log.debug("WritingCtrl @SAVE: success"),$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock(),$scope.isSaving=!1,$scope.toggleStopStateChangeStart(!1)})},$scope.$on(EVENTS.SAVE,$scope.save),$scope.$watch("contents",function(v,p){v&&v!=p&&$scope.toggleStopStateChangeStart(!0)}),$scope.$watch("language",function(v,p){v&&v!=p&&(["title","abstract"].forEach(function(d){$scope[d]=$scope.story.metadata[d][v]||$scope[d]}),$log.log("WritingCtrl @language"))}),$scope.$watch("title",function(v){$scope.language&&($scope.story.metadata.title[$scope.language]=v)}),$scope.$watch("abstract",function(v){$scope.language&&($scope.story.metadata["abstract"][$scope.language]=v)})}),angular.module("miller").controller("EnrichModalCtrl",function($timeout,$scope,$log,QueryParamsService,DocumentFactory,StoryFactory,OembedSearchFactory,embedService){$log.info("EnrichModalCtrl ready with crazy scope"),$scope.tabs={favourite:{name:"favourite",items:[],count:0,next:void 0,isLoadingNextItems:!1,suggest:function(query,keep){var $s=this;$log.log("tab.favourite > suggest",$s),$s.isLoadingNextItems=!0,keep||($s.next=void 0),DocumentFactory.get($s.next||{filters:JSON.stringify(query.length>2?{contents__icontains:query}:{})},function(res){$log.log("tab.favourite > suggest loaded n.docs:",res.results.length,QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.log("init",this),this.suggest($scope.query||"")}},glossary:{name:"glossary",items:[],count:0,next:void 0,suggest:function(query,keep){var $s=this;$log.log("tab.glossary > suggest",$s),$s.isLoadingNextItems=!0,keep||($s.next=void 0),StoryFactory.get($s.next||{filters:JSON.stringify(query.length>2?{contents__icontains:query,tags__slug:"glossary"}:{tags__slug:"glossary"})},function(res){$log.log("tab.glossary > suggest loaded n.docs:",res.results.length,QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.log("init",this),this.suggest($scope.query||"")}},url:{name:"url",items:[],suggest:function(url,keep){},init:function(){$log.log("init",this),this.suggest($scope.url||"")}},CVCE:{name:"CVCE",items:[],count:0,next:void 0,suggest:function(query,keep){var $s=this;return $log.log("tab.CVCE > suggest",$s),$s.isLoadingNextItems=!0,OembedSearchFactory.CVCE?void OembedSearchFactory.CVCE({q:query}).then(function(res){$log.log("tab.CVCE > suggest loaded n.docs:",res.data.results),$s.items=res.data.results,$s.count=res.data.count,$s.isLoadingNextItems=!1}):void $log.error("OembedSearchFactory.CVCE does not exist")},init:function(){$log.log("init",this),this.suggest($scope.query||"")}}};var timer_preview;$scope.previewUrl=function(url){timer_preview&&$timeout.cancel(timer_preview);var regexp=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&&#37;@!\-\/]))?/;return regexp.test(url)?(url=url.replace("#",".hash."),void(timer_preview=$timeout(function(){$log.debug("::mde -> previewUrl() url:",url),$scope.suggestMessage="(loading...)",embedService.get(url).then(function(data){$log.debug(":: mde -> previewUrl() received:",data),$scope.embed=data,$scope.suggestMessage="(<b>done</b>)"})},20))):($log.error("::mde -> previewUrl() url provided:",url,"is not valid"),$scope.suggestMessage="(url is not valid)",!1)},$scope.setTab=function(tabname){$log.log("EnrichModalCtrl -> setTab() tab.name:",tabname),$scope.tab=$scope.tabs[tabname],$scope.tab.init()},$scope.suggest=function(query){$log.log("EnrichModalCtrl -> suggest() q:",query),$scope.tab.suggest(query)},$scope.more=function(query,tab){$log.log("EnrichModalCtrl -> more()"),$scope.tab.suggest(query,!0)},
$scope.setTab("favourite")}),angular.module("miller").directive("lazyImage",function($log){return{restrict:"A",scope:{src:"="},link:function(scope,element,attrs){function wakeup(){element.css({"background-size":attrs.size||"cover","background-position":"center center","background-repeat":"no-repeat","background-image":"url("+scope.src+")"}),element.find(".loading").hide()}$log.log(":::lazy on ",scope.src),element.addClass("lazy-box").css({"background-color":"#B7B2B2"}).html('<div class="loading">...</div>'),scope.$watch("src",function(v){v&&wakeup()})}}}).directive("lazyPlaceholder",function($log,$rootScope,$compile,RUNTIME){return{scope:{},templateUrl:RUNTIME["static"]+"templates/partials/placeholder.html",link:function(scope,element,attrs){var slug=element.attr("lazy-placeholder"),type=element.attr("type");scope.type=type,$log.log("⏣ lazy-placeholder on type:",type,"- slug:",slug),scope.complete=function(res){res?(scope.resolved=res,$log.log("⏣ lazy-placeholder resolved for type:",type,"- slug:",slug,res),$compile(element.contents())(scope)):$log.error("⏣ lazy-placeholder cannot find",slug)},$rootScope.resolve&&"string"==typeof slug&&$rootScope.resolve(slug,type,scope.complete),scope.fullsize=function(slug,type){$rootScope.fullsize(slug,type)}}}}),angular.module("miller").directive("footnote",function($compile){return{restrict:"A",scope:{caption:"=",footnote:"="},require:"^?markdownit",template:'<span class="footnote"><a ng-click="toggleFootnote()" style="cursor:pointer">{{caption}}</a><div class="footnote-contents" ng-show="isOpened"></div></span>',link:function(scope,element,attrs){var footnoteSl="#fn"+scope.caption+" p",contents=$(footnoteSl).clone(),wrapper=element.find(".footnote-contents");wrapper.html(contents),$compile(wrapper.contents())(scope),scope.isOpened=!1,scope.toggleFootnote=function(){console.log("::footnote > toggleFootnote"),scope.isOpened=!scope.isOpened},scope.fullsize=function(slug,type){scope.$parent.fullsize(slug,type)}}}}).directive("embedit",function($sce){return{restrict:"A",scope:{embedit:"=",stretch:"=",language:"="},link:function(scope,element,attrs){scope.language&&"object"==typeof scope.embedit?element.html(scope.embedit[scope.language]||""):element.html(scope.embedit),scope.stretch&&element.find("iframe").width("100%").height("100%"),scope.language&&"object"==typeof scope.embedit&&scope.$watch("language",function(language){"object"==typeof scope.embedit&&element.html(scope.embedit[scope.language]||"")})}}}).directive("markdownit",function($compile,$log,$location,markdownItService,EVENTS){return{restrict:"A",scope:{markdownit:"=",settoc:"&",setdocs:"&",language:"=",listener:"&"},link:function(scope,element,attrs){function parse(){if(!scope.markdownit||!scope.markdownit.length)return void $log.warn(":: markdownit parse() without any markdown text! Check the value for `markdownit`");var results=markdownItService(scope.markdownit,scope.language);element.html(results.html),$compile(element.contents())(scope),scope.settoc&&scope.settoc({ToC:results.ToC}),scope.setdocs&&scope.setdocs({items:results.docs})}scope.hash=function(what){$location.hash(what)},scope.fullsize=function(slug,type){scope.listener&&scope.listener({event:EVENTS.MARKDOWNIT_FULLSIZE,data:{slug:slug.replace(/^.*\//,""),type:type}})},scope.resolve=function(slug,type,notify){scope.listener&&scope.listener({event:EVENTS.MARKDOWNIT_RESOLVE,data:{slug:slug,type:type},callback:notify})},scope.language?scope.$watch("language",function(language){language&&parse()}):parse()}}}).directive("marked",function($compile,$log,$location,markedService){return{restrict:"A",scope:{marked:"=",settoc:"&",setdocs:"&",language:"="},link:function(scope,element,attrs){function init(){if(!scope.marked||!scope.marked.length)return void $log.warn(":: marked init(), no text to be marked");var rendered=markedService(scope.marked,scope.language);element.html(rendered.html),$compile(element.contents())(scope),scope.settoc&&scope.settoc({ToC:rendered.ToC}),scope.setdocs&&scope.setdocs({items:rendered.docs})}new marked.Renderer;scope.hash=function(what){$location.hash(what)},scope.miller=function(url){},scope.language?scope.$watch("language",function(language){language&&init()}):init()}}}),angular.module("miller").directive("mde",function($log,$timeout,$modal,$filter,DocumentFactory,StoryFactory,OembedSearchFactory,embedService,markedService,RUNTIME){return{restrict:"AE",scope:{mde:"=",settoc:"&",setdocs:"&"},templateUrl:RUNTIME["static"]+"templates/partials/mde.html",link:function(scope,el,attributes){function init(){function move(){timer&&clearTimeout(timer),timer=setTimeout(function(){simplemde.codemirror.display.cursorDiv.firstChild&&(cursor={top:simplemde.codemirror.display.cursorDiv.firstChild.offsetTop,left:simplemde.codemirror.display.cursorDiv.firstChild.offsetLeft,height:simplemde.codemirror.display.cursorDiv.firstChild.offsetHeight},wand.css("transform","translateY("+(cursor.top+cursor.height-20)+"px)"),followCursor&&toolbox.css("transform","translate("+cursor.left+"px,"+cursor.top+"px)"),pos=simplemde.codemirror.getCursor("start"),stat=simplemde.codemirror.getTokenAt(pos),scope.activeStates=(stat.type||"").split(" "),scope.$apply())},20)}function beforeSelectionChange(e,sel){var isSelection=sel.ranges[0].head.ch-sel.ranges[0].anchor.ch!==0;isSelection&&isSelection!=_isSelection?toolbox.addClass("active"):isSelection||isSelection==_isSelection||toolbox.removeClass("active"),_isSelection=isSelection}function recompile(){var marked=markedService(simplemde.value()),ToCHash=md5(JSON.stringify(marked.ToC)),docsHash=md5(_.map(marked.docs,"slug").join("--"));_ToCHash!=ToCHash&&($log.log("::mde -> recompile() items ToC:",marked.ToC.length,"docs:",marked.docs.length,ToCHash),scope.settoc({items:marked.ToC})),_docsHash!=docsHash&&($log.log("::mde -> recompile() items docs:",_docsHash),scope.setdocs({documents:marked.docs})),_ToCHash=ToCHash,_docsHash=docsHash}function onUpdate(e){var value=simplemde.value();textarea.val()!=value&&(scope.mde=value,textarea.val(value)),move(),timer_recompile&&clearTimeout(timer_recompile),timer_recompile=setTimeout(function(){recompile(),scope.$apply()},500)}function onChange(e,change){var from=change.from,text=change.text.join("\n"),to=(change.removed.join("\n"),simplemde.codemirror.posFromIndex(simplemde.codemirror.indexFromPos(from)+text.length));simplemde.codemirror.markText(from,to,{className:"mde-modified"})}function beforeChange(){}textarea.show(),wand.show(),toolbox.show(),simplemde=new SimpleMDE({element:textarea[0],spellChecker:!1,status:!1,toolbar:!1,toolbarTips:!1,initialValue:scope.mde});var cursor,pos,stat,followCursor,_isSelection,_ToCHash,_docsHash;simplemde.codemirror.on("update",onUpdate),simplemde.codemirror.on("cursorActivity",move),simplemde.codemirror.on("beforeSelectionChange",beforeSelectionChange),simplemde.codemirror.on("beforeChange",beforeChange),simplemde.codemirror.on("change",onChange),scope.settoc&&(timer_recompile=setTimeout(recompile,20))}scope.activeStates=[],scope.isPreviewEnabled=!1;var simplemde,timer,timer_recompile,timer_preview,wand=el.find(".wand").hide(),textarea=el.find("textarea").hide(),toolbox=el.find(".toolbox").hide(),referenceModal=$modal({scope:scope,title:"h",controller:"EnrichModalCtrl",template:RUNTIME["static"]+"templates/partials/modals/mde-enrich.html",show:!1});scope.setTab=function(tab){scope.tab=tab},scope.tab="CVCE",scope.previewUrl=function(url){timer_preview&&$timeout.cancel(timer_preview);var regexp=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&&#37;@!\-\/]))?/;return regexp.test(url)?(url=url.replace("#",".hash."),void(timer_preview=$timeout(function(){$log.debug("::mde -> previewUrl() url:",url),scope.suggestMessage="(loading...)",embedService.get(url).then(function(data){$log.debug(":: mde -> previewUrl() received:",data),scope.embed=data,scope.suggestMessage="(<b>done</b>)"})},20))):($log.error("::mde -> previewUrl() url provided:",url,"is not valid"),!1)};scope.suggestResults=[],scope.suggestMessage="",scope.suggest=function(query,service){if($log.log("::mde -> suggest()",scope.query,query,OembedSearchFactory),query.length<3)return scope.suggestMessage="(write something more)",void(scope.suggestResults=[]);if(scope.lookups=[],scope.count=0,scope.next=void 0,scope.suggestMessage="(loading...)","favourite"==service)return void DocumentFactory.get({filters:JSON.stringify(query.length>2?{contents__icontains:query}:{})},function(res){$log.log("::mde -> showReferenceModal documents loaded",res.results.length),scope.lookups=res.results,scope.suggestMessage="(<b>"+res.count+"</b> results)"});if("glossary"==service){var params={tags__slug:"glossary"};return query.length>2&&(params.contents__icontains=query),void StoryFactory.get({filters:JSON.stringify(params)},function(res){$log.log("::mde -> showReferenceModal documents loaded",res.results.length),scope.glossary=res.results,scope.suggestMessage="(<b>"+res.count+"</b> results)"})}OembedSearchFactory[service]&&OembedSearchFactory[service](query).then(function(res){scope.suggestResults=res.data.results,scope.suggestMessage="(<b>"+res.data.count+"</b> results)"})},scope.showReferenceModal=function(){return-1!==scope.activeStates.indexOf("link")?void $log.warn("oh dear, you should not click on it"):void referenceModal.$promise.then(function(){$log.log("::mde -> showReferenceModal called"),referenceModal.show()})},scope.addDocument=function(type,contents,reference,url,embed){var slug;return $log.debug("::mde -> addDocument() type:",type),"bibtex"==type?void $log.debug("    reference:",bibtexParse.toJSON(reference)):"glossary"==type?(referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:"voc/"+scope.selectedDocument.slug})):"url"==type?embed.title?(slug=$filter("slugify")(embed.title).substr(0,100),void DocumentFactory.save({title:embed.title,contents:JSON.stringify(embed),type:(embed.type||"link").toLowerCase(),slug:slug,url:url},function(res){$log.debug("::mde -> addDocument() document saved:",res.slug,res.id,res.short_url),res.slug&&(referenceModal.hide(),SimpleMDE.drawLink(simplemde,{url:"doc/"+res.slug}))},function(err){err.data.slug&&"slug"==_.keys(err.data).join("")?SimpleMDE.drawLink(simplemde,{url:"doc/"+slug}):$log.error("::mde -> addDocument() cannot save document",err)})):(referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:url})):scope.selectedDocument?"CVCE"==type?(slug="cvce/"+scope.selectedDocument.details.doi,$log.debug("::mde -> addDocument() doc:",slug),void DocumentFactory.save({title:scope.selectedDocument.title,contents:JSON.stringify(scope.selectedDocument),type:(scope.selectedDocument.type||"link").toLowerCase(),slug:slug,url:url},function(res){$log.debug("::mde -> addDocument() document saved:",res.slug,res.id,res.short_url),res.slug&&(referenceModal.hide(),SimpleMDE.drawLink(simplemde,{url:"doc/"+res.slug}))},function(err){err.data.slug&&($log.debug("::mde -> addDocument() document already saved:",slug),SimpleMDE.drawLink(simplemde,{url:"doc/"+slug}))})):("bibtex"==scope.selectedDocument.type&&SimpleMDE.drawLink(simplemde,{url:"doc/"+scope.selectedDocument.slug}),$log.debug("::mde -> addDocument() doc:",scope.selectedDocument),referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:"doc/"+scope.selectedDocument.slug})):void $log.warn("::mde -> addDocument() no document selected")},scope.selectDocument=function(doc){$log.log("::mde -> selectDocument()",doc.url),scope.selectedDocument&&scope.selectedDocument.url==doc.url?(scope.isSomethingSelected=!1,scope.selectedDocument=!1):scope.selectedDocument?(scope.isSomethingSelected=!0,scope.selectedDocument=doc):(scope.isSomethingSelected=!0,scope.selectedDocument=doc)},scope.action=function(action){"togglePreview"==action&&(scope.isPreviewEnabled=!scope.isPreviewEnabled),SimpleMDE[action](simplemde)},$timeout(init,500)}}});